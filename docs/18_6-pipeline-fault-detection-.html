<!DOCTYPE html>
<html>
<head>
   <title>Introduction &gt; Architecture Overview &gt; Chapter 18 – Fault Dispatcher &amp; Precise Exceptions &gt; 18.6 Pipeline Fault Detection and Delivery Flow</title>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />   
   <meta http-equiv="X-UA-Compatible" content="IE=edge" />
   <meta name="generator" content="Help &amp; Manual" />
   <meta name="keywords" content="" />
   <meta name="description" content="18.6.1 Detect-Early / Deliver-Late Model &nbsp;ASA-EmulatR implements the Alpha precise exception model through a detect-early/deliver-late pattern. Faults are detected in the..." />
   <link type="text/css" href="default.css" rel="stylesheet" />
   <link type="text/css" href="custom.css" rel="stylesheet" />

   <style TYPE="text/css" media="screen"> 
      html, body { margin:0; 
        padding:0; 
        background: #ffffff; 
      } 
      div#printheader { display: none; }
      #idheader { 
        width:100%; 
        min-height: 60px; 
        padding: 0; 
        margin: 0;
        position: fixed;
        top: 0;
        background: #2C5D88;
        z-index: 2;
      } 
      /* The "min-height" for "#idheader table" ensures that the (blue) header of the topic
         has at least the same height as the header of the navigation panel left of it */
      #idheader table { min-height: 59px;}             
      #idheader h1 span { color: #FFF }     
      #idnav {
        text-align: right;
        width: 126px;
        vertical-align: middle;        
      } 
      #idnav a { text-decoration: none }
      #idnav span {
        display: inline-block;
        width: 24px;
        height: 24px;
        margin-left: 4px;
        background:url('hm_webhelp_buttons_grey.png') top left no-repeat;
      } 
      #idnav a span {
        background-image:url('hm_webhelp_buttons_white.png');
      } 
      #idnav a span:hover {
        background-image:url('hm_webhelp_buttons_orange.png');
      } 
      #idnav span.hmbtnprev { background-position: 0 -32px }
      #idnav span.hmbtnnext { background-position: -24px -32px }
      #idnav span.hmbtntop  { background-position: -48px -32px }
      #idnav span.hmbtntoggle  { width: 20px; background-position: -70px -32px }
      #idnav span.hmbtnprint  { background-position: -88px -32px }

      #callout-table, #overview-table {display:block; position:relative; top:0; left:0;}
      #callout-icon {display:block; position:absolute; top:-11px; left:-11px;}
      #callout-icon-flag {display:block; position:absolute; top:-11px; left:-8px;}
      #callout-table a {text-decoration: none; color: blue;}
      #callout-table a:visited {text-decoration: none; color: blue;}
      #overview-table a {text-decoration: none; color: black;}
      #overview-table a:visited {text-decoration: none; color: black;}
      #callout-table a:hover, #overview-table a:hover {text-decoration: underline;}       
      p.help-url { margin: 20px 0 5px 0; text-align: center; }
	  p.help-url a:link { font-size: 50%; text-decoration: none; color: black; }
	  p.help-url a:visited { color: black; }
	  p.help-url a:hover { font-size: 95%; text-decoration: underline; }
      #switchtoggles { text-align: right; padding: 0 2px 0 0; font-size: 90%; } 
      .sync-toc { color: #FFF; font-size: 8pt; font-weight: bold; display: none; }
      .sync-toc a { color: #FFF; text-decoration: none; font-weight: bold;}
      .sync-toc a:visited { color: #FFF; }
      .sync-toc a:hover { text-decoration: underline; }
	  a#printbuttonlink { cursor: pointer; }
      a.hmanchor { display: inline-block; margin-top: -4em; padding-top: 4em; }  
   </style>
   <style TYPE="text/css" media="print">
      div#idheader, img.dropdown-toggle-icon, p.help-url { display:none } 
   </style>
   
   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>

   <script type="text/javascript">
     HMSyncTOC("index.html", "18_6-pipeline-fault-detection-.html");
   </script>
   <script type="text/javascript" src="highlight.js"></script>
   <script type="text/javascript">
     $(document).ready(function(){highlight();});
   </script>
</head>
<body>


<div id="printheader"><h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">18.6 Pipeline Fault Detection and Delivery Flow</span></h1>
</div>
<div id="idheader">
<div id="idheaderbg">
<table style="width:100%;border:none;margin:0px;" cellspacing="0" cellpadding="0"> 
  <tr>
    <td class="topichead" style="text-align:left; vertical-align:middle">
      <p class="sync-toc">&lt;&lt; <a rel="nofollow" href="index.html?18_6-pipeline-fault-detection-.html" target="_top">Click to Display Table of Contents</a> &gt;&gt;</p>
      <p class="crumbs"><b>Navigation:</b>&nbsp;
      
      <a href="introduction.html">Introduction</a> &gt; <a href="architecture-overview.html">Architecture Overview</a> &gt; <a href="chapter-18---fault-dispatcher-.html">Chapter 18 – Fault Dispatcher &amp; Precise Exceptions</a>&nbsp;&gt;</p>
   
      <h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">18.6 Pipeline Fault Detection and Delivery Flow</span></h1>

    </td>
    <td class="topichead" id="idnav">
      
      <a href="18_5-exception-to-pal-vector-m.html" title="Previous Topic"><span class="hmbtnprev"></span></a>
      <a href="chapter-18---fault-dispatcher-.html" title="Parent Chapter"><span class="hmbtntop"></span></a>
      <a href="18_7-pal-mode-entry.html" title="Next Topic"><span class="hmbtnnext"></span></a>
      
    </td>
  </tr>  
</table>
</div>
</div>  

<div id="idcontent"><div id="innerdiv">
<!-- Ask Internet Explorer 6.users to update their obsolete and dangerous browser --> 
<!--[if lt IE 7]><div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;'><a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." /></a></div><![endif]-->

<!--ZOOMRESTART-->
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">18.6.1 Detect-Early / Deliver-Late Model</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">ASA-EmulatR implements the Alpha precise exception model through a detect-early/deliver-late pattern. Faults are detected in the Execute (EX) stage but not delivered until the faulting instruction reaches the Writeback (WB) stage. This ensures that all prior instructions have committed and no younger instruction has modified architectural state.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_CodeExample"><span class="f_CodeExample">Detection&nbsp;(EX&nbsp;stage):</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;grain-&gt;execute(slot)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;├──&nbsp;MBox&nbsp;detects:&nbsp;DTB&nbsp;miss,&nbsp;alignment,&nbsp;ACV,&nbsp;FOE/FOW/FOR</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;├──&nbsp;EBox&nbsp;detects:&nbsp;integer&nbsp;overflow,&nbsp;divide&nbsp;by&nbsp;zero</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;├──&nbsp;FBox&nbsp;detects:&nbsp;FP&nbsp;overflow/underflow/inexact/invalid/DBZ</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;└──&nbsp;Pipeline:&nbsp;illegal&nbsp;instruction,&nbsp;privilege&nbsp;violation</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;▼</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;slot.faultPending&nbsp;=&nbsp;true</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;slot.trapCode&nbsp;=&nbsp;ExceptionClass_EV6::...</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;slot.faultVA&nbsp;=&nbsp;faulting_address</span></p>
<p class="p_Normal">&nbsp;</p>
<p class="p_CodeExample"><span class="f_CodeExample">Transit&nbsp;(MEM&nbsp;stage):</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;Faulting&nbsp;instruction&nbsp;flows&nbsp;through&nbsp;MEM</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;Pending&nbsp;commit&nbsp;preserved&nbsp;but&nbsp;may&nbsp;be&nbsp;discarded</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;No&nbsp;side&nbsp;effects&nbsp;committed&nbsp;for&nbsp;faulting&nbsp;instruction</span></p>
<p class="p_Normal">&nbsp;</p>
<p class="p_CodeExample"><span class="f_CodeExample">Delivery&nbsp;(WB&nbsp;stage):</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;stage_WB()&nbsp;checks&nbsp;slot.faultPending&nbsp;BEFORE&nbsp;any&nbsp;commit</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;├──&nbsp;Discard&nbsp;pending&nbsp;commit&nbsp;(PendingCommit{})</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;├──&nbsp;Set&nbsp;PipelineAction::FAULT&nbsp;with&nbsp;trapCode/faultVA/faultPC</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;├──&nbsp;Invalidate&nbsp;slot</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;├──&nbsp;flushYoungerSlots()&nbsp;—&nbsp;clear&nbsp;all&nbsp;younger&nbsp;instructions</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;└──&nbsp;BoxResult::faultDispatched()&nbsp;→&nbsp;enterPalMode()</span></p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">The key guarantee: the fault check in WB fires <span style="font-weight: bold;">before</span> any store commit or register writeback for the faulting instruction. Older instructions have already committed in prior WB cycles. Younger instructions are flushed and never commit.</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">18.6.2 Interrupt Delivery Flow</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">Interrupts follow a different path than synchronous faults. They are sampled during the pre-cycle phase of the CPU run loop, before pipeline advancement:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_CodeExample"><span class="f_CodeExample">AlphaCPU::runOneInstruction()</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;├──&nbsp;1.&nbsp;Check&nbsp;FaultDispatcher::eventPending()</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;│&nbsp;(delivers&nbsp;queued&nbsp;faults/traps&nbsp;from&nbsp;prior&nbsp;cycle)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;├──&nbsp;2.&nbsp;Poll&nbsp;IRQPendingState&nbsp;(if&nbsp;!inPalMode)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;│&nbsp;hasDeliverable(currentIPL)&nbsp;→&nbsp;true?</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;│&nbsp;claimNext()&nbsp;→&nbsp;ClaimedInterrupt{source,&nbsp;IPL,&nbsp;vector}</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;│&nbsp;break&nbsp;reservation</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;│&nbsp;PalService::deliverInterrupt(claimed)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;│&nbsp;flush&nbsp;pipeline</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;│&nbsp;return&nbsp;(skip&nbsp;instruction&nbsp;execution&nbsp;this&nbsp;cycle)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;├──&nbsp;3.&nbsp;Poll&nbsp;for&nbsp;IPIs&nbsp;(if&nbsp;!inPalMode)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;│&nbsp;TLB&nbsp;shootdown,&nbsp;barrier&nbsp;synchronization</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;└──&nbsp;4.&nbsp;Execute&nbsp;pipeline&nbsp;stages&nbsp;(IF&nbsp;→&nbsp;DE&nbsp;→&nbsp;IS&nbsp;→&nbsp;EX&nbsp;→&nbsp;MEM&nbsp;→&nbsp;WB)</span></p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">Interrupts are never taken mid-instruction. The interrupt check occurs at instruction boundaries, after the previous instruction has fully retired. PAL mode blocks non-critical interrupt delivery — only machine checks override PAL mode.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_SeeAlso" style="page-break-after: avoid;"><span class="f_SeeAlso">See Also: <a href="13_10-exception-precision.html" class="topiclink">13.10 Exception Precision</a>; <a href="chapter-7_7-exception-delivery.html" class="topiclink">7.8 Precise Exception Model; </a> cpuCoreLib/AlphaCPU.h – runOneInstruction(), checkInterrupts().</span></p>

<!--ZOOMSTOP-->
</div></div>
<script type="text/javascript">




function normHeaders() {
 var topicHeadHeight =  $("#idheaderbg > table").first().height() + 1,
	 $topicHeaderBox = $("#idheader"),
	 $topicContentBox = $("#idcontent"),
	 $navHeader = $("#navbar", parent.document),			 
	$navBox = $("div#hmnavframe", parent.document),
	 navHeaderHeight = $navHeader.height();
 if (topicHeadHeight != navHeaderHeight) {
	 $navHeader.css("height",topicHeadHeight + "px");
	 $navBox.css("top", topicHeadHeight + "px");
	 $topicHeaderBox.css("height", topicHeadHeight + "px");
		if ($topicHeaderBox.css("position") == "fixed"){
			$topicContentBox.css("margin-top", topicHeadHeight + "px");
			}
		}
    }
			 
  $(document).ready(function(){
    $(window).on('resize', function() {
      var y = $('#idheader').height(); 
      $('#idcontent').css('margin-top', y);
      var par = window.parent;
      if ($( par ).width() <= $( window ).width()+20) {
        $('#idheader').css('position', 'relative');
        $('#idcontent').css('margin-top', 0);
        $('#idbacktotop').css('display', 'block');
        $('.hmanchor').css('margin-top', -20);
	$('.hmanchor').css('padding-top', 20);
      }
      else {
        $('#idheader').css('position', 'fixed');
        $('#idcontent').css('margin-top', $('#idheader').height());
        $('#idbacktotop').css('display', 'none');
        $('.hmanchor').css('margin-top', -y-20);
		$('.hmanchor').css('padding-top', y+20);
		$("div#hmsplitter", parent.document).css('width', '3px');
      }
	normHeaders();
    });
    
	 $(window).resize(); //trigger event for initially small displays
  });
 

if ((!parent.hmNavigationFrame) && (parent.location) && (parent.location.href)) { $('.sync-toc').show();$('p.crumbs').hide();}

</script>
</body>
</html>
