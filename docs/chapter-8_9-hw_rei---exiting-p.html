<!DOCTYPE html>
<html>
<head>
   <title>Introduction &gt; Architecture Overview &gt; Chapter 8 - PAL and Privileged Boundary &gt; 8.9 HW_REI - Exiting PAL Mode</title>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />   
   <meta http-equiv="X-UA-Compatible" content="IE=edge" />
   <meta name="generator" content="Help &amp; Manual" />
   <meta name="keywords" content="" />
   <meta name="description" content="8.9.1 Purpose &nbsp;HW_REI (Hardware Return from Exception/Interrupt) is the only architecturally legal exit from PAL mode. It restores processor execution from a privileged PAL..." />
   <link type="text/css" href="default.css" rel="stylesheet" />
   <link type="text/css" href="custom.css" rel="stylesheet" />

   <style TYPE="text/css" media="screen"> 
      html, body { margin:0; 
        padding:0; 
        background: #ffffff; 
      } 
      div#printheader { display: none; }
      #idheader { 
        width:100%; 
        min-height: 60px; 
        padding: 0; 
        margin: 0;
        position: fixed;
        top: 0;
        background: #2C5D88;
        z-index: 2;
      } 
      /* The "min-height" for "#idheader table" ensures that the (blue) header of the topic
         has at least the same height as the header of the navigation panel left of it */
      #idheader table { min-height: 59px;}             
      #idheader h1 span { color: #FFF }     
      #idnav {
        text-align: right;
        width: 126px;
        vertical-align: middle;        
      } 
      #idnav a { text-decoration: none }
      #idnav span {
        display: inline-block;
        width: 24px;
        height: 24px;
        margin-left: 4px;
        background:url('hm_webhelp_buttons_grey.png') top left no-repeat;
      } 
      #idnav a span {
        background-image:url('hm_webhelp_buttons_white.png');
      } 
      #idnav a span:hover {
        background-image:url('hm_webhelp_buttons_orange.png');
      } 
      #idnav span.hmbtnprev { background-position: 0 -32px }
      #idnav span.hmbtnnext { background-position: -24px -32px }
      #idnav span.hmbtntop  { background-position: -48px -32px }
      #idnav span.hmbtntoggle  { width: 20px; background-position: -70px -32px }
      #idnav span.hmbtnprint  { background-position: -88px -32px }

      #callout-table, #overview-table {display:block; position:relative; top:0; left:0;}
      #callout-icon {display:block; position:absolute; top:-11px; left:-11px;}
      #callout-icon-flag {display:block; position:absolute; top:-11px; left:-8px;}
      #callout-table a {text-decoration: none; color: blue;}
      #callout-table a:visited {text-decoration: none; color: blue;}
      #overview-table a {text-decoration: none; color: black;}
      #overview-table a:visited {text-decoration: none; color: black;}
      #callout-table a:hover, #overview-table a:hover {text-decoration: underline;}       
      p.help-url { margin: 20px 0 5px 0; text-align: center; }
	  p.help-url a:link { font-size: 50%; text-decoration: none; color: black; }
	  p.help-url a:visited { color: black; }
	  p.help-url a:hover { font-size: 95%; text-decoration: underline; }
      #switchtoggles { text-align: right; padding: 0 2px 0 0; font-size: 90%; } 
      .sync-toc { color: #FFF; font-size: 8pt; font-weight: bold; display: none; }
      .sync-toc a { color: #FFF; text-decoration: none; font-weight: bold;}
      .sync-toc a:visited { color: #FFF; }
      .sync-toc a:hover { text-decoration: underline; }
	  a#printbuttonlink { cursor: pointer; }
      a.hmanchor { display: inline-block; margin-top: -4em; padding-top: 4em; }  
   </style>
   <style TYPE="text/css" media="print">
      div#idheader, img.dropdown-toggle-icon, p.help-url { display:none } 
   </style>
   
   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>

   <script type="text/javascript">
     HMSyncTOC("index.html", "chapter-8_9-hw_rei---exiting-p.html");
   </script>
   <script type="text/javascript" src="highlight.js"></script>
   <script type="text/javascript">
     $(document).ready(function(){highlight();});
   </script>
</head>
<body>


<div id="printheader"><h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">8.9 HW_REI - Exiting PAL Mode</span></h1>
</div>
<div id="idheader">
<div id="idheaderbg">
<table style="width:100%;border:none;margin:0px;" cellspacing="0" cellpadding="0"> 
  <tr>
    <td class="topichead" style="text-align:left; vertical-align:middle">
      <p class="sync-toc">&lt;&lt; <a rel="nofollow" href="index.html?chapter-8_9-hw_rei---exiting-p.html" target="_top">Click to Display Table of Contents</a> &gt;&gt;</p>
      <p class="crumbs"><b>Navigation:</b>&nbsp;
      
      <a href="introduction.html">Introduction</a> &gt; <a href="architecture-overview.html">Architecture Overview</a> &gt; <a href="chapter-8---pal-and-privleged-.html">Chapter 8 - PAL and Privileged Boundary</a>&nbsp;&gt;</p>
   
      <h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">8.9 HW_REI - Exiting PAL Mode</span></h1>

    </td>
    <td class="topichead" id="idnav">
      
      <a href="chapter-8_8-pal-and-memory-ord.html" title="Previous Topic"><span class="hmbtnprev"></span></a>
      <a href="chapter-8---pal-and-privleged-.html" title="Parent Chapter"><span class="hmbtntop"></span></a>
      <a href="chapter-8_10-enforcing-the-pri.html" title="Next Topic"><span class="hmbtnnext"></span></a>
      
    </td>
  </tr>  
</table>
</div>
</div>  

<div id="idcontent"><div id="innerdiv">
<!-- Ask Internet Explorer 6.users to update their obsolete and dangerous browser --> 
<!--[if lt IE 7]><div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;'><a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." /></a></div><![endif]-->

<!--ZOOMRESTART-->
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">8.9.1 Purpose</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">HW_REI (Hardware Return from Exception/Interrupt) is the only architecturally legal exit from PAL mode. It restores processor execution from a privileged PAL context back to the interrupted or faulted execution context while preserving precise architectural state. No other instruction may exit PAL mode, restore privilege level, or resume interrupted execution. Any attempt to bypass HW_REI is architecturally illegal and must fault.</p>
<p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">8.9.2 Implementation</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">AlphaCPU::executeREI() performs a complete architectural state restore:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_CodeExample"><span class="f_CodeExample">BoxResult&nbsp;executeREI(PipelineSlot&amp;&nbsp;slot)&nbsp;{</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;1.&nbsp;Restore&nbsp;COMPLETE&nbsp;context&nbsp;(HWPCB&nbsp;+&nbsp;registers)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;m_iprGlobalMaster-&gt;restoreContext();</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;2.&nbsp;Get&nbsp;return&nbsp;PC&nbsp;(now&nbsp;restored)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;quint64&nbsp;returnPC&nbsp;=&nbsp;m_iprGlobalMaster-&gt;h-&gt;pc;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;3.&nbsp;Setup&nbsp;pipeline&nbsp;redirect</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;slot.reiTarget&nbsp;=&nbsp;returnPC;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;slot.pcModified&nbsp;=&nbsp;true;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;4.&nbsp;Flush&nbsp;pipeline</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;return&nbsp;BoxResult().flushPipeline();</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">}</span></p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">restoreContext() performs a full vector copy from the saved register-context snapshot back into the active processor state. This includes integer registers, floating-point registers (if enabled), PS, IPL, PC, and relevant internal execution state.</p>
<p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">8.9.3 Restored State</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">On HW_REI execution, the following state is restored atomically:</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>Program Counter (PC) — instruction address at which execution resumes</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>Processor Mode (CM) — returns to prior mode (User, Supervisor, Executive, or Kernel)</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>Processor Status (PS) — condition codes, interrupt enable state, architectural flags</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>Interrupt Priority Level (IPL) — restores prior IPL for correct interrupt arbitration</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>Interrupt state — re-enables or maintains interrupt masking as defined by the restored PS</p>
<p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">8.9.4 Serialization Guarantees</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">HW_REI is an implicit serialization point. Before execution resumes: PAL execution completes, write buffers are drained if required, LL/SC reservations are cleared, pipeline is flushed, and instruction fetch restarts at the restored PC. No speculative instruction may execute across an HW_REI boundary.</p>
<p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">8.9.5 Design Rationale</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">ASA-EmulatR's choice to restore the full register context (rather than selectively restoring fields) provides stronger correctness guarantees, easier verification and debugging, and clear separation between PAL and non-PAL execution. No residual PAL state leaks into non-PAL execution. This is a deliberate design choice that supports nested exceptions, SMP preemption, and debugger integration.</p>
<p class="p_Normal">&nbsp;</p>

<!--ZOOMSTOP-->
</div></div>
<script type="text/javascript">




function normHeaders() {
 var topicHeadHeight =  $("#idheaderbg > table").first().height() + 1,
	 $topicHeaderBox = $("#idheader"),
	 $topicContentBox = $("#idcontent"),
	 $navHeader = $("#navbar", parent.document),			 
	$navBox = $("div#hmnavframe", parent.document),
	 navHeaderHeight = $navHeader.height();
 if (topicHeadHeight != navHeaderHeight) {
	 $navHeader.css("height",topicHeadHeight + "px");
	 $navBox.css("top", topicHeadHeight + "px");
	 $topicHeaderBox.css("height", topicHeadHeight + "px");
		if ($topicHeaderBox.css("position") == "fixed"){
			$topicContentBox.css("margin-top", topicHeadHeight + "px");
			}
		}
    }
			 
  $(document).ready(function(){
    $(window).on('resize', function() {
      var y = $('#idheader').height(); 
      $('#idcontent').css('margin-top', y);
      var par = window.parent;
      if ($( par ).width() <= $( window ).width()+20) {
        $('#idheader').css('position', 'relative');
        $('#idcontent').css('margin-top', 0);
        $('#idbacktotop').css('display', 'block');
        $('.hmanchor').css('margin-top', -20);
	$('.hmanchor').css('padding-top', 20);
      }
      else {
        $('#idheader').css('position', 'fixed');
        $('#idcontent').css('margin-top', $('#idheader').height());
        $('#idbacktotop').css('display', 'none');
        $('.hmanchor').css('margin-top', -y-20);
		$('.hmanchor').css('padding-top', y+20);
		$("div#hmsplitter", parent.document).css('width', '3px');
      }
	normHeaders();
    });
    
	 $(window).resize(); //trigger event for initially small displays
  });
 

if ((!parent.hmNavigationFrame) && (parent.location) && (parent.location.href)) { $('.sync-toc').show();$('p.crumbs').hide();}

</script>
</body>
</html>
