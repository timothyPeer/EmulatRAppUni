<!DOCTYPE html>
<html>
<head>
   <title>Introduction &gt; Architecture Overview &gt; Chapter 7 - Exceptions, Faults, and Interrupts &gt; 7.9 Exception Delivery and PAL Mode Entry</title>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />   
   <meta http-equiv="X-UA-Compatible" content="IE=edge" />
   <meta name="generator" content="Help &amp; Manual" />
   <meta name="keywords" content="" />
   <meta name="description" content="7.9.1 Delivery Conditions &nbsp;An exception may be delivered when: no higher-priority event is pending, no barrier is blocking delivery, the pipeline is in a safe state, and the..." />
   <link type="text/css" href="default.css" rel="stylesheet" />
   <link type="text/css" href="custom.css" rel="stylesheet" />

   <style TYPE="text/css" media="screen"> 
      html, body { margin:0; 
        padding:0; 
        background: #ffffff; 
      } 
      div#printheader { display: none; }
      #idheader { 
        width:100%; 
        min-height: 60px; 
        padding: 0; 
        margin: 0;
        position: fixed;
        top: 0;
        background: #2C5D88;
        z-index: 2;
      } 
      /* The "min-height" for "#idheader table" ensures that the (blue) header of the topic
         has at least the same height as the header of the navigation panel left of it */
      #idheader table { min-height: 59px;}             
      #idheader h1 span { color: #FFF }     
      #idnav {
        text-align: right;
        width: 126px;
        vertical-align: middle;        
      } 
      #idnav a { text-decoration: none }
      #idnav span {
        display: inline-block;
        width: 24px;
        height: 24px;
        margin-left: 4px;
        background:url('hm_webhelp_buttons_grey.png') top left no-repeat;
      } 
      #idnav a span {
        background-image:url('hm_webhelp_buttons_white.png');
      } 
      #idnav a span:hover {
        background-image:url('hm_webhelp_buttons_orange.png');
      } 
      #idnav span.hmbtnprev { background-position: 0 -32px }
      #idnav span.hmbtnnext { background-position: -24px -32px }
      #idnav span.hmbtntop  { background-position: -48px -32px }
      #idnav span.hmbtntoggle  { width: 20px; background-position: -70px -32px }
      #idnav span.hmbtnprint  { background-position: -88px -32px }

      #callout-table, #overview-table {display:block; position:relative; top:0; left:0;}
      #callout-icon {display:block; position:absolute; top:-11px; left:-11px;}
      #callout-icon-flag {display:block; position:absolute; top:-11px; left:-8px;}
      #callout-table a {text-decoration: none; color: blue;}
      #callout-table a:visited {text-decoration: none; color: blue;}
      #overview-table a {text-decoration: none; color: black;}
      #overview-table a:visited {text-decoration: none; color: black;}
      #callout-table a:hover, #overview-table a:hover {text-decoration: underline;}       
      p.help-url { margin: 20px 0 5px 0; text-align: center; }
	  p.help-url a:link { font-size: 50%; text-decoration: none; color: black; }
	  p.help-url a:visited { color: black; }
	  p.help-url a:hover { font-size: 95%; text-decoration: underline; }
      #switchtoggles { text-align: right; padding: 0 2px 0 0; font-size: 90%; } 
      .sync-toc { color: #FFF; font-size: 8pt; font-weight: bold; display: none; }
      .sync-toc a { color: #FFF; text-decoration: none; font-weight: bold;}
      .sync-toc a:visited { color: #FFF; }
      .sync-toc a:hover { text-decoration: underline; }
	  a#printbuttonlink { cursor: pointer; }
      a.hmanchor { display: inline-block; margin-top: -4em; padding-top: 4em; }  
   </style>
   <style TYPE="text/css" media="print">
      div#idheader, img.dropdown-toggle-icon, p.help-url { display:none } 
   </style>
   
   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>

   <script type="text/javascript">
     HMSyncTOC("index.html", "chapter-7_8-pal-mode-entry.html");
   </script>
   <script type="text/javascript" src="highlight.js"></script>
   <script type="text/javascript">
     $(document).ready(function(){highlight();});
   </script>
</head>
<body>


<div id="printheader"><h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">7.9 Exception Delivery and PAL Mode Entry</span></h1>
</div>
<div id="idheader">
<div id="idheaderbg">
<table style="width:100%;border:none;margin:0px;" cellspacing="0" cellpadding="0"> 
  <tr>
    <td class="topichead" style="text-align:left; vertical-align:middle">
      <p class="sync-toc">&lt;&lt; <a rel="nofollow" href="index.html?chapter-7_8-pal-mode-entry.html" target="_top">Click to Display Table of Contents</a> &gt;&gt;</p>
      <p class="crumbs"><b>Navigation:</b>&nbsp;
      
      <a href="introduction.html">Introduction</a> &gt; <a href="architecture-overview.html">Architecture Overview</a> &gt; <a href="chapter-7---interrupt-and-ipi-.html">Chapter 7 - Exceptions, Faults, and Interrupts</a>&nbsp;&gt;</p>
   
      <h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">7.9 Exception Delivery and PAL Mode Entry</span></h1>

    </td>
    <td class="topichead" id="idnav">
      
      <a href="chapter-7_7-exception-delivery.html" title="Previous Topic"><span class="hmbtnprev"></span></a>
      <a href="chapter-7---interrupt-and-ipi-.html" title="Parent Chapter"><span class="hmbtntop"></span></a>
      <a href="chapter-7_9-interrupt-handling.html" title="Next Topic"><span class="hmbtnnext"></span></a>
      
    </td>
  </tr>  
</table>
</div>
</div>  

<div id="idcontent"><div id="innerdiv">
<!-- Ask Internet Explorer 6.users to update their obsolete and dangerous browser --> 
<!--[if lt IE 7]><div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;'><a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." /></a></div><![endif]-->

<!--ZOOMRESTART-->
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">7.9.1 Delivery Conditions</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">An exception may be delivered when: no higher-priority event is pending, no barrier is blocking delivery, the pipeline is in a safe state, and the faulting instruction has reached WB stage.</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">7.9.2 Architectural State Updates</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">On delivery, the pipeline calls AlphaCPU::enterPalMode() which performs the following state updates:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_CodeExample"><span class="f_CodeExample">void&nbsp;enterPalMode(PalEntryReason&nbsp;reason,&nbsp;quint64&nbsp;vector,&nbsp;quint64&nbsp;faultPC)&nbsp;{</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;1.&nbsp;Save&nbsp;complete&nbsp;context</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;m_iprGlobalMaster-&gt;saveContext();</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;2.&nbsp;Compute&nbsp;entry&nbsp;PC</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;quint64&nbsp;entryPC;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;if&nbsp;(reason&nbsp;==&nbsp;PalEntryReason::CALL_PAL_INSTRUCTION)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;entryPC&nbsp;=&nbsp;m_iprGlobalMaster-&gt;computeCallPalEntry(vector);</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;else</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;entryPC&nbsp;=&nbsp;vector;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;3.&nbsp;Set&nbsp;EXC_ADDR&nbsp;to&nbsp;faulting&nbsp;PC</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;m_iprGlobalMaster-&gt;h-&gt;exc_addr&nbsp;=&nbsp;faultPC;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;4.&nbsp;Enter&nbsp;PAL&nbsp;mode:&nbsp;PC&nbsp;=&nbsp;vector&nbsp;|&nbsp;0x1,&nbsp;IPL&nbsp;=&nbsp;7,&nbsp;CM&nbsp;=&nbsp;KERNEL</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;m_iprGlobalMaster-&gt;h-&gt;pc&nbsp;=&nbsp;entryPC&nbsp;|&nbsp;0x1;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;m_iprGlobalMaster-&gt;h-&gt;setIPL_Unsynced(7);</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;m_iprGlobalMaster-&gt;h-&gt;setCM(CM_KERNEL);</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;5.&nbsp;Activate&nbsp;shadow&nbsp;registers&nbsp;for&nbsp;CALL_PAL</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;if&nbsp;(reason&nbsp;==&nbsp;CALL_PAL_INSTRUCTION)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;m_iprGlobalMaster-&gt;setShadowEnabled(true);</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;6.&nbsp;Flush&nbsp;pipeline</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;m_alphaPipeline-&gt;flush(&quot;enterPalMode&quot;);</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">}</span></p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">Key state changes: EXC_ADDR receives the faulting PC, EXC_SUM is updated for arithmetic exceptions, PS is updated (mode set to kernel, IPL raised to 7, interrupts masked), and the pipeline is flushed. The low bit of the entry PC (| 0x1) indicates PAL mode to the execution engine.</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">7.9.3 PAL Entry Reasons</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">The PalEntryReason determines how the PAL vector is computed and what state is saved:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">CALL_PAL_INSTRUCTION — explicit PAL call, vector computed from PAL_BASE + dispatch offset, shadow registers activated</p>
<p class="p_Normal">TRAP — synchronous trap (arithmetic, software), vector from exception dispatch table</p>
<p class="p_Normal">INTERRUPT — asynchronous interrupt, vector from interrupt dispatch table</p>
<p class="p_Normal">FAULT — synchronous fault (translation, alignment, access violation), vector from exception dispatch table</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_SeeAlso" style="page-break-after: avoid;"><span class="f_SeeAlso">See Also: cpuCoreLib/AlphaCPU.h (enterPalMode); <a href="chapter-8---pal-and-privleged-.html" class="topiclink">Chapter 8 - PAL and Privileged Boundary</a>.</span></p>

<!--ZOOMSTOP-->
</div></div>
<script type="text/javascript">




function normHeaders() {
 var topicHeadHeight =  $("#idheaderbg > table").first().height() + 1,
	 $topicHeaderBox = $("#idheader"),
	 $topicContentBox = $("#idcontent"),
	 $navHeader = $("#navbar", parent.document),			 
	$navBox = $("div#hmnavframe", parent.document),
	 navHeaderHeight = $navHeader.height();
 if (topicHeadHeight != navHeaderHeight) {
	 $navHeader.css("height",topicHeadHeight + "px");
	 $navBox.css("top", topicHeadHeight + "px");
	 $topicHeaderBox.css("height", topicHeadHeight + "px");
		if ($topicHeaderBox.css("position") == "fixed"){
			$topicContentBox.css("margin-top", topicHeadHeight + "px");
			}
		}
    }
			 
  $(document).ready(function(){
    $(window).on('resize', function() {
      var y = $('#idheader').height(); 
      $('#idcontent').css('margin-top', y);
      var par = window.parent;
      if ($( par ).width() <= $( window ).width()+20) {
        $('#idheader').css('position', 'relative');
        $('#idcontent').css('margin-top', 0);
        $('#idbacktotop').css('display', 'block');
        $('.hmanchor').css('margin-top', -20);
	$('.hmanchor').css('padding-top', 20);
      }
      else {
        $('#idheader').css('position', 'fixed');
        $('#idcontent').css('margin-top', $('#idheader').height());
        $('#idbacktotop').css('display', 'none');
        $('.hmanchor').css('margin-top', -y-20);
		$('.hmanchor').css('padding-top', y+20);
		$("div#hmsplitter", parent.document).css('width', '3px');
      }
	normHeaders();
    });
    
	 $(window).resize(); //trigger event for initially small displays
  });
 

if ((!parent.hmNavigationFrame) && (parent.location) && (parent.location.href)) { $('.sync-toc').show();$('p.crumbs').hide();}

</script>
</body>
</html>
