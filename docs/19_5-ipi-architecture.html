<!DOCTYPE html>
<html>
<head>
   <title>Introduction &gt; Architecture Overview &gt; Chapter 19 – Interrupt Architecture &amp; IPI &gt; 19.5 IPI Architecture</title>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />   
   <meta http-equiv="X-UA-Compatible" content="IE=edge" />
   <meta name="generator" content="Help &amp; Manual" />
   <meta name="keywords" content="" />
   <meta name="description" content="19.5.1 Design Decision: Unified Interrupt Path &nbsp;EMulatR intentionally does not create a second interrupt system for IPIs. Instead, IPIs are injected into the same interrupt..." />
   <link type="text/css" href="default.css" rel="stylesheet" />
   <link type="text/css" href="custom.css" rel="stylesheet" />

   <style TYPE="text/css" media="screen"> 
      html, body { margin:0; 
        padding:0; 
        background: #ffffff; 
      } 
      div#printheader { display: none; }
      #idheader { 
        width:100%; 
        min-height: 60px; 
        padding: 0; 
        margin: 0;
        position: fixed;
        top: 0;
        background: #F0F0F0;
        z-index: 2;
      } 
      /* The "min-height" for "#idheader table" ensures that the (blue) header of the topic
         has at least the same height as the header of the navigation panel left of it */
      #idheader table { min-height: 59px;}             
      #idheader h1 span { color: #000000 }     
      #idnav {
        text-align: right;
        width: 126px;
        vertical-align: middle;        
      } 
      #idnav a { text-decoration: none }
      #idnav span {
        display: inline-block;
        width: 24px;
        height: 24px;
        margin-left: 4px;
        background:url('hm_webhelp_buttons_white.png') top left no-repeat;
      } 
      #idnav a span {
        background-image:url('hm_webhelp_buttons_grey.png');
      } 
      #idnav a span:hover {
        background-image:url('hm_webhelp_buttons_yellow.png');
      } 
      #idnav span.hmbtnprev { background-position: 0 -32px }
      #idnav span.hmbtnnext { background-position: -24px -32px }
      #idnav span.hmbtntop  { background-position: -48px -32px }
      #idnav span.hmbtntoggle  { width: 20px; background-position: -70px -32px }
      #idnav span.hmbtnprint  { background-position: -88px -32px }

      #callout-table, #overview-table {display:block; position:relative; top:0; left:0;}
      #callout-icon {display:block; position:absolute; top:-11px; left:-11px;}
      #callout-icon-flag {display:block; position:absolute; top:-11px; left:-8px;}
      #callout-table a {text-decoration: none; color: blue;}
      #callout-table a:visited {text-decoration: none; color: blue;}
      #overview-table a {text-decoration: none; color: black;}
      #overview-table a:visited {text-decoration: none; color: black;}
      #callout-table a:hover, #overview-table a:hover {text-decoration: underline;}       
      p.help-url { margin: 20px 0 5px 0; text-align: center; }
	  p.help-url a:link { font-size: 50%; text-decoration: none; color: black; }
	  p.help-url a:visited { color: black; }
	  p.help-url a:hover { font-size: 95%; text-decoration: underline; }
      #switchtoggles { text-align: right; padding: 0 2px 0 0; font-size: 90%; } 
      .sync-toc { color: #000000; font-size: 8pt; font-weight: bold; display: none; }
      .sync-toc a { color: #000000; text-decoration: none; font-weight: bold;}
      .sync-toc a:visited { color: #000000; }
      .sync-toc a:hover { text-decoration: underline; }
	  a#printbuttonlink { cursor: pointer; }
      a.hmanchor { display: inline-block; margin-top: -4em; padding-top: 4em; }  
   </style>
   <style TYPE="text/css" media="print">
      div#idheader, img.dropdown-toggle-icon, p.help-url { display:none } 
   </style>
   
   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>

   <script type="text/javascript">
     HMSyncTOC("index.html", "19_5-ipi-architecture.html");
   </script>
   <script type="text/javascript" src="highlight.js"></script>
   <script type="text/javascript">
     $(document).ready(function(){highlight();});
   </script>
</head>
<body>


<div id="printheader"><h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">19.5 IPI Architecture</span></h1>
</div>
<div id="idheader">
<div id="idheaderbg">
<table style="width:100%;border:none;margin:0px;" cellspacing="0" cellpadding="0"> 
  <tr>
    <td class="topichead" style="text-align:left; vertical-align:middle">
      <p class="sync-toc">&lt;&lt; <a rel="nofollow" href="index.html?19_5-ipi-architecture.html" target="_top">Click to Display Table of Contents</a> &gt;&gt;</p>
      <p class="crumbs"><b>Navigation:</b>&nbsp;
      
      <a href="introduction.html">Introduction</a> &gt; <a href="architecture-overview.html">Architecture Overview</a> &gt; <a href="chapter-19---debugging_-tracin.html">Chapter 19 – Interrupt Architecture &amp; IPI</a>&nbsp;&gt;</p>
   
      <h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">19.5 IPI Architecture</span></h1>

    </td>
    <td class="topichead" id="idnav">
      
      <a href="19_4-interrupt-sampling-and-de.html" title="Previous Topic"><span class="hmbtnprev"></span></a>
      <a href="chapter-19---debugging_-tracin.html" title="Parent Chapter"><span class="hmbtntop"></span></a>
      <a href="19_6-memory-barrier-coordinati.html" title="Next Topic"><span class="hmbtnnext"></span></a>
      
    </td>
  </tr>  
</table>
</div>
</div>  

<div id="idcontent"><div id="innerdiv">
<!-- Ask Internet Explorer 6.users to update their obsolete and dangerous browser --> 
<!--[if lt IE 7]><div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;'><a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." /></a></div><![endif]-->

<!--ZOOMRESTART-->
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">19.5.1 Design Decision: Unified Interrupt Path</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">EMulatR intentionally does not create a second interrupt system for IPIs. Instead, IPIs are injected into the same interrupt infrastructure as device and software interrupts. They use the same prioritization, masking, and PAL delivery rules. They differ only in source (another CPU) and payload (an <span class="f_CodeExample">IPICommand</span> with encoded parameters). This avoids duplicated logic and preserves architectural clarity.</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">19.5.2 IPIManager</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span class="f_CodeExample">IPIManager</span> (<span class="f_CodeExample">emulatrLib/IPIManager.h</span>, ~192 lines) provides lock-free IPI message routing. Each CPU has an atomic IPI data slot (<span class="f_CodeExample">std::atomic&lt;quint64&gt;</span>). The design uses latest-IPI-wins semantics, which matches Alpha hardware behavior — posting a new IPI overwrites any pending IPI that has not yet been read.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">Key API:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span class="f_CodeExample">postIPI(cpuId, ipiData)</span> — stores atomically with <span class="f_CodeExample">memory_order_release</span>. The source CPU writes the encoded IPI data into the target CPU's slot.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span class="f_CodeExample">fetchIPI(cpuId)</span> — atomically exchanges to zero with <span class="f_CodeExample">memory_order_acq_rel</span> (read and clear). The target CPU reads and clears its IPI slot in a single atomic operation.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span class="f_CodeExample">peekIPI(cpuId)</span> — reads without clearing. Used for diagnostic inspection.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span class="f_CodeExample">hasIPIPending(cpuId)</span> — checks for non-zero data. Used by the CPU run loop to determine if IPI processing is needed.</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">19.5.3 IPICommand Encoding</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">IPI data is encoded as a <span class="f_CodeExample">quint64</span>: the command byte occupies bits [63:56], and the parameter occupies bits [55:0]. The <span class="f_CodeExample">IPICommand</span> enumeration (<span class="f_CodeExample">coreLib/IPI_core.h</span>, ~245 lines) defines the complete command set:</p>
<p class="p_Normal">&nbsp;</p>
<div style="text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;"><table style="border:none; border-spacing:0; border-collapse:collapse;">
<thead>
<tr>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Category</span></p>
</th>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Commands</span></p>
</th>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Range</span></p>
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_CodeExample"><span class="f_CodeExample">TLB&nbsp;Invalidation</span></p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal"><span class="f_CodeExample">TLB_INVALIDATE_ALL</span> (TBIA), <span class="f_CodeExample">TLB_INVALIDATE_ASN</span> (TBIAP), <span class="f_CodeExample">TLB_INVALIDATE_VA_BOTH</span> (TBIS), <span class="f_CodeExample">TLB_INVALIDATE_VA_ITB</span>, <span class="f_CodeExample">TLB_INVALIDATE_VA_DTB</span></p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">0x01–0x07</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_CodeExample"><span class="f_CodeExample">Cache&nbsp;Coherency</span></p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal"><span class="f_CodeExample">CACHE_INVALIDATE_LINE</span>, <span class="f_CodeExample">CACHE_FLUSH_LINE</span>, <span class="f_CodeExample">CACHE_EVICT_LINE</span>, <span class="f_CodeExample">CACHE_INVALIDATE_ALL</span></p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">0x10–0x13</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_CodeExample"><span class="f_CodeExample">Memory&nbsp;Barriers</span></p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal"><span class="f_CodeExample">MEMORY_BARRIER_FULL</span> (MB), <span class="f_CodeExample">MEMORY_BARRIER_WRITE</span> (WMB)</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">0x20–0x22</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_CodeExample"><span class="f_CodeExample">Synchronization</span></p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal"><span class="f_CodeExample">SYNC_REQUEST</span>, <span class="f_CodeExample">SYNC_ACKNOWLEDGE</span></p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">0x30–0x31</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_CodeExample"><span class="f_CodeExample">System&nbsp;Control</span></p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal"><span class="f_CodeExample">HALT_CPU</span>, <span class="f_CodeExample">WAKE_CPU</span>, <span class="f_CodeExample">CONTEXT_SWITCH</span></p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">0x40–0x42</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_CodeExample"><span class="f_CodeExample">Custom</span></p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal"><span class="f_CodeExample">CUSTOM_BASE</span>, <span class="f_CodeExample">CUSTOM</span></p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">0xF0–0xFF</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><br />
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><br />
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><br />
</td>
</tr>
</tbody>
</table>
</div>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">Helper functions <span class="f_CodeExample">encodeIPIData()</span>, <span class="f_CodeExample">encodeIPIWithVA()</span>, <span class="f_CodeExample">encodeIPIWithASN()</span>, <span class="f_CodeExample">decodeIPICommand()</span>, <span class="f_CodeExample">decodeIPIVA()</span>, and <span class="f_CodeExample">decodeIPIASN()</span> handle encoding and decoding of the 64-bit IPI data word.</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">19.5.4 IPI Delivery Semantics</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">When an IPI is delivered to the target CPU:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_CodeExample"><span class="f_CodeExample">1.&nbsp;IRQPendingState&nbsp;signals&nbsp;the&nbsp;target&nbsp;CPU&nbsp;(IPI&nbsp;source&nbsp;asserted)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">2.&nbsp;CPU&nbsp;enters&nbsp;PAL&nbsp;interrupt&nbsp;handler&nbsp;via&nbsp;checkInterrupts()</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">3.&nbsp;PAL&nbsp;calls&nbsp;handleTLBShootdownIPI(cpuId,&nbsp;ipiData)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">4.&nbsp;decodeIPICommand(ipiData)&nbsp;extracts&nbsp;the&nbsp;command</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">5.&nbsp;Command-specific&nbsp;handler&nbsp;executes:</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;TLB_INVALIDATE_VA_ITB&nbsp;→&nbsp;m_tlb→invalidateTLBEntry(cpuId,&nbsp;Realm::I,&nbsp;va,&nbsp;asn)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;TLB_INVALIDATE_VA_DTB&nbsp;→&nbsp;m_tlb→invalidateTLBEntry(cpuId,&nbsp;Realm::D,&nbsp;va,&nbsp;asn)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;TLB_INVALIDATE_ALL&nbsp;→&nbsp;tbia(cpuId)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;MEMORY_BARRIER_FULL&nbsp;→&nbsp;drain&nbsp;write&nbsp;buffer,&nbsp;acknowledge&nbsp;barrier</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">6.&nbsp;Optional&nbsp;acknowledgment&nbsp;sent&nbsp;to&nbsp;initiating&nbsp;CPU</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">7.&nbsp;HW_REI&nbsp;returns&nbsp;to&nbsp;normal&nbsp;execution</span></p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">IPIs are never handled inline in normal execution. They always enter PAL mode for processing.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_SeeAlso" style="page-break-after: avoid;"><span class="f_SeeAlso">See Also: emulatrLib/IPIManager.h (~192 lines); coreLib/IPI_core.h (~245 lines); cpuCoreLib/AlphaCPU.h – handleTLBShootdownIPI(); <a href="chapter-9_6-write-buffers-in-s.html" class="topiclink">9.6 Inter-Processor Interrupts (IPIs)</a>.</span></p>

<!--ZOOMSTOP-->
</div></div>
<script type="text/javascript">



function normHeaders() {
 var topicHeadHeight =  $("#idheaderbg > table").first().height() + 1,
	 $topicHeaderBox = $("#idheader"),
	 $topicContentBox = $("#idcontent"),
	 $navHeader = $("#navbar", parent.document),			 
	$navBox = $("div#hmnavframe", parent.document),
	 navHeaderHeight = $navHeader.height();
 if (topicHeadHeight != navHeaderHeight) {
	 $navHeader.css("height",topicHeadHeight + "px");
	 $navBox.css("top", topicHeadHeight + "px");
	 $topicHeaderBox.css("height", topicHeadHeight + "px");
		if ($topicHeaderBox.css("position") == "fixed"){
			$topicContentBox.css("margin-top", topicHeadHeight + "px");
			}
		}
    }
			 
  $(document).ready(function(){
    $(window).on('resize', function() {
      var y = $('#idheader').height(); 
      $('#idcontent').css('margin-top', y);
      var par = window.parent;
      if ($( par ).width() <= $( window ).width()+20) {
        $('#idheader').css('position', 'relative');
        $('#idcontent').css('margin-top', 0);
        $('#idbacktotop').css('display', 'block');
        $('.hmanchor').css('margin-top', -20);
	$('.hmanchor').css('padding-top', 20);
      }
      else {
        $('#idheader').css('position', 'fixed');
        $('#idcontent').css('margin-top', $('#idheader').height());
        $('#idbacktotop').css('display', 'none');
        $('.hmanchor').css('margin-top', -y-20);
		$('.hmanchor').css('padding-top', y+20);
		$("div#hmsplitter", parent.document).css('width', '3px');
      }
	normHeaders();
    });
    
	 $(window).resize(); //trigger event for initially small displays
  });
 

if ((!parent.hmNavigationFrame) && (parent.location) && (parent.location.href)) { $('.sync-toc').show();$('p.crumbs').hide();}

</script>
</body>
</html>
