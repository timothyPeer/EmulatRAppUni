hmLoadTopic({
hmKeywords:"",
hmTitle:"18.6 Pipeline Fault Detection and Delivery Flow",
hmDescription:"18.6.1 Detect-Early \/ Deliver-Late Model  ASA-EmulatR implements the Alpha precise exception model through a detect-early\/deliver-late pattern. Faults are detected in the...",
hmPrevLink:"18_5-exception-to-pal-vector-m.html",
hmNextLink:"18_7-pal-mode-entry.html",
hmParentLink:"chapter-18---fault-dispatcher-.html",
hmBreadCrumbs:"<a href=\"index.html\">Introduction<\/a> &gt; <a href=\"architecture-overview.html\">Architecture Overview<\/a> &gt; <a href=\"chapter-18---fault-dispatcher-.html\">Chapter 18 – Fault Dispatcher &amp; Precise Exceptions<\/a>",
hmTitlePath:"Introduction > Architecture Overview > Chapter 18 – Fault Dispatcher & Precise Exceptions > 18.6 Pipeline Fault Detection and Delivery Flow",
hmHeader:"<h1 class=\"p_Heading1\" style=\"page-break-after: avoid;\"><span class=\"f_Heading1\">18.6 Pipeline Fault Detection and Delivery Flow<\/span><\/h1>\n\r",
hmBody:"<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">18.6.1 Detect-Early \/ Deliver-Late Model<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">ASA-EmulatR implements the Alpha precise exception model through a detect-early\/deliver-late pattern. Faults are detected in the Execute (EX) stage but not delivered until the faulting instruction reaches the Writeback (WB) stage. This ensures that all prior instructions have committed and no younger instruction has modified architectural state.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">Detection&nbsp;(EX&nbsp;stage):<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;grain-&gt;execute(slot)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;MBox&nbsp;detects:&nbsp;DTB&nbsp;miss,&nbsp;alignment,&nbsp;ACV,&nbsp;FOE\/FOW\/FOR<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;EBox&nbsp;detects:&nbsp;integer&nbsp;overflow,&nbsp;divide&nbsp;by&nbsp;zero<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;FBox&nbsp;detects:&nbsp;FP&nbsp;overflow\/underflow\/inexact\/invalid\/DBZ<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;└──&nbsp;Pipeline:&nbsp;illegal&nbsp;instruction,&nbsp;privilege&nbsp;violation<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;▼<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;slot.faultPending&nbsp;=&nbsp;true<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;slot.trapCode&nbsp;=&nbsp;ExceptionClass_EV6::...<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;slot.faultVA&nbsp;=&nbsp;faulting_address<\/span><\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">Transit&nbsp;(MEM&nbsp;stage):<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;Faulting&nbsp;instruction&nbsp;flows&nbsp;through&nbsp;MEM<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;Pending&nbsp;commit&nbsp;preserved&nbsp;but&nbsp;may&nbsp;be&nbsp;discarded<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;No&nbsp;side&nbsp;effects&nbsp;committed&nbsp;for&nbsp;faulting&nbsp;instruction<\/span><\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">Delivery&nbsp;(WB&nbsp;stage):<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;stage_WB()&nbsp;checks&nbsp;slot.faultPending&nbsp;BEFORE&nbsp;any&nbsp;commit<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;Discard&nbsp;pending&nbsp;commit&nbsp;(PendingCommit{})<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;Set&nbsp;PipelineAction::FAULT&nbsp;with&nbsp;trapCode\/faultVA\/faultPC<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;Invalidate&nbsp;slot<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;flushYoungerSlots()&nbsp;—&nbsp;clear&nbsp;all&nbsp;younger&nbsp;instructions<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;└──&nbsp;BoxResult::faultDispatched()&nbsp;→&nbsp;enterPalMode()<\/span><\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">The key guarantee: the fault check in WB fires <span style=\"font-weight: bold;\">before<\/span> any store commit or register writeback for the faulting instruction. Older instructions have already committed in prior WB cycles. Younger instructions are flushed and never commit.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">18.6.2 Interrupt Delivery Flow<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">Interrupts follow a different path than synchronous faults. They are sampled during the pre-cycle phase of the CPU run loop, before pipeline advancement:<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">AlphaCPU::runOneInstruction()<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;1.&nbsp;Check&nbsp;FaultDispatcher::eventPending()<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;(delivers&nbsp;queued&nbsp;faults\/traps&nbsp;from&nbsp;prior&nbsp;cycle)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;2.&nbsp;Poll&nbsp;IRQPendingState&nbsp;(if&nbsp;!inPalMode)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;hasDeliverable(currentIPL)&nbsp;→&nbsp;true?<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;claimNext()&nbsp;→&nbsp;ClaimedInterrupt{source,&nbsp;IPL,&nbsp;vector}<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;break&nbsp;reservation<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;PalService::deliverInterrupt(claimed)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;flush&nbsp;pipeline<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;return&nbsp;(skip&nbsp;instruction&nbsp;execution&nbsp;this&nbsp;cycle)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;3.&nbsp;Poll&nbsp;for&nbsp;IPIs&nbsp;(if&nbsp;!inPalMode)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;TLB&nbsp;shootdown,&nbsp;barrier&nbsp;synchronization<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;└──&nbsp;4.&nbsp;Execute&nbsp;pipeline&nbsp;stages&nbsp;(IF&nbsp;→&nbsp;DE&nbsp;→&nbsp;IS&nbsp;→&nbsp;EX&nbsp;→&nbsp;MEM&nbsp;→&nbsp;WB)<\/span><\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">Interrupts are never taken mid-instruction. The interrupt check occurs at instruction boundaries, after the previous instruction has fully retired. PAL mode blocks non-critical interrupt delivery — only machine checks override PAL mode.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_SeeAlso\" style=\"page-break-after: avoid;\"><span class=\"f_SeeAlso\">See Also: <a href=\"13_10-exception-precision.html\" class=\"topiclink\">13.10 Exception Precision<\/a>; <a href=\"chapter-7_7-exception-delivery.html\" class=\"topiclink\">7.8 Precise Exception Model; <\/a> cpuCoreLib\/AlphaCPU.h – runOneInstruction(), checkInterrupts().<\/span><\/p>\n\r"
})
