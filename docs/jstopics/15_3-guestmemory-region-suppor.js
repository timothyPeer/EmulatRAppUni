hmLoadTopic({
hmKeywords:"",
hmTitle:"15.3 GuestMemory Region Support and PA Routing",
hmDescription:"15.3.1 PA Routing Table  GuestMemory maintains a QVector<PARouteEntry> routing table that maps contiguous physical address ranges to subsystems. Each PARouteEntry is an...",
hmPrevLink:"15_2-guestmemory-vs-safememory.html",
hmNextLink:"15_4-sparsememorybacking---on-.html",
hmParentLink:"chapter-15---memory-system-imp.html",
hmBreadCrumbs:"<a href=\"license-_-attributions.html\">ASA-EMulatR Reference Guide<\/a> &gt; <a href=\"index.html\">Introduction<\/a> &gt; <a href=\"architecture-overview.html\">Architecture Overview<\/a> &gt; <a href=\"chapter-15---memory-system-imp.html\">Chapter 15 – Memory System Implementation Details<\/a>",
hmTitlePath:"ASA-EMulatR Reference Guide > Introduction > Architecture Overview > Chapter 15 – Memory System Implementation Details > 15.3 GuestMemory Region Support and PA Routing",
hmHeader:"<h1 class=\"p_Heading1\" style=\"page-break-after: avoid;\"><span class=\"f_Heading1\">15.3 GuestMemory Region Support and PA Routing<\/span><\/h1>\n\r",
hmBody:"<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">15.3.1 PA Routing Table<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">GuestMemory maintains a <span class=\"f_CodeExample\">QVector&lt;PARouteEntry&gt;<\/span> routing table that maps contiguous physical address ranges to subsystems. Each <span class=\"f_CodeExample\">PARouteEntry<\/span> is an 8-byte-aligned structure containing the start PA, end PA (exclusive), a <span class=\"f_CodeExample\">RouteTarget<\/span> discriminator, and an <span class=\"f_CodeExample\">offsetBase<\/span> for PA-to-subsystem-offset translation. The entry provides <span class=\"f_CodeExample\">contains()<\/span>, <span class=\"f_CodeExample\">containsRange()<\/span>, <span class=\"f_CodeExample\">overlaps()<\/span>, and <span class=\"f_CodeExample\">calculateOffset()<\/span> inline methods.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">The <span class=\"f_CodeExample\">RouteTarget<\/span> enumeration has three values: <span class=\"f_CodeExample\">None<\/span> (unmapped), <span class=\"f_CodeExample\">SafeMemory<\/span> (RAM), and <span class=\"f_CodeExample\">MMIOManager<\/span> (memory-mapped I\/O devices). During initialization, <span class=\"f_CodeExample\">initDefaultPARoutes()<\/span> reads the memory map from <span class=\"f_CodeExample\">EmulatorSettings<\/span> and builds exactly two routes. Overlap validation runs at initialization and logs errors for any overlapping ranges.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">15.3.2 Default Route Configuration<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<div style=\"text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;\"><table style=\"border:none; border-spacing:0; border-collapse:collapse;\">\n\r<thead>\n\r<tr>\n\r<th style=\"vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;\" scope=\"col\"><p class=\"p_Normal\"><strong style=\"font-weight: bold;\">Route<\/strong><\/p>\n\r<\/th>\n\r<th style=\"vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;\" scope=\"col\"><p class=\"p_Normal\"><strong style=\"font-weight: bold;\">PA Range<\/strong><\/p>\n\r<\/th>\n\r<th style=\"vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;\" scope=\"col\"><p class=\"p_Normal\"><strong style=\"font-weight: bold;\">Target<\/strong><\/p>\n\r<\/th>\n\r<th style=\"vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;\" scope=\"col\"><p class=\"p_Normal\"><strong style=\"font-weight: bold;\">Offset Mapping<\/strong><\/p>\n\r<\/th>\n\r<\/tr>\n\r<\/thead>\n\r<tbody>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">1 – RAM<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">[0x0, ramBase + ramSize)<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">SafeMemory<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">Identity (PA = offset, offsetBase = 0x0)<\/p>\n\r<\/td>\n\r<\/tr>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">2 – MMIO<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">[mmioBase, mmioBase + mmioSize)<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">MMIOManager<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">Direct PA passthrough to device handlers<\/p>\n\r<\/td>\n\r<\/tr>\n\r<\/tbody>\n\r<\/table>\n\r<\/div>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">With default settings, Route 1 spans [0x0, 0x880000000) covering 34 GB (ramBase 0x0 + 32 GB + low memory), and Route 2 spans [0x1000000000, 0x2000000000) covering 64 GB of Typhoon PCI I\/O space. The <span class=\"f_CodeExample\">setRoutes()<\/span> method allows custom routing tables for non-standard configurations.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">15.3.3 SafeMemory Physical Address Layout<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">Because Route 1 uses identity mapping (offsetBase = 0), the SafeMemory offset equals the physical address for all RAM accesses. The layout within SafeMemory is:<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">PA&nbsp;0x000000&nbsp;-&nbsp;0x1FFFFF&nbsp;SRM&nbsp;firmware&nbsp;(decompressed&nbsp;by&nbsp;SrmRomLoader)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;+--&nbsp;0x002000&nbsp;HWRPB&nbsp;(Hardware&nbsp;Restart&nbsp;Parameter&nbsp;Block)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;+--&nbsp;0x008000&nbsp;PAL&nbsp;entry&nbsp;(PC&nbsp;=&nbsp;0x8001,&nbsp;PAL&nbsp;mode&nbsp;bit&nbsp;set)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;+--&nbsp;0x0xxxxx&nbsp;PAL&nbsp;vectors,&nbsp;SRM&nbsp;console&nbsp;code<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">PA&nbsp;0x600000&nbsp;PAL_BASE&nbsp;(dispatch&nbsp;table)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">PA&nbsp;0x900000&nbsp;Decompressor&nbsp;staging&nbsp;area&nbsp;(temporary)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">PA&nbsp;0x80000000+&nbsp;Main&nbsp;RAM&nbsp;(OS&nbsp;kernel,&nbsp;applications)<\/span><\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">SRM firmware is decompressed into SafeMemory at PA 0x0 by <span class=\"f_CodeExample\">SrmRomLoader<\/span> during system initialization. There is no separate firmware region — after decompression, firmware is simply bytes in RAM.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">15.3.4 Platform Address Maps<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">The <span class=\"f_CodeExample\">PlatformAddressMap<\/span> structure in <span class=\"f_CodeExample\">memory_core.h<\/span> defines platform-specific physical address space layouts for different Alpha chipset families. Each map specifies RAM base, maximum and actual RAM size, MMIO base and size, and a vector of named <span class=\"f_CodeExample\">Aperture<\/span> structures for detailed per-hose MMIO sub-regions.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<div style=\"text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;\"><table style=\"border:none; border-spacing:0; border-collapse:collapse;\">\n\r<thead>\n\r<tr>\n\r<th style=\"vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;\" scope=\"col\"><p class=\"p_Normal\"><strong style=\"font-weight: bold;\">Platform<\/strong><\/p>\n\r<\/th>\n\r<th style=\"vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;\" scope=\"col\"><p class=\"p_Normal\"><strong style=\"font-weight: bold;\">Chipset<\/strong><\/p>\n\r<\/th>\n\r<th style=\"vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;\" scope=\"col\"><p class=\"p_Normal\"><strong style=\"font-weight: bold;\">Max RAM<\/strong><\/p>\n\r<\/th>\n\r<\/tr>\n\r<\/thead>\n\r<tbody>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">DS10 \/ DS20<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">Tsunami<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">2 GB<\/p>\n\r<\/td>\n\r<\/tr>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">ES40 \/ ES45<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">Clipper<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">64 GB<\/p>\n\r<\/td>\n\r<\/tr>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">GS80 \/ GS160 \/ GS320<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">Wildfire<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">128–512 GB<\/p>\n\r<\/td>\n\r<\/tr>\n\r<\/tbody>\n\r<\/table>\n\r<\/div>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">15.3.5 Code Example – PA Routing Path<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">MEM_STATUS&nbsp;GuestMemory::readRouted(quint64&nbsp;pa,&nbsp;quint8&nbsp;width,<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quint64&amp;&nbsp;outValue,<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AccessKind&nbsp;kind)&nbsp;const&nbsp;noexcept<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">{<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;PARouteEntry*&nbsp;route&nbsp;=&nbsp;findRoute(pa);<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!route)&nbsp;return&nbsp;MEM_STATUS::AccessViolation;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;quint64&nbsp;offset&nbsp;=&nbsp;route-&gt;calculateOffset(pa);<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(route-&gt;target)&nbsp;{<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;RouteTarget::SafeMemory:<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;m_safeMem-&gt;load(offset,&nbsp;width,&nbsp;outValue);<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;RouteTarget::MMIOManager:<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;m_mmio-&gt;handleRead(pa,&nbsp;width,&nbsp;outValue);<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;}<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">}<\/span><\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_SeeAlso\" style=\"page-break-after: avoid;\"><span class=\"f_SeeAlso\">See Also: memoryLib\/memory_core.h (~412 lines) – PlatformAddressMap, Aperture, MEM_STATUS, SystemType_EmulatR; memoryLib\/SrmRomLoader.h (~161 lines) – SRM firmware decompression-via-execution; configLib\/global_EmulatorSettings.h – Memory map configuration.<\/span><\/p>\n\r"
})
