hmLoadTopic({
hmKeywords:"",
hmTitle:"4.9 PalBox - Privileged Architecture Library Box",
hmDescription:"PalBox implements the privileged boundary. PAL code is effectively firmware running inside the CPU — it executes within the normal pipeline but with full architectural...",
hmPrevLink:"chapter-4_8---cbox---cache-_-c.html",
hmNextLink:"chapter-4_10-cross-box-interac.html",
hmParentLink:"chapter-4---functionexecution-.html",
hmBreadCrumbs:"<a href=\"index.html\">Introduction<\/a> &gt; <a href=\"architecture-overview.html\">Architecture Overview<\/a> &gt; <a href=\"chapter-4---functionexecution-.html\">Chapter 4 - Functional Execution Domains (&quot;Boxes)<\/a>",
hmTitlePath:"Introduction > Architecture Overview > Chapter 4 - Functional Execution Domains (\"Boxes) > 4.9 PalBox - Privileged Architecture Library Box",
hmHeader:"<h1 class=\"p_Heading1\" style=\"page-break-after: avoid;\"><span class=\"f_Heading1\">4.9 PalBox - Privileged Architecture Library Box<\/span><\/h1>\n\r",
hmBody:"<p class=\"p_Normal\">PalBox implements the privileged boundary. PAL code is effectively firmware running inside the CPU — it executes within the normal pipeline but with full architectural authority.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">Responsibilities<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>CALL_PAL dispatch — executeCALL_PAL() extracts the PAL function code from the low 8 bits of the raw instruction, dispatches to PalService::execute() which implements the specific PAL function (e.g., SWPCTX, CHMK, CALLSYS, CSERVE)<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>PAL mode entry and exit — enterPal(reason, vector, faultPC) sets PAL mode and redirects execution to the exception\/interrupt handler. Only HW_REI may exit PAL mode.<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>Privileged register access — HW_MFPR (Move From Processor Register, opcode 0x19) reads IPRs; HW_MTPR (Move To Processor Register, opcode 0x1D) writes IPRs. These are PAL-mode-only instructions.<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>Hardware load\/store — HW_LD (opcode 0x1B) and HW_ST (opcode 0x1F) provide PAL-mode physical memory access bypassing normal translation<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>Exception vectoring — computes PAL entry vectors from PAL_BASE + offset for exception and interrupt delivery<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>Mode transitions — manages the PAL mode flag via PalService::setPalMode(). Shadow register activation (m_shadowRegsActive) during PAL execution.<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>Low-level OS services — implements privileged PAL calls: HALT, RESTART, REBOOT, DI (disable interrupts), EI (enable interrupts), IMB (instruction memory barrier), DRAINA, SWPCTX (context switch), CHMK\/CHMS\/CHME\/CHMU (change mode), CALLSYS, BPT (breakpoint), BUGCHK, and many more<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>BoxResult mapping — applyBoxResult() unpacks BoxResult flags (flush, enter PAL mode, fault info) into the PipelineSlot fields for pipeline consumption<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">Execution Rules<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>PAL instructions serialize the pipeline — CALL_PAL is a serialization boundary<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>No speculative execution across the PAL boundary<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>Only HW_REI may exit PAL mode<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>LL\/SC reservations are cleared on PAL entry<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>PAL code executes within the normal pipeline — there is no special PAL execution path<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">Architecture<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">PalBox delegates most implementation to PalService (owned via std::unique_ptr&lt;PalService&gt;). PalBox methods follow a uniform pattern: call m_palService-&gt;executeXXX(slot, slot.palResult), then commitPalResult(slot) to apply the result. PalBox also holds references to IRQPendingState and InterruptRouter for interrupt delivery coordination.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">Implementation: PalBoxBase.h, 2,122 lines, 175 execute methods. PalBox supports the full Tru64 UNIX PAL call set as defined in the Alpha Architecture Reference Manual.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">Invariant: PAL mode is an architectural firewall. No unprivileged code may execute HW_MFPR, HW_MTPR, HW_LD, HW_ST, or HW_REI.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_SeeAlso\" style=\"page-break-after: avoid;\"><span class=\"f_SeeAlso\">See Also: <a href=\"chapter-8---pal-and-privleged-.html\" class=\"topiclink\">Chapter 8 - PAL and Privileged Boundary<\/a>; PalBoxLib\/PalBoxBase.h; palLib_EV6\/Pal_Service.h.<\/span><\/p>\n\r"
})
