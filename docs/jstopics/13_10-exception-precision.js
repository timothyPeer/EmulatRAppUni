hmLoadTopic({
hmKeywords:"AlphaCPU,Architectural,BoxResult,Commit,Delivery,Detection,Discard,enterPal,EX,EXC_ADDR,Exception,Fault,faultDispatched,faultPC,faultPending,faultVA,flushYoungerSlots,Invariant,LLSC,m_pending,MEM,PAL,PendingCommit,Pipeline,PipelineAction,Precise,Precision,Reservation,SafeMemory,slotSequence,stage_EX,stage_WB,Store,Synchronous,trapCode,WB",
hmTitle:"13.10 Exception Precision",
hmDescription:"13.10.1 Detect Early, Deliver Late  Exceptions are detected early (in EX) but delivered late (in WB). When a fault is detected in stage_EX(), slot.faultPending is set to true...",
hmPrevLink:"13_9-serialization-and-barrier.html",
hmNextLink:"13_11-branch-handling.html",
hmParentLink:"alphapipeline-implementation.html",
hmBreadCrumbs:"<a href=\"license-_-attributions.html\">ASA-EMulatR Reference Guide<\/a> &gt; <a href=\"index.html\">Introduction<\/a> &gt; <a href=\"architecture-overview.html\">Architecture Overview<\/a> &gt; <a href=\"alphapipeline-implementation.html\">Chapter 13 – AlphaPipeline Implementation<\/a>",
hmTitlePath:"ASA-EMulatR Reference Guide > Introduction > Architecture Overview > Chapter 13 – AlphaPipeline Implementation > 13.10 Exception Precision",
hmHeader:"<h1 class=\"p_Heading1\" style=\"page-break-after: avoid;\"><span class=\"f_Heading1\">13.10 Exception Precision<\/span><\/h1>\n\r",
hmBody:"<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">13.10.1 Detect Early, Deliver Late<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">Exceptions are detected early (in EX) but delivered late (in WB). When a fault is detected in stage_EX(), slot.faultPending is set to true with the trapCode and faultVA. The instruction continues flowing through MEM (where its pending commit is preserved but may be discarded). When the faulting instruction reaches stage_WB(), the fault check fires first — before any store commit or retirement.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\"><strong style=\"font-weight: bold;\">Why not deliver immediately in EX?<\/strong> Because older instructions in MEM and WB must complete first. Delivering in WB guarantees that the faulting instruction is the oldest incomplete instruction — all prior instructions have already retired.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">13.10.2 Fault Delivery in stage_WB()<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">On fault in stage_WB: the m_pending (from a younger instruction in MEM) is discarded (PendingCommit{}), PipelineAction::FAULT is set with trapCode\/faultVA\/faultPC, and the slot is invalidated. The fault propagates to AlphaCPU via BoxResult::faultDispatched(), which triggers enterPal() with EXC_ADDR set to the faulting instruction\'s PC.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">flushYoungerSlots() clears all instructions younger than the faulting instruction — preserving older instructions that have already committed. This guarantees precise exceptions: all prior instructions completed, no later instruction modified architectural state.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\"><strong style=\"font-weight: bold;\">Fault precedence:<\/strong> If multiple slots have faultPending set simultaneously, slotSequence (the monotonic age counter) determines which fault is architecturally first. Only the oldest faulting instruction\'s exception is delivered; younger faulting instructions are discarded by flushYoungerSlots().<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">13.10.3 Precision Invariants<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">The following invariants hold for every exception delivery and are verified by the testing framework (Chapter 22):<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\"><strong style=\"font-weight: bold;\">No younger instruction commits.<\/strong> flushYoungerSlots() is called before the fault propagates. Any younger instruction that reached MEM has its PendingCommit discarded — its register write never takes effect.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\"><strong style=\"font-weight: bold;\">All prior instructions completed.<\/strong> Because WB processes in age order (oldest first, guaranteed by in-order retirement), every instruction older than the faulting instruction has already retired before the fault check executes.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\"><strong style=\"font-weight: bold;\">Faulting stores never reach SafeMemory.<\/strong> Stores commit in stage_WB() after the fault check. Since the fault check fires first and returns immediately, the store commit path is never reached for a faulting instruction.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\"><strong style=\"font-weight: bold;\">Faulting loads never write the result register.<\/strong> Load results sit in slot.payLoad and m_pending until commitPending() in stage_MEM(). If the load faulted, the pending commit is discarded in stage_WB() before the next MEM cycle could commit a younger instruction\'s result.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\"><strong style=\"font-weight: bold;\">LL\/SC reservations cleared on delivery.<\/strong> Exception delivery clears all LL\/SC reservations for the faulting CPU, ensuring no stale reservation survives across a fault boundary.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_SeeAlso\" style=\"page-break-after: avoid;\"><span class=\"f_SeeAlso\">See Also: <a href=\"11_2-execution-and-pipeline-in.html\" class=\"topiclink\">11.2 Execution and Pipeline Invariants<\/a> ; <a href=\"chapter-18---fault-dispatcher-.html\" class=\"topiclink\">Chapter 18 – Fault Dispatcher &amp; Precise Exceptions<\/a> ; <a href=\"chapter-22---testing_-validati.html\" class=\"topiclink\">Chapter 22 – Testing, Validation, and Architectural Compliance<\/a> (exception precision verification).<\/span><\/p>\n\r"
})
