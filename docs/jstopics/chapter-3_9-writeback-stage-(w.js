hmLoadTopic({
hmKeywords:"",
hmTitle:"3.9 Writeback Stage (WB)",
hmDescription:"Sole Commit Point  The Writeback stage is the sole architectural commit point. If an instruction reaches WB, it is guaranteed to be precise. If an instruction has not reached...",
hmPrevLink:"chapter-3_8-memory-stage-(mem).html",
hmNextLink:"chapter-3_10-pipeline-semantic.html",
hmParentLink:"chapter-3---pipeline-architect.html",
hmBreadCrumbs:"<a href=\"license-_-attributions.html\">ASA-EMulatR Reference Guide<\/a> &gt; <a href=\"index.html\">Introduction<\/a> &gt; <a href=\"architecture-overview.html\">Architecture Overview<\/a> &gt; <a href=\"chapter-3---pipeline-architect.html\">Chapter 3 - Pipeline Architecture<\/a>",
hmTitlePath:"ASA-EMulatR Reference Guide > Introduction > Architecture Overview > Chapter 3 - Pipeline Architecture > 3.9 Writeback Stage (WB)",
hmHeader:"<h1 class=\"p_Heading1\" style=\"page-break-after: avoid;\"><span class=\"f_Heading1\">3.9 Writeback Stage (WB)<\/span><\/h1>\n\r",
hmBody:"<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">Sole Commit Point<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">The Writeback stage is the sole architectural commit point. If an instruction reaches WB, it is guaranteed to be precise. If an instruction has not reached WB, its effects may be discarded without side effects.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">Execution Order Within WB<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">stage_WB() executes the following steps in strict order:<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 1.2500rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"display:inline-block;width:1.2500rem;margin-left:-1.2500rem\">1.<\/span>Fault check — if slot.faultPending is true, discard pending commit, report FAULT action, invalidate slot, and return. The faulting instruction produces no architectural result.<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 1.2500rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"display:inline-block;width:1.2500rem;margin-left:-1.2500rem\">2.<\/span>CALL_PAL check — if the instruction is CALL_PAL, discard pending commit (pipeline is about to serialize), compute the PAL entry vector via computeCallPalEntry(), report PAL_CALL action, and return.<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 1.2500rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"display:inline-block;width:1.2500rem;margin-left:-1.2500rem\">3.<\/span>Store commit — if the instruction is a store (S_Store semantic), write data to GuestMemory via write64(slot.pa, slot.payLoad), then break LL\/SC reservations on the affected cache line.<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 1.2500rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"display:inline-block;width:1.2500rem;margin-left:-1.2500rem\">4.<\/span>Branch predictor update — if branchTaken is set, update the CBox branch predictor with the actual outcome.<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 1.2500rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"display:inline-block;width:1.2500rem;margin-left:-1.2500rem\">5.<\/span>Retirement — call commitInstruction() which increments m_instructionsRetired, updates performance counters, and fires the EXECTRACE_WB_RETIRE trace macro.<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 1.2500rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"display:inline-block;width:1.2500rem;margin-left:-1.2500rem\">6.<\/span>Cleanup — invalidate the slot (slot.valid = false) and clear all state.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">Key Implementation Detail<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">Registers are not written in WB. The physical register write occurs in stage_MEM() via commitPending() for forwarding purposes. WB handles store commits, fault dispatch, PAL entry, branch predictor updates, and instruction retirement. This separation is critical: register values must be available to EX in the same cycle, which requires the MEM-before-EX execution order.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">\/\/&nbsp;Store&nbsp;commit&nbsp;in&nbsp;WB:<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">if&nbsp;(slot.di.semantics&nbsp;&amp;&nbsp;S_Store)&nbsp;{<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;MEM_STATUS&nbsp;memStat&nbsp;=&nbsp;m_guestMemory-&gt;write64(slot.pa,&nbsp;slot.payLoad);<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_reservationManager-&gt;breakReservationsOnCacheLine(slot.pa);<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">}<\/span><\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_SeeAlso\" style=\"page-break-after: avoid;\"><span class=\"f_SeeAlso\">See Also: <a href=\"chapter-3_15-precise-exception.html\" class=\"topiclink\">3.14 Precise Exceptions<\/a>; <a href=\"chapter-3_11-backward-pipeline.html\" class=\"topiclink\">3.11 Backward Pipeline Advancement<\/a>; <a href=\"chapter-7---interrupt-and-ipi-.html\" class=\"topiclink\">Chapter 7 - Exceptions, Faults, and Interrupts<\/a>.<\/span><\/p>\n\r"
})
