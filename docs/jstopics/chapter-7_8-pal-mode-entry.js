hmLoadTopic({
hmKeywords:"AlphaCPU,Architecture,Barrier,CALL_PAL_INSTRUCTION,CM,computeCallPalEntry,Context,DeliveryCondition,DispatchTable,enterPalMode,EXC_ADDR,EXC_SUM,Exception,ExecutionEngine,FAULT,faultPC,Flush,Instruction,INTERRUPT,InterruptMask,IPL,Kernel,Mode,Offset,PAL,PAL_BASE,PalEntryReason,PC,Pipeline,Priority,PrivilegedBoundary,PS,Register,saveContext,ShadowRegisters,State,TRAP,Vector,WB",
hmTitle:"7.9 Exception Delivery and PAL Mode Entry",
hmDescription:"7.9.1 Delivery Conditions  An exception may be delivered when: no higher-priority event is pending, no barrier is blocking delivery, the pipeline is in a safe state, and the...",
hmPrevLink:"chapter-7_7-exception-delivery.html",
hmNextLink:"chapter-7_9-interrupt-handling.html",
hmParentLink:"chapter-7---interrupt-and-ipi-.html",
hmBreadCrumbs:"<a href=\"license-_-attributions.html\">ASA-EMulatR Reference Guide<\/a> &gt; <a href=\"index.html\">Introduction<\/a> &gt; <a href=\"architecture-overview.html\">Architecture Overview<\/a> &gt; <a href=\"chapter-7---interrupt-and-ipi-.html\">Chapter 7 - Exceptions, Faults, and Interrupts<\/a>",
hmTitlePath:"ASA-EMulatR Reference Guide > Introduction > Architecture Overview > Chapter 7 - Exceptions, Faults, and Interrupts > 7.9 Exception Delivery and PAL Mode Entry",
hmHeader:"<h1 class=\"p_Heading1\" style=\"page-break-after: avoid;\"><span class=\"f_Heading1\">7.9 Exception Delivery and PAL Mode Entry<\/span><\/h1>\n\r",
hmBody:"<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">7.9.1 Delivery Conditions<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">An exception may be delivered when: no higher-priority event is pending, no barrier is blocking delivery, the pipeline is in a safe state, and the faulting instruction has reached WB stage.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">7.9.2 Architectural State Updates<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">On delivery, the pipeline calls AlphaCPU::enterPalMode() which performs the following state updates:<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">void&nbsp;enterPalMode(PalEntryReason&nbsp;reason,&nbsp;quint64&nbsp;vector,&nbsp;quint64&nbsp;faultPC)&nbsp;{<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;\/\/&nbsp;1.&nbsp;Save&nbsp;complete&nbsp;context<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_iprGlobalMaster-&gt;saveContext();<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;\/\/&nbsp;2.&nbsp;Compute&nbsp;entry&nbsp;PC<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;quint64&nbsp;entryPC;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;if&nbsp;(reason&nbsp;==&nbsp;PalEntryReason::CALL_PAL_INSTRUCTION)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;entryPC&nbsp;=&nbsp;m_iprGlobalMaster-&gt;computeCallPalEntry(vector);<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;else<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;entryPC&nbsp;=&nbsp;vector;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;\/\/&nbsp;3.&nbsp;Set&nbsp;EXC_ADDR&nbsp;to&nbsp;faulting&nbsp;PC<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_iprGlobalMaster-&gt;h-&gt;exc_addr&nbsp;=&nbsp;faultPC;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;\/\/&nbsp;4.&nbsp;Enter&nbsp;PAL&nbsp;mode:&nbsp;PC&nbsp;=&nbsp;vector&nbsp;|&nbsp;0x1,&nbsp;IPL&nbsp;=&nbsp;7,&nbsp;CM&nbsp;=&nbsp;KERNEL<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_iprGlobalMaster-&gt;h-&gt;pc&nbsp;=&nbsp;entryPC&nbsp;|&nbsp;0x1;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_iprGlobalMaster-&gt;h-&gt;setIPL_Unsynced(7);<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_iprGlobalMaster-&gt;h-&gt;setCM(CM_KERNEL);<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;\/\/&nbsp;5.&nbsp;Activate&nbsp;shadow&nbsp;registers&nbsp;for&nbsp;CALL_PAL<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;if&nbsp;(reason&nbsp;==&nbsp;CALL_PAL_INSTRUCTION)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_iprGlobalMaster-&gt;setShadowEnabled(true);<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;\/\/&nbsp;6.&nbsp;Flush&nbsp;pipeline<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_alphaPipeline-&gt;flush(&quot;enterPalMode&quot;);<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">}<\/span><\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">Key state changes: EXC_ADDR receives the faulting PC, EXC_SUM is updated for arithmetic exceptions, PS is updated (mode set to kernel, IPL raised to 7, interrupts masked), and the pipeline is flushed. The low bit of the entry PC (| 0x1) indicates PAL mode to the execution engine.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">7.9.3 PAL Entry Reasons<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">The PalEntryReason determines how the PAL vector is computed and what state is saved:<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">CALL_PAL_INSTRUCTION — explicit PAL call, vector computed from PAL_BASE + dispatch offset, shadow registers activated<\/p>\n\r<p class=\"p_Normal\">TRAP — synchronous trap (arithmetic, software), vector from exception dispatch table<\/p>\n\r<p class=\"p_Normal\">INTERRUPT — asynchronous interrupt, vector from interrupt dispatch table<\/p>\n\r<p class=\"p_Normal\">FAULT — synchronous fault (translation, alignment, access violation), vector from exception dispatch table<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_SeeAlso\" style=\"page-break-after: avoid;\"><span class=\"f_SeeAlso\">See Also: cpuCoreLib\/AlphaCPU.h (enterPalMode); <a href=\"chapter-8---pal-and-privleged-.html\" class=\"topiclink\">Chapter 8 - PAL and Privileged Boundary<\/a>.<\/span><\/p>\n\r"
})
