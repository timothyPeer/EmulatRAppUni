hmLoadTopic({
hmKeywords:"",
hmTitle:"17.8 TLB Invalidation and Shootdown",
hmDescription:"17.8.1 Local Invalidation Operations  Local TLB invalidation operates on a single CPU\'s SPAM shard. These operations are triggered by IPR writes from PAL code:  Operation Scop",
hmPrevLink:"17_7-asn-management-and-cohere.html",
hmNextLink:"17_9-ibox-instruction-translat.html",
hmParentLink:"chapter-17---tlb_-pte_-and-add.html",
hmBreadCrumbs:"<a href=\"index.html\">Introduction<\/a> &gt; <a href=\"architecture-overview.html\">Architecture Overview<\/a> &gt; <a href=\"chapter-17---tlb_-pte_-and-add.html\">Chapter 17 – Address Translation, TLB, and PTE<\/a>",
hmTitlePath:"Introduction > Architecture Overview > Chapter 17 – Address Translation, TLB, and PTE > 17.8 TLB Invalidation and Shootdown",
hmHeader:"<h1 class=\"p_Heading1\" style=\"page-break-after: avoid;\"><span class=\"f_Heading1\">17.8 TLB Invalidation and Shootdown<\/span><\/h1>\n\r",
hmBody:"<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">17.8.1 Local Invalidation Operations<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">Local TLB invalidation operates on a single CPU\'s SPAM shard. These operations are triggered by IPR writes from PAL code:<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<div style=\"text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;\"><table style=\"border:none; border-spacing:0; border-collapse:collapse;\">\n\r<thead>\n\r<tr>\n\r<th style=\"vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;\" scope=\"col\"><p class=\"p_Normal\"><span style=\"font-weight: bold;\">Operation<\/span><\/p>\n\r<\/th>\n\r<th style=\"vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;\" scope=\"col\"><p class=\"p_Normal\"><span style=\"font-weight: bold;\">Scope<\/span><\/p>\n\r<\/th>\n\r<\/tr>\n\r<\/thead>\n\r<tbody>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\"><span class=\"f_CodeExample\">TBIA<\/span><\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">Invalidate all TLB entries (ITB + DTB), all ASNs, local CPU<\/p>\n\r<\/td>\n\r<\/tr>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\"><span class=\"f_CodeExample\">TBIAP<\/span><\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">Invalidate by ASN (ITB + DTB), local CPU — global (ASM) entries preserved<\/p>\n\r<\/td>\n\r<\/tr>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\"><span class=\"f_CodeExample\">TBIS<\/span><\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">Invalidate single VA (ITB + DTB), local CPU<\/p>\n\r<\/td>\n\r<\/tr>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\"><span class=\"f_CodeExample\">TBISI<\/span><\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">Invalidate single VA, ITB only, local CPU<\/p>\n\r<\/td>\n\r<\/tr>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\"><span class=\"f_CodeExample\">TBISD<\/span><\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">Invalidate single VA, DTB only, local CPU<\/p>\n\r<\/td>\n\r<\/tr>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\"><span class=\"f_CodeExample\">DTB_IA<\/span> (IPR write)<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">Invalidate all DTB entries, selecting DTB0 or DTB1 bank<\/p>\n\r<\/td>\n\r<\/tr>\n\r<\/tbody>\n\r<\/table>\n\r<\/div>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">These operations map directly to <span class=\"f_CodeExample\">SPAMShardManager<\/span> methods: <span class=\"f_CodeExample\">tbia(cpuId)<\/span>, <span class=\"f_CodeExample\">invalidateASN(cpuId, asn)<\/span>, <span class=\"f_CodeExample\">tbis(cpuId, va, asn)<\/span>. The IPR dispatch layer (<span class=\"f_CodeExample\">onDTB_IAWrite<\/span>, <span class=\"f_CodeExample\">onITB_IAWrite<\/span>, etc.) calls the appropriate <span class=\"f_CodeExample\">globalEv6PteCache()<\/span> invalidation method and, for ITB operations, also calls <span class=\"f_CodeExample\">flushIPrefetchQueue()<\/span> to discard any fetched instructions with stale translations.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">17.8.2 Global Invalidation (SMP Shootdown)<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">When one CPU modifies page tables, other CPUs must invalidate their TLB entries for the affected mappings. This is accomplished via TLB shootdown — an explicit, synchronized IPI-based protocol:<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">CPU&nbsp;0:&nbsp;Modifies&nbsp;page&nbsp;table&nbsp;entry&nbsp;in&nbsp;GuestMemory<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">CPU&nbsp;0:&nbsp;Performs&nbsp;local&nbsp;TBIS\/TBIA&nbsp;on&nbsp;own&nbsp;TLB<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">CPU&nbsp;0:&nbsp;Broadcasts&nbsp;shootdown&nbsp;IPI&nbsp;to&nbsp;all&nbsp;other&nbsp;CPUs<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;▼<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">Target&nbsp;CPUs:&nbsp;Receive&nbsp;IPI&nbsp;via&nbsp;checkInterrupts()<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">Target&nbsp;CPUs:&nbsp;Enter&nbsp;PAL&nbsp;mode<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">Target&nbsp;CPUs:&nbsp;Call&nbsp;handleTLBShootdownIPI(cpuId,&nbsp;ipiData)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;▼<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">Decode&nbsp;IPICommand:<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;TLB_INVALIDATE_ALL&nbsp;(0x01)&nbsp;→&nbsp;tbia(cpuId)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;TLB_INVALIDATE_ASN&nbsp;(0x02)&nbsp;→&nbsp;invalidateASN(cpuId,&nbsp;asn)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;TLB_INVALIDATE_VA_BOTH&nbsp;(0x03)&nbsp;→&nbsp;tbis(cpuId,&nbsp;va,&nbsp;asn)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;TLB_INVALIDATE_VA_ITB&nbsp;(0x04)&nbsp;→&nbsp;ITB-only&nbsp;invalidate<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;TLB_INVALIDATE_VA_DTB&nbsp;(0x05)&nbsp;→&nbsp;DTB-only&nbsp;invalidate<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;▼<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">Target&nbsp;CPUs:&nbsp;Acknowledge&nbsp;IPI<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">CPU&nbsp;0:&nbsp;Resumes&nbsp;after&nbsp;all&nbsp;targets&nbsp;acknowledge<\/span><\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">Shootdowns are serialized operations — the initiating CPU stalls until all targets have acknowledged. This ensures that no CPU can execute with a stale TLB entry after the page table modification is complete.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">17.8.3 Reservation Clearing on TLB Invalidation<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">The Tru64\/EV6 guarantee specifies that any translation invalidation kills LL\/SC reservations. TLB invalidation operations triggered by IPR writes, PAL code calls, context switches, and inter-processor invalidation must call <span class=\"f_CodeExample\">ReservationManager::instance().clearAllReservations()<\/span> as a side effect. This ensures that no STx_C can succeed against a mapping that has been invalidated — the physical address backing the reservation may no longer be correct.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\"><span style=\"font-weight: bold;\">Invariant:<\/span> Shootdown is always explicit and synchronized — never implicit. No CPU may observe a page table modification without receiving and processing the corresponding shootdown IPI. Only coordination points are ASN epochs and explicit shootdowns.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_SeeAlso\" style=\"page-break-after: avoid;\"><span class=\"f_SeeAlso\">See Also: <a href=\"chapter-9_8-inter-processor-in.html\" class=\"topiclink\">9.8 TLB Shootdown<\/a> ; <a href=\"chapter-9_6-write-buffers-in-s.html\" class=\"topiclink\">9.6 Inter-Processor Interrupts (IPIs)<\/a> ; <a href=\"15_8-ll_sc-reservation-trackin.html\" class=\"topiclink\">15.8 LL\/SC Reservation Tracking<\/a>; cpuCoreLib\/AlphaCPU.h – handleTLBShootdownIPI().<\/span><\/p>\n\r"
})
