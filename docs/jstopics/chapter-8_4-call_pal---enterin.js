hmLoadTopic({
hmKeywords:"",
hmTitle:"8.4 CALL_PAL - Entering the Privileged Boundary",
hmDescription:"8.4.1 CALL_PAL Instruction  CALL_PAL is the only architecturally valid entry point into PAL mode (aside from exception\/interrupt vectors). It encodes a PAL function selector in...",
hmPrevLink:"chapter-8_3-privilege-levels-i.html",
hmNextLink:"chapter-8_5-pal-execution-mode.html",
hmParentLink:"chapter-8---pal-and-privleged-.html",
hmBreadCrumbs:"<a href=\"license-_-attributions.html\">ASA-EMulatR Reference Guide<\/a> &gt; <a href=\"index.html\">Introduction<\/a> &gt; <a href=\"architecture-overview.html\">Architecture Overview<\/a> &gt; <a href=\"chapter-8---pal-and-privleged-.html\">Chapter 8 - PAL and Privileged Boundary<\/a>",
hmTitlePath:"ASA-EMulatR Reference Guide > Introduction > Architecture Overview > Chapter 8 - PAL and Privileged Boundary > 8.4 CALL_PAL - Entering the Privileged Boundary",
hmHeader:"<h1 class=\"p_Heading1\" style=\"page-break-after: avoid;\"><span class=\"f_Heading1\">8.4 CALL_PAL - Entering the Privileged Boundary<\/span><\/h1>\n\r",
hmBody:"<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">8.4.1 CALL_PAL Instruction<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">CALL_PAL is the only architecturally valid entry point into PAL mode (aside from exception\/interrupt vectors). It encodes a PAL function selector in bits [25:0], does not behave like a normal subroutine call, and implies full serialization.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">8.4.2 Serialization Requirements<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">CALL_PAL behaves as the strongest serialization point (MemoryBarrierKind::PAL = 0xFFFF). Before PAL code begins execution:<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 1.2500rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"display:inline-block;width:1.2500rem;margin-left:-1.2500rem\">1.<\/span>All prior instructions must complete<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 1.2500rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"display:inline-block;width:1.2500rem;margin-left:-1.2500rem\">2.<\/span>Write buffers must be drained<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 1.2500rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"display:inline-block;width:1.2500rem;margin-left:-1.2500rem\">3.<\/span>LL\/SC reservations must be cleared<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 1.2500rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"display:inline-block;width:1.2500rem;margin-left:-1.2500rem\">4.<\/span>Speculative instructions must be discarded<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 1.2500rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"display:inline-block;width:1.2500rem;margin-left:-1.2500rem\">5.<\/span>Interrupts must be masked (IPL raised to 7)<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 1.2500rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"display:inline-block;width:1.2500rem;margin-left:-1.2500rem\">6.<\/span>Pipeline must be flushed<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">Failure to serialize creates privilege leaks.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">8.4.3 Entry Implementation<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">PalBoxBase::enterPal() executes the following sequence:<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">BoxResult&nbsp;enterPal(PalEntryReason&nbsp;reason,&nbsp;quint64&nbsp;vectorOrSelector,&nbsp;quint64&nbsp;faultPC)&nbsp;{<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;\/\/&nbsp;1.&nbsp;Record&nbsp;metadata<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_entryReason&nbsp;=&nbsp;reason;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_entryVector&nbsp;=&nbsp;vectorOrSelector;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_faultPC&nbsp;=&nbsp;faultPC;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;\/\/&nbsp;2.&nbsp;Save&nbsp;complete&nbsp;context&nbsp;(UNIFIED&nbsp;-&nbsp;same&nbsp;for&nbsp;all&nbsp;entry&nbsp;types)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_iprGlobalMaster-&gt;saveContext();<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;\/\/&nbsp;3.&nbsp;Compute&nbsp;entry&nbsp;PC<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;if&nbsp;(reason&nbsp;==&nbsp;PalEntryReason::CALL_PAL_INSTRUCTION)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;entryPC&nbsp;=&nbsp;computeCallPalEntry(vectorOrSelector);<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;else<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;entryPC&nbsp;=&nbsp;vectorOrSelector;&nbsp;\/\/&nbsp;Direct&nbsp;vector&nbsp;for&nbsp;faults<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;\/\/&nbsp;4.&nbsp;Set&nbsp;EXC_ADDR&nbsp;to&nbsp;faulting\/return&nbsp;PC<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_iprGlobalMaster-&gt;h-&gt;exc_addr&nbsp;=&nbsp;faultPC;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;\/\/&nbsp;5.&nbsp;Enter&nbsp;PAL&nbsp;mode:&nbsp;PC&nbsp;=&nbsp;vector&nbsp;|&nbsp;0x1,&nbsp;IPL&nbsp;=&nbsp;7,&nbsp;CM&nbsp;=&nbsp;KERNEL<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_iprGlobalMaster-&gt;h-&gt;pc&nbsp;=&nbsp;entryPC&nbsp;|&nbsp;0x1ULL;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_iprGlobalMaster-&gt;h-&gt;setIPL_Unsynced(7);<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_iprGlobalMaster-&gt;h-&gt;setCM(CM_KERNEL);<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;\/\/&nbsp;6.&nbsp;Activate&nbsp;shadow&nbsp;registers<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;m_shadowRegsActive&nbsp;=&nbsp;true;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;\/\/&nbsp;7.&nbsp;Return&nbsp;flush&nbsp;request<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;return&nbsp;BoxResult().flushPipeline();<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">}<\/span><\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">Key details: the low bit of PC (| 0x1) is the PAL mode indicator used by the execution engine. saveContext() captures the full register-context snapshot for later restoration by HW_REI. Shadow registers are activated for CALL_PAL entries, providing a separate register workspace for PAL code.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">8.4.4 PalEntryReason<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">The PalEntryReason enum classifies why PAL mode was entered, which determines how the entry vector is computed:<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">enum&nbsp;class&nbsp;PalEntryReason&nbsp;{<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;CALL_PAL_INSTRUCTION,&nbsp;\/\/&nbsp;Explicit&nbsp;PAL&nbsp;call&nbsp;→&nbsp;computed&nbsp;dispatch&nbsp;offset<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;FAULT_DTBM,&nbsp;\/\/&nbsp;DTB&nbsp;miss&nbsp;→&nbsp;direct&nbsp;vector<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;FAULT_ITB,&nbsp;\/\/&nbsp;ITB&nbsp;miss&nbsp;→&nbsp;direct&nbsp;vector<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;FAULT_ARITH,&nbsp;\/\/&nbsp;Arithmetic&nbsp;exception&nbsp;→&nbsp;direct&nbsp;vector<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;FAULT_UNALIGNED,&nbsp;\/\/&nbsp;Alignment&nbsp;fault&nbsp;→&nbsp;direct&nbsp;vector<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;INTERRUPT,&nbsp;\/\/&nbsp;Hardware\/software&nbsp;interrupt&nbsp;→&nbsp;direct&nbsp;vector<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;AST,&nbsp;\/\/&nbsp;Asynchronous&nbsp;System&nbsp;Trap&nbsp;→&nbsp;direct&nbsp;vector<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;FAULT_ACV,&nbsp;\/\/&nbsp;Access&nbsp;violation&nbsp;→&nbsp;direct&nbsp;vector<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;MACHINE_CHECK,&nbsp;\/\/&nbsp;Machine&nbsp;check&nbsp;→&nbsp;direct&nbsp;vector<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;TRAP&nbsp;\/\/&nbsp;Software&nbsp;trap&nbsp;→&nbsp;direct&nbsp;vector<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">};<\/span><\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_SeeAlso\" style=\"page-break-after: avoid;\"><span class=\"f_SeeAlso\">See Also: PalBoxLib\/PalBoxBase.h (enterPal); palLib_EV6\/PAL_core.h (PalEntryReason).<\/span><\/p>\n\r"
})
