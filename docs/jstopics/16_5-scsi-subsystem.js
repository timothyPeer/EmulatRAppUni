hmLoadTopic({
hmKeywords:"",
hmTitle:"16.5 SCSI Subsystem",
hmDescription:"16.5.1 SCSI Architecture in ASA-EmulatR  The SCSI subsystem follows a layered structure that separates protocol types from bus controllers and from virtual device backends:  Gu",
hmPrevLink:"16_4-asynchronous-device-threa.html",
hmNextLink:"16_6-tape-drive-emulation-and-.html",
hmParentLink:"chapter-16---device-model--dma.html",
hmBreadCrumbs:"<a href=\"index.html\">Introduction<\/a> &gt; <a href=\"architecture-overview.html\">Architecture Overview<\/a> &gt; <a href=\"chapter-16---device-model--dma.html\">Chapter 16 – Device Model &amp; DMA<\/a>",
hmTitlePath:"Introduction > Architecture Overview > Chapter 16 – Device Model & DMA > 16.5 SCSI Subsystem",
hmHeader:"<h1 class=\"p_Heading1\" style=\"page-break-after: avoid;\"><span class=\"f_Heading1\">16.5 SCSI Subsystem<\/span><\/h1>\n\r",
hmBody:"<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">16.5.1 SCSI Architecture in ASA-EmulatR<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">The SCSI subsystem follows a layered structure that separates protocol types from bus controllers and from virtual device backends:<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">Guest&nbsp;OS&nbsp;SCSI&nbsp;Driver<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;▼<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">SCSI&nbsp;HBA&nbsp;Controller&nbsp;(e.g.,&nbsp;ScsiControllerKzpba)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;MMIO&nbsp;registers&nbsp;(command,&nbsp;status,&nbsp;DMA&nbsp;descriptors)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;Owns&nbsp;SCSIBus&nbsp;instance<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;└──&nbsp;Dispatches&nbsp;SCSI&nbsp;commands&nbsp;to&nbsp;target&nbsp;LUNs<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;▼<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">SCSIBus&nbsp;→&nbsp;LUN&nbsp;routing<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;▼<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">Virtual&nbsp;SCSI&nbsp;Devices<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;SCSIDisk&nbsp;(block&nbsp;storage)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;SCSITape&nbsp;(sequential&nbsp;access,&nbsp;tape&nbsp;format&nbsp;variants)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;└──&nbsp;SCSICDROM&nbsp;(read-only,&nbsp;ISO&nbsp;backing)<\/span><\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">The SCSI protocol core headers reside in <span class=\"f_CodeExample\">deviceLib\/<\/span>: <span class=\"f_CodeExample\">ISCSIDevice.h<\/span> (interface), <span class=\"f_CodeExample\">SCSIDisk.h<\/span>, <span class=\"f_CodeExample\">SCSITape.h<\/span>, <span class=\"f_CodeExample\">SCSIBus.h<\/span>, and <span class=\"f_CodeExample\">SCSI_helpers.h<\/span>. These headers define SCSI types, opcodes, CDB structures, and sense data formats. They depend only on Qt containers and basic types — they have no dependency on AlphaCPU, PAL, or the pipeline.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">Bus-facing controllers (KZPBA, QLogic ISP1020) reside in <span class=\"f_CodeExample\">mmioLib\/<\/span> alongside other MMIO devices. The controller owns the <span class=\"f_CodeExample\">SCSIBus<\/span> instance, translates MMIO register writes into SCSI commands, performs DMA between GuestMemory and the device data buffers, and asserts interrupts upon command completion.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">16.5.2 SCSI Command Flow<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">A typical SCSI disk read proceeds as follows: the guest OS driver writes DMA descriptor addresses and a command doorbell to the HBA\'s MMIO registers. The <span class=\"f_CodeExample\">onWrite()<\/span> handler (executing in the CPU thread) queues the command to the device\'s I\/O worker thread and returns immediately. The I\/O worker thread decodes the CDB, routes the command via SCSIBus to the target LUN, the virtual SCSI device performs host-side I\/O (file read for container-backed, block read for RAW-backed), data is written into GuestMemory via DMA (through <span class=\"f_CodeExample\">DMACoherencyManager<\/span>), and the device asserts an interrupt to signal completion.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">16.5.3 Supported SCSI Operations<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">The SCSI protocol core provides CDB decoding for standard SCSI command sets: 6-byte CDBs (READ6, WRITE6, INQUIRY, MODE_SENSE6), 10-byte CDBs (READ10, WRITE10, READ_CAPACITY, MODE_SENSE10), and extended formats (12-byte, 16-byte) for large LBA addressing. Sense data generation covers common conditions: NOT_READY, MEDIUM_ERROR, ILLEGAL_REQUEST, UNIT_ATTENTION, and CHECK_CONDITION.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_SeeAlso\" style=\"page-break-after: avoid;\"><span class=\"f_SeeAlso\">See Also: deviceLib\/SCSIDisk.h; deviceLib\/SCSITape.h; deviceLib\/SCSIBus.h; mmioLib\/ScsiControllerKzpba.h – KZPBA HBA controller.<\/span><\/p>\n\r"
})
