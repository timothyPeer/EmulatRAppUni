hmLoadTopic({
hmKeywords:"",
hmTitle:"GuestMemory SRM Integration",
hmDescription:"# GuestMemory SRM Integration - Complete Guide  ## Summary  You asked how to add **SRM as a routing target** in your existing GuestMemory architecture. Here\'s the complete solu",
hmPrevLink:"",
hmNextLink:"",
hmParentLink:"appendix---trait-examples.html",
hmBreadCrumbs:"",
hmTitlePath:"ASA-EMulatR Reference Guide > Introduction > Appendix > Appendix I â€“ Glossary and Acronyms",
hmHeader:"<h1 class=\"p_Heading1\" style=\"page-break-after: avoid;\"><span class=\"f_Heading1\">GuestMemory SRM Integration<\/span><\/h1>\n\r",
hmBody:"<p class=\"p_Normal\"># GuestMemory SRM Integration - Complete Guide<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">## Summary<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">You asked how to add **SRM as a routing target** in your existing GuestMemory architecture. Here\'s the complete solution:<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">---<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">## ğŸ¯ Your Current Architecture (Excellent!)<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **Existing Routing System:**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">```cpp<\/p>\n\r<p class=\"p_Normal\">GuestMemory (router)<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;â†“ classifies PA<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;â”œâ”€â†’ SafeMemory (RAM) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x0 - 0x1_0000_0000 (4GB)<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;â”œâ”€â†’ MMIOManager (devices) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x1_0000_0000 - 0x2_0000_0000 (4GB)<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;â””â”€â†’ AlphaMemorySystem (PAL+SRM) &nbsp; &nbsp;0x2_0000_0000 - 0x2_0500_0000 (80MB)<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">**Your comment says AMS handles &quot;PAL+SRM+HWRPB&quot;** - but these are conceptually different:<\/p>\n\r<p class=\"p_Normal\">- **PAL** = Low-level CPU services (C++ emulated or real Alpha binary)<\/p>\n\r<p class=\"p_Normal\">- **SRM** = High-level firmware (clipper.bin - real Alpha binary)<\/p>\n\r<p class=\"p_Normal\">- **HWRPB** = Data structures<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">**Recommendation:** Separate SRM from AMS for clarity and modularity.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">---<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">## âœ… Proposed Architecture (4 Routing Targets)<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **Updated Routing System:**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">```cpp<\/p>\n\r<p class=\"p_Normal\">GuestMemory (router)<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;â†“ classifies PA<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;â”œâ”€â†’ SafeMemory (RAM) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x0_0000_0000 - 0x1_0000_0000 (4GB)<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;â”œâ”€â†’ MMIOManager (devices) &nbsp; &nbsp; &nbsp; &nbsp; 0x1_0000_0000 - 0x2_0000_0000 (4GB)<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;â”œâ”€â†’ AlphaMemorySystem (PAL) &nbsp; &nbsp; &nbsp; 0x2_0000_0000 - 0x2_0010_0000 (1MB)<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;â”œâ”€â†’ SRMFirmwareRegion (SRM) &nbsp; &nbsp; &nbsp; 0x2_0010_0000 - 0x2_0030_0000 (2MB) â† NEW!<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;â””â”€â†’ AlphaMemorySystem (HWRPB) &nbsp; &nbsp; 0x2_0030_0000 - 0x2_0040_0000 (1MB)<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">**Benefits:**<\/p>\n\r<p class=\"p_Normal\">- âœ… Clear separation: PAL â‰  SRM â‰  HWRPB<\/p>\n\r<p class=\"p_Normal\">- âœ… SRM can be reloaded independently<\/p>\n\r<p class=\"p_Normal\">- âœ… Write protection enforced at SRM level<\/p>\n\r<p class=\"p_Normal\">- âœ… Statistics tracking for SRM accesses<\/p>\n\r<p class=\"p_Normal\">- âœ… Easy to understand and maintain<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">---<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">## ğŸ”§ Implementation Changes<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **1. Add SRM to RouteTarget Enum**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">```cpp<\/p>\n\r<p class=\"p_Normal\">enum class RouteTarget : quint8<\/p>\n\r<p class=\"p_Normal\">{<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;None = 0,<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;SafeMemory,<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;MMIOManager,<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;AlphaMemorySystem,<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;SRMFirmware &nbsp; &nbsp; &nbsp; &nbsp;\/\/ â† NEW!<\/p>\n\r<p class=\"p_Normal\">};<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **2. Create SRMFirmwareRegion Class**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">**New class to handle SRM binary:**<\/p>\n\r<p class=\"p_Normal\">- Loads clipper.bin from file<\/p>\n\r<p class=\"p_Normal\">- Provides read\/write access (write-protected by default)<\/p>\n\r<p class=\"p_Normal\">- Tracks access statistics<\/p>\n\r<p class=\"p_Normal\">- Enforces alignment and bounds<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">**Files:**<\/p>\n\r<p class=\"p_Normal\">- `SRMFirmwareRegion.h` - Interface<\/p>\n\r<p class=\"p_Normal\">- `SRMFirmwareRegion.cpp` - Implementation<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **3. Update GuestMemory**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">**Add SRM subsystem:**<\/p>\n\r<p class=\"p_Normal\">```cpp<\/p>\n\r<p class=\"p_Normal\">class GuestMemory {<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;\/\/ ...<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;SRMFirmwareRegion* m_srm{ nullptr }; &nbsp;\/\/ â† NEW!<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;void attachSubsystems(<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp;SafeMemory* sm,<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp;MMIOManager* mmio,<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp;AlphaMemorySystem* ams,<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp;SRMFirmwareRegion* srm &nbsp;\/\/ â† NEW!<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;);<\/p>\n\r<p class=\"p_Normal\">};<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">**Update routing table:**<\/p>\n\r<p class=\"p_Normal\">```cpp<\/p>\n\r<p class=\"p_Normal\">void GuestMemory::initDefaultPARoutes() noexcept<\/p>\n\r<p class=\"p_Normal\">{<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;m_routes.clear();<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;\/\/ RAM: 4GB at 0x0<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;m_routes.append({ 0x0000000000000000ULL, <\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x0000000100000000ULL, <\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;RouteTarget::SafeMemory });<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;\/\/ MMIO: 4GB at 0x1_0000_0000<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;m_routes.append({ 0x0000000100000000ULL, <\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x0000000200000000ULL, <\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;RouteTarget::MMIOManager });<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;\/\/ AMS PAL: 1MB at 0x2_0000_0000<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;m_routes.append({ 0x0000000200000000ULL, <\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x0000000200100000ULL, <\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;RouteTarget::AlphaMemorySystem });<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;\/\/ SRM: 2MB at 0x2_0010_0000 â† NEW!<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;m_routes.append({ 0x0000000200100000ULL, <\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x0000000200300000ULL, <\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;RouteTarget::SRMFirmware });<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;\/\/ AMS HWRPB: 1MB at 0x2_0030_0000<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;m_routes.append({ 0x0000000200300000ULL, <\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x0000000200400000ULL, <\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;RouteTarget::AlphaMemorySystem });<\/p>\n\r<p class=\"p_Normal\">}<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">**Update routing logic:**<\/p>\n\r<p class=\"p_Normal\">```cpp<\/p>\n\r<p class=\"p_Normal\">MEM_STATUS GuestMemory::readRouted(quint64 pa, quint8 width, <\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; quint64&amp; outValue, AccessKind kind) noexcept<\/p>\n\r<p class=\"p_Normal\">{<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;const RouteTarget t = classifyPARange(pa, width);<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;switch (t) {<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;case RouteTarget::SafeMemory:<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp;return m_safeMem-&gt;load(pa, width, outValue);<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp;<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;case RouteTarget::MMIOManager:<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp;return m_mmio-&gt;handleRead(pa, width, outValue);<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp;<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;case RouteTarget::AlphaMemorySystem:<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp;return m_ams-&gt;read(pa, width, outValue);<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp;<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;case RouteTarget::SRMFirmware: &nbsp;\/\/ â† NEW!<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp;{<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;const quint64 offset = pa - m_srm-&gt;basePA();<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return m_srm-&gt;read(offset, width, outValue);<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp;}<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp;<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;default:<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp;return MEM_STATUS::AccessViolation;<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;}<\/p>\n\r<p class=\"p_Normal\">}<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">---<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">## ğŸ“Š Memory Map Comparison<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **Before (Your Current Map):**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">0x0000_0000_0000_0000 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚ RAM (4GB) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; â”‚<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚ SafeMemory &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚<\/p>\n\r<p class=\"p_Normal\">0x0000_0001_0000_0000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚ MMIO (4GB) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚ MMIOManager &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; â”‚<\/p>\n\r<p class=\"p_Normal\">0x0000_0002_0000_0000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚ PAL+SRM+HWRPB (80MB) &nbsp; &nbsp;â”‚ â† Lumped together<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚ AlphaMemorySystem &nbsp; &nbsp; &nbsp; â”‚<\/p>\n\r<p class=\"p_Normal\">0x0000_0002_0500_0000 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **After (Proposed Map):**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">0x0000_0000_0000_0000 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚ RAM (4GB) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; â”‚<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚ SafeMemory &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚<\/p>\n\r<p class=\"p_Normal\">0x0000_0001_0000_0000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚ MMIO (4GB) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚ MMIOManager &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; â”‚<\/p>\n\r<p class=\"p_Normal\">0x0000_0002_0000_0000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚ PAL (1MB) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; â”‚ â† Separated!<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚ AlphaMemorySystem &nbsp; &nbsp; &nbsp; â”‚<\/p>\n\r<p class=\"p_Normal\">0x0000_0002_0010_0000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚ SRM (2MB) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; â”‚ â† NEW! clipper.bin<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚ SRMFirmwareRegion &nbsp; &nbsp; &nbsp; â”‚<\/p>\n\r<p class=\"p_Normal\">0x0000_0002_0030_0000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚ HWRPB (1MB) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; â”‚ â† Separated!<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;â”‚ AlphaMemorySystem &nbsp; &nbsp; &nbsp; â”‚<\/p>\n\r<p class=\"p_Normal\">0x0000_0002_0040_0000 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">**Advantages:**<\/p>\n\r<p class=\"p_Normal\">- Clear separation of PAL, SRM, HWRPB<\/p>\n\r<p class=\"p_Normal\">- SRM at dedicated address (0x2_0010_0000)<\/p>\n\r<p class=\"p_Normal\">- Easy to reload SRM independently<\/p>\n\r<p class=\"p_Normal\">- Write protection at SRM level<\/p>\n\r<p class=\"p_Normal\">- Better organization<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">---<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">## ğŸš€ Initialization Sequence<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **Step 1: Create Subsystems**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">```cpp<\/p>\n\r<p class=\"p_Normal\">\/\/ Create all four subsystems<\/p>\n\r<p class=\"p_Normal\">SafeMemory* safeMem = new SafeMemory();<\/p>\n\r<p class=\"p_Normal\">safeMem-&gt;allocate(0x0, 0x100000000); &nbsp;\/\/ 4GB RAM<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">MMIOManager* mmio = new MMIOManager();<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">AlphaMemorySystem* ams = new AlphaMemorySystem();<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">SRMFirmwareRegion* srm = new SRMFirmwareRegion({<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;.basePA = 0x0000000200100000ULL,<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;.size = 0x00200000ULL, &nbsp;\/\/ 2MB<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;.writeProtected = true<\/p>\n\r<p class=\"p_Normal\">});<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **Step 2: Load SRM Firmware**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">```cpp<\/p>\n\r<p class=\"p_Normal\">\/\/ Load clipper.bin into SRM region<\/p>\n\r<p class=\"p_Normal\">if (!srm-&gt;loadFromFile(&quot;clipper.bin&quot;)) {<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;ERROR_LOG(&quot;Failed to load SRM firmware&quot;);<\/p>\n\r<p class=\"p_Normal\">}<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **Step 3: Attach to GuestMemory**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">```cpp<\/p>\n\r<p class=\"p_Normal\">auto&amp; gm = global_GuestMemory();<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">gm.attachSubsystems(<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;safeMem, &nbsp;\/\/ RAM<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;mmio, &nbsp; &nbsp; \/\/ Devices<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;ams, &nbsp; &nbsp; &nbsp;\/\/ PAL\/HWRPB<\/p>\n\r<p class=\"p_Normal\"> &nbsp; &nbsp;srm &nbsp; &nbsp; &nbsp; \/\/ SRM firmware â† NEW!<\/p>\n\r<p class=\"p_Normal\">);<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">gm.initDefaultPARoutes();<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **Step 4: Set CPU PC**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">```cpp<\/p>\n\r<p class=\"p_Normal\">\/\/ Set PC to SRM entry point<\/p>\n\r<p class=\"p_Normal\">cpu-&gt;setPC(0x0000000200100000ULL); &nbsp;\/\/ SRM base<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">\/\/ Set PAL_BASE (for C++ emulation, this is unused)<\/p>\n\r<p class=\"p_Normal\">cpu-&gt;writeIPR(IPR_PAL_BASE, 0x0000000200000000ULL);<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">---<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">## ğŸ’¡ How It Works<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **Instruction Fetch from SRM:**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">CPU wants to fetch instruction at PC = 0x2_0010_0000<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">1. CPU calls: gm.readInst32(0x2_0010_0000, instr)<\/p>\n\r<p class=\"p_Normal\">2. GuestMemory classifies PA â†’ RouteTarget::SRMFirmware<\/p>\n\r<p class=\"p_Normal\">3. GuestMemory routes to: m_srm-&gt;read(offset=0, width=4, value)<\/p>\n\r<p class=\"p_Normal\">4. SRMFirmwareRegion reads from clipper.bin buffer<\/p>\n\r<p class=\"p_Normal\">5. Returns Alpha instruction (e.g., CALL_PAL #0x03)<\/p>\n\r<p class=\"p_Normal\">6. CPU executes instruction<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **CALL_PAL Execution:**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">SRM code contains: CALL_PAL #0x03 (CSERVE)<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">1. CPU decodes CALL_PAL instruction (fetched from SRM region)<\/p>\n\r<p class=\"p_Normal\">2. CPU traps to PAL mode<\/p>\n\r<p class=\"p_Normal\">3. Your PalService::executeCSERVE() is invoked (C++ handler)<\/p>\n\r<p class=\"p_Normal\">4. R16 examined for CSERVE function code<\/p>\n\r<p class=\"p_Normal\">5. Console I\/O performed via ConsoleManager<\/p>\n\r<p class=\"p_Normal\">6. Return to SRM code (next instruction)<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **Write Protection:**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">Attempt to write to SRM:<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">gm.write64(0x2_0010_0000, 0x12345678)<\/p>\n\r<p class=\"p_Normal\"> &nbsp;â†“<\/p>\n\r<p class=\"p_Normal\">GuestMemory routes to SRMFirmwareRegion<\/p>\n\r<p class=\"p_Normal\"> &nbsp;â†“<\/p>\n\r<p class=\"p_Normal\">SRMFirmwareRegion checks writeProtected = true<\/p>\n\r<p class=\"p_Normal\"> &nbsp;â†“<\/p>\n\r<p class=\"p_Normal\">Returns MEM_STATUS::AccessViolation<\/p>\n\r<p class=\"p_Normal\"> &nbsp;â†“<\/p>\n\r<p class=\"p_Normal\">CPU raises fault<\/p>\n\r<p class=\"p_Normal\">```<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">---<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">## ğŸ¯ Key Design Decisions<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **Why Separate SRM from AMS?**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">**Conceptual:**<\/p>\n\r<p class=\"p_Normal\">- PAL = Low-level system services (often C++ emulated)<\/p>\n\r<p class=\"p_Normal\">- SRM = High-level firmware (real Alpha binary)<\/p>\n\r<p class=\"p_Normal\">- HWRPB = Data structures<\/p>\n\r<p class=\"p_Normal\">- **These are different things!**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">**Practical:**<\/p>\n\r<p class=\"p_Normal\">- SRM binary can be reloaded independently<\/p>\n\r<p class=\"p_Normal\">- Write protection enforced at SRM level<\/p>\n\r<p class=\"p_Normal\">- Statistics tracking for SRM execution<\/p>\n\r<p class=\"p_Normal\">- Clearer debugging (know if executing from SRM vs PAL)<\/p>\n\r<p class=\"p_Normal\">- Easier to swap SRM versions<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **Why Not Make SRM Part of SafeMemory?**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">SafeMemory is for **general RAM** - writable, cacheable, no special handling.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">SRM needs:<\/p>\n\r<p class=\"p_Normal\">- Write protection (ROM)<\/p>\n\r<p class=\"p_Normal\">- Load from file (clipper.bin)<\/p>\n\r<p class=\"p_Normal\">- Statistics tracking<\/p>\n\r<p class=\"p_Normal\">- Separate lifecycle management<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">**Separate class is cleaner.**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **Why 0x2_0010_0000 for SRM Base?**<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">Your existing map uses 0x2_xxxx_xxxx for system resources:<\/p>\n\r<p class=\"p_Normal\">- 0x2_0000_0000 = PAL (1MB is plenty for PAL if you had it)<\/p>\n\r<p class=\"p_Normal\">- 0x2_0010_0000 = SRM (2MB for clipper.bin)<\/p>\n\r<p class=\"p_Normal\">- 0x2_0030_0000 = HWRPB (1MB for data structures)<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">**Total:** 4MB of system space, well within your 0x2_0500_0000 allocation.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">---<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">## ğŸ“‹ Files Provided<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **Core Implementation:**<\/p>\n\r<p class=\"p_Normal\">1. **GuestMemory_UPDATED.h** - Updated header with SRM support<\/p>\n\r<p class=\"p_Normal\">2. **GuestMemory_UPDATED.cpp** - Updated implementation with routing<\/p>\n\r<p class=\"p_Normal\">3. **SRMFirmwareRegion.h** - New SRM handler interface<\/p>\n\r<p class=\"p_Normal\">4. **SRMFirmwareRegion.cpp** - New SRM handler implementation<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **Examples:**<\/p>\n\r<p class=\"p_Normal\">5. **GUESTMEMORY_SRM_INIT_EXAMPLE.cpp** - Complete initialization example<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">---<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">## âœ… Integration Checklist<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">- [ ] Add `SRMFirmware` to `RouteTarget` enum<\/p>\n\r<p class=\"p_Normal\">- [ ] Add `SRMFirmwareRegion.h` and `.cpp` to project<\/p>\n\r<p class=\"p_Normal\">- [ ] Update `GuestMemory::attachSubsystems()` signature<\/p>\n\r<p class=\"p_Normal\">- [ ] Update `GuestMemory::initDefaultPARoutes()`<\/p>\n\r<p class=\"p_Normal\">- [ ] Update `GuestMemory::readRouted()` with SRM case<\/p>\n\r<p class=\"p_Normal\">- [ ] Update `GuestMemory::writeRouted()` with SRM case<\/p>\n\r<p class=\"p_Normal\">- [ ] Add `isSRM()` helper method<\/p>\n\r<p class=\"p_Normal\">- [ ] Create `SRMFirmwareRegion` instance during init<\/p>\n\r<p class=\"p_Normal\">- [ ] Load `clipper.bin` into SRM region<\/p>\n\r<p class=\"p_Normal\">- [ ] Set CPU PC to SRM base (0x2_0010_0000)<\/p>\n\r<p class=\"p_Normal\">- [ ] Test instruction fetch from SRM<\/p>\n\r<p class=\"p_Normal\">- [ ] Test write protection (should fail)<\/p>\n\r<p class=\"p_Normal\">- [ ] Verify CALL_PAL instructions execute<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">---<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">## ğŸ‰ Benefits Summary<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **âœ… Architecture:**<\/p>\n\r<p class=\"p_Normal\">- Clean separation of concerns<\/p>\n\r<p class=\"p_Normal\">- Single routing point (no ambiguity)<\/p>\n\r<p class=\"p_Normal\">- Easy to trace execution<\/p>\n\r<p class=\"p_Normal\">- Modular and maintainable<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **âœ… Functionality:**<\/p>\n\r<p class=\"p_Normal\">- SRM binary loaded separately<\/p>\n\r<p class=\"p_Normal\">- Write protection enforced<\/p>\n\r<p class=\"p_Normal\">- Statistics tracking available<\/p>\n\r<p class=\"p_Normal\">- Easy firmware reload<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **âœ… Performance:**<\/p>\n\r<p class=\"p_Normal\">- Direct routing (minimal overhead)<\/p>\n\r<p class=\"p_Normal\">- Inline classification<\/p>\n\r<p class=\"p_Normal\">- No nested checks<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">### **âœ… Debugging:**<\/p>\n\r<p class=\"p_Normal\">- Clear PAâ†’subsystem mapping<\/p>\n\r<p class=\"p_Normal\">- Easy to dump memory map<\/p>\n\r<p class=\"p_Normal\">- Statistics show SRM usage<\/p>\n\r<p class=\"p_Normal\">- Write violations logged<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">---<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">## ğŸš€ Next Steps<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">1. **Integrate SRMFirmwareRegion** into your project<\/p>\n\r<p class=\"p_Normal\">2. **Update GuestMemory** routing tables<\/p>\n\r<p class=\"p_Normal\">3. **Load clipper.bin** during initialization<\/p>\n\r<p class=\"p_Normal\">4. **Set CPU PC** to SRM entry (0x2_0010_0000)<\/p>\n\r<p class=\"p_Normal\">5. **Run emulator** and watch SRM execute!<\/p>\n\r<p class=\"p_Normal\">6. **Connect PuTTY** to port 23<\/p>\n\r<p class=\"p_Normal\">7. **See &quot;P00&gt;&gt;&gt; &quot; prompt!** ğŸŠ<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">---<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">**Your routing architecture was already excellent - this just extends it with proper SRM support!** ğŸ¯<\/p>\n\r"
})
