hmLoadTopic({
hmKeywords:"",
hmTitle:"17.3 Translation Path",
hmDescription:"17.3.1 Where Translation Occurs  Address translation occurs in MBox during the EX stage. The Ev6Translator (pteLib\/ev6Translation_struct.h, ~1,336 lines) provides the...",
hmPrevLink:"17_2-pte-representation.html",
hmNextLink:"17_4-spam-tlb-cache-architectu.html",
hmParentLink:"chapter-17---tlb_-pte_-and-add.html",
hmBreadCrumbs:"<a href=\"index.html\">Introduction<\/a> &gt; <a href=\"architecture-overview.html\">Architecture Overview<\/a> &gt; <a href=\"chapter-17---tlb_-pte_-and-add.html\">Chapter 17 – Address Translation, TLB, and PTE<\/a>",
hmTitlePath:"Introduction > Architecture Overview > Chapter 17 – Address Translation, TLB, and PTE > 17.3 Translation Path",
hmHeader:"<h1 class=\"p_Heading1\" style=\"page-break-after: avoid;\"><span class=\"f_Heading1\">17.3 Translation Path<\/span><\/h1>\n\r",
hmBody:"<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">17.3.1 Where Translation Occurs<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">Address translation occurs in MBox during the EX stage. The <span class=\"f_CodeExample\">Ev6Translator<\/span> (<span class=\"f_CodeExample\">pteLib\/ev6Translation_struct.h<\/span>, ~1,336 lines) provides the translation engine. Translation responsibilities include VA→PA conversion, ITB\/DTB miss detection, access violation detection, alignment fault detection, and precise translation fault raising.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">Translation never occurs during fetch (IBox translates instruction addresses separately via the ITB), decode, or writeback. The MBox calculates the effective address via <span class=\"f_CodeExample\">calculateEffectiveAddress(slot)<\/span> — <span class=\"f_CodeExample\">Rb + SEXT(displacement)<\/span> — and then invokes the translator.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">17.3.2 Fast Translation Path<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\"><span class=\"f_CodeExample\">ev6TranslateFastVA()<\/span> is the primary translation entry point, optimized for the common case:<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">ev6TranslateFastVA(cpuId,&nbsp;va,&nbsp;asn,&nbsp;accessType)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;1.&nbsp;Canonical&nbsp;address&nbsp;check<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;(bits&nbsp;above&nbsp;vaBits-1&nbsp;must&nbsp;sign-extend)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;Fail&nbsp;→&nbsp;TranslationResult::NonCanonical<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;2.&nbsp;KSEG&nbsp;fast-path&nbsp;check<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;(kernel&nbsp;segment&nbsp;direct&nbsp;mapping,&nbsp;no&nbsp;TLB&nbsp;needed)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;Hit&nbsp;→&nbsp;PA&nbsp;=&nbsp;VA&nbsp;&amp;&nbsp;ksegMask,&nbsp;return&nbsp;Success<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;├──&nbsp;3.&nbsp;TLB&nbsp;lookup&nbsp;via&nbsp;Ev6SiliconTLB<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;Construct&nbsp;tag:&nbsp;VPN&nbsp;=&nbsp;VA&nbsp;&gt;&gt;&nbsp;pageShift<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;Search&nbsp;per-CPU&nbsp;SPAM&nbsp;shard<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;Hit&nbsp;→&nbsp;check&nbsp;permissions&nbsp;(KRE\/KWE\/URE\/UWE&nbsp;vs&nbsp;mode)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;check&nbsp;FOE\/FOW\/FOR<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;PA&nbsp;=&nbsp;(PFN&nbsp;&lt;&lt;&nbsp;pageShift)&nbsp;|&nbsp;(VA&nbsp;&amp;&nbsp;offsetMask)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│&nbsp;return&nbsp;Success<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;│<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;└──&nbsp;4.&nbsp;TLB&nbsp;miss<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;return&nbsp;TranslationResult::TlbMiss<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;(caller&nbsp;decides&nbsp;whether&nbsp;to&nbsp;walk&nbsp;or&nbsp;raise&nbsp;fault)<\/span><\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">The fast path does not walk page tables. On TLB miss, it returns <span class=\"f_CodeExample\">TlbMiss<\/span> immediately, leaving the miss handling decision to the caller (typically MBox or PAL).<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">17.3.3 Full Translation Path<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\"><span class=\"f_CodeExample\">ev6TranslateFullVA()<\/span> performs the same checks as the fast path, plus a full page table walk on TLB miss using the three-level Alpha page table structure (L1→L2→L3). The walk reads PTEs from GuestMemory at each level, checking validity at each step. On successful walk, the resulting PTE is inserted into the TLB via Layer 1 and the translation succeeds. On failure at any level, the appropriate <span class=\"f_CodeExample\">TranslationResult<\/span> is returned:<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<div style=\"text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;\"><table style=\"border:none; border-spacing:0; border-collapse:collapse;\">\n\r<thead>\n\r<tr>\n\r<th style=\"vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;\" scope=\"col\"><p class=\"p_Normal\"><span style=\"font-weight: bold;\">Result<\/span><\/p>\n\r<\/th>\n\r<th style=\"vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;\" scope=\"col\"><p class=\"p_Normal\"><span style=\"font-weight: bold;\">Condition<\/span><\/p>\n\r<\/th>\n\r<\/tr>\n\r<\/thead>\n\r<tbody>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\"><span class=\"f_CodeExample\">Success<\/span><\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">Translation completed, PA available<\/p>\n\r<\/td>\n\r<\/tr>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\"><span class=\"f_CodeExample\">TlbMiss<\/span><\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">No TLB entry (fast path only)<\/p>\n\r<\/td>\n\r<\/tr>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\"><span class=\"f_CodeExample\">NonCanonical<\/span><\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">VA upper bits not sign-extended<\/p>\n\r<\/td>\n\r<\/tr>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\"><span class=\"f_CodeExample\">PageNotPresent<\/span><\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">PTE.V = 0 at any page table level (TNV fault)<\/p>\n\r<\/td>\n\r<\/tr>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\"><span class=\"f_CodeExample\">FaultOnRead\/Write\/Execute<\/span><\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">FOR\/FOW\/FOE bit set in PTE<\/p>\n\r<\/td>\n\r<\/tr>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\"><span class=\"f_CodeExample\">AccessViolation<\/span><\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">Permission check failed (mode vs KRE\/KWE\/URE\/UWE)<\/p>\n\r<\/td>\n\r<\/tr>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\"><span class=\"f_CodeExample\">BusError<\/span><\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">Physical memory access failure during walk<\/p>\n\r<\/td>\n\r<\/tr>\n\r<\/tbody>\n\r<\/table>\n\r<\/div>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_SeeAlso\" style=\"page-break-after: avoid;\"><span class=\"f_SeeAlso\">See Also: pteLib\/ev6Translation_struct.h (~1,336 lines) – Ev6Translator; pteLib\/calculateEffectiveAddress.h – EA calculation helper; <a href=\"14_4-mbox---memory-box.html\" class=\"topiclink\">14.4 MBox – Memory Box<\/a>.<\/span><\/p>\n\r"
})
