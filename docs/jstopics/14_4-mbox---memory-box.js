hmLoadTopic({
hmKeywords:"",
hmTitle:"14.4 MBox – Memory Box",
hmDescription:"The MBox executes all memory-referencing instructions: integer and floating-point loads and stores, unaligned accesses, locked load\/store-conditional pairs for atomic...",
hmPrevLink:"14_3-fbox---floating-point-exe.html",
hmNextLink:"14_5-cbox---cache-_-control-bo.html",
hmParentLink:"chapter-14---execution-domains.html",
hmBreadCrumbs:"<a href=\"license-_-attributions.html\">ASA-EMulatR Reference Guide<\/a> &gt; <a href=\"index.html\">Introduction<\/a> &gt; <a href=\"architecture-overview.html\">Architecture Overview<\/a> &gt; <a href=\"chapter-14---execution-domains.html\">Chapter 14 – Execution Domains (“Boxes”)<\/a>",
hmTitlePath:"ASA-EMulatR Reference Guide > Introduction > Architecture Overview > Chapter 14 – Execution Domains (“Boxes”) > 14.4 MBox – Memory Box",
hmHeader:"<h1 class=\"p_Heading1\" style=\"page-break-after: avoid;\"><span class=\"f_Heading1\">14.4 MBox – Memory Box<\/span><\/h1>\n\r",
hmBody:"<p class=\"p_Normal\">The MBox executes all memory-referencing instructions: integer and floating-point loads and stores, unaligned accesses, locked load\/store-conditional pairs for atomic operations, and cache-hint instructions. On the 21264, the Mbox owned the data cache (Dcache), the data-stream TLB (DTB), the miss-address file (MAF), and the address generation datapath. In EmulatR, the MBox integrates TLB translation (via the <span class=\"f_CodeExample\">Ev6SiliconTLB<\/span> singleton), physical memory access (via <span class=\"f_CodeExample\">GuestMemory<\/span>), and reservation tracking (via <span class=\"f_CodeExample\">ReservationManager<\/span>) for LDx_L\/STx_C atomicity.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">14.4.1 Responsibilities<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>Integer loads: LDL, LDQ, LDQ_U, LDBU, LDWU<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>Integer stores: STL, STQ, STQ_U, STB, STW<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>Floating-point loads: LDF, LDG, LDS, LDT<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>Floating-point stores: STF, STG, STS, STT<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>Locked load \/ store-conditional: LDL_L, LDQ_L, STL_C, STQ_C (via ReservationManager)<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>Address calculation (LDA, LDAH executed in MBox path)<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>VA-to-PA translation with staged PTE cache for PAL IPR updates<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>Cache-hint NOPs: ECB, WH64, WH64EN, FETCH, FETCH_M<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>Miscellaneous: RPCC (read process cycle counter), RDUNIQUE\/WRUNIQUE<\/p>\n\r<p class=\"p_Normal\" style=\"text-indent: 0; padding-left: 0.8125rem; margin-left: 0;\"><span class=\"f_Normal\" style=\"font-family: Arial,\'Lucida Sans Unicode\',\'Lucida Grande\',\'Lucida Sans\';display:inline-block;width:0.8125rem;margin-left:-0.8125rem\">&#8226;<\/span>Bit-manipulation extensions (EV67 CIX): CTPOP, CTLZ, CTTZ<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">14.4.2 Address Translation Flow<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">For every memory operation, the MBox calculates the effective address (Rb + sign-extended displacement) and then translates the virtual address to a physical address via the EV6 TLB. The translation path supports two modes: normal TLB lookup through the <span class=\"f_CodeExample\">Ev6SiliconTLB<\/span> singleton, and staged PTE lookup through the <span class=\"f_CodeExample\">StagedPTECache<\/span> for PAL-mode IPR-driven TLB fill operations. The <span class=\"f_CodeExample\">translateWithStagedEntry()<\/span> method attempts the staged cache first (for active PAL TLB fill flows), then falls through to the hardware TLB.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">14.4.3 Atomic Operations – LDx_L \/ STx_C<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_Normal\">The LDL_L and LDQ_L instructions perform a load and establish a per-CPU reservation on the target physical address via the global <span class=\"f_CodeExample\">ReservationManager<\/span>. The subsequent STL_C or STQ_C checks the reservation: if the address is still reserved for this CPU, the store succeeds and Ra is set to 1; if the reservation has been cleared (by another CPU\'s store or a barrier), the store is suppressed and Ra is set to 0. This implements the Alpha\'s compare-and-swap primitive for lock-free algorithms.<\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">14.4.4 Code Example – Load Quadword<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">AXP_HOT&nbsp;AXP_ALWAYS_INLINE&nbsp;void&nbsp;executeLDQ(PipelineSlot&amp;&nbsp;slot)&nbsp;noexcept<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">{<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;\/\/&nbsp;Calculate&nbsp;effective&nbsp;address:&nbsp;Rb&nbsp;+&nbsp;SEXT(displacement)<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;quint64&nbsp;va&nbsp;=&nbsp;calculateEffectiveAddress(slot);<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;\/\/&nbsp;Translate&nbsp;VA&nbsp;-&gt;&nbsp;PA&nbsp;via&nbsp;TLB<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;ev6TranslationResult&nbsp;xlat;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!translateWithStagedEntry(va,&nbsp;xlat,&nbsp;slot))<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&nbsp;&nbsp;\/\/&nbsp;Translation&nbsp;fault&nbsp;—&nbsp;dispatched&nbsp;to&nbsp;FaultDispatcher<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;\/\/&nbsp;Read&nbsp;8&nbsp;bytes&nbsp;from&nbsp;physical&nbsp;memory<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;quint64&nbsp;data&nbsp;=&nbsp;0;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;m_guestMemory-&gt;read64(xlat.physAddr,&nbsp;data);<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">&nbsp;&nbsp;&nbsp;&nbsp;slot.payLoad&nbsp;=&nbsp;data;<\/span><\/p>\n\r<p class=\"p_CodeExample\"><span class=\"f_CodeExample\">}<\/span><\/p>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<hr style=\"height:1px; color:#000000; border-width:0; background-color:#000000;\" \/><p class=\"p_Normal\">&nbsp;<\/p>\n\r<h2 class=\"p_Heading2\" style=\"page-break-after: avoid;\"><span class=\"f_Heading2\">14.4.5 Source Files<\/span><\/h2>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<div style=\"text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;\"><table style=\"border:none; border-spacing:0; border-collapse:collapse;\">\n\r<thead>\n\r<tr>\n\r<th style=\"vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;\" scope=\"col\"><p class=\"p_Normal\"><strong style=\"font-weight: bold;\">File<\/strong><\/p>\n\r<\/th>\n\r<th style=\"vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;\" scope=\"col\"><p class=\"p_Normal\"><strong style=\"font-weight: bold;\">Lines (approx)<\/strong><\/p>\n\r<\/th>\n\r<th style=\"vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;\" scope=\"col\"><p class=\"p_Normal\"><strong style=\"font-weight: bold;\">Content<\/strong><\/p>\n\r<\/th>\n\r<\/tr>\n\r<\/thead>\n\r<tbody>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">MBoxLib_EV6\/MBoxBase.h<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">~2,256<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">Complete MBox class: loads, stores, translation, LDx_L\/STx_C, IPR staging<\/p>\n\r<\/td>\n\r<\/tr>\n\r<tr>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">MBoxLib_EV6\/MBoxBase.cpp<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">~24<\/p>\n\r<\/td>\n\r<td style=\"vertical-align:top; padding:0; border:solid thin #000000;\"><p class=\"p_Normal\">Compilation unit include (breaks circular dependency)<\/p>\n\r<\/td>\n\r<\/tr>\n\r<\/tbody>\n\r<\/table>\n\r<\/div>\n\r<p class=\"p_Normal\">&nbsp;<\/p>\n\r<p class=\"p_SeeAlso\" style=\"page-break-after: avoid;\"><span class=\"f_SeeAlso\">See Also: pteLib\/Ev6SiliconTLB_Singleton.h – TLB implementation; cpuCoreLib\/ReservationManager.h – LDx_L\/STx_C reservation tracking; pteLib\/calculateEffectiveAddress.h – EA calculation helper; memoryLib\/GuestMemory.h – Physical memory access interface; cpuCoreLib\/StagedPTECache.h – PAL-mode staged PTE entries.<\/span><\/p>\n\r"
})
