<!DOCTYPE html>
<html>
<head>
   <title>Introduction &gt; Appendix &gt; Taskables &gt; SPAM Shard Support</title>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />   
   <meta http-equiv="X-UA-Compatible" content="IE=edge" />
   <meta name="generator" content="Help &amp; Manual" />
   <meta name="keywords" content="" />
   <meta name="description" content="You’re very welcome 😊 And nice, this is exactly the right point to carve in the layering and stop letting templates leak all over the place." />
   <link type="text/css" href="default.css" rel="stylesheet" />
   <link type="text/css" href="custom.css" rel="stylesheet" />

   <style TYPE="text/css" media="screen"> 
      html, body { margin:0; 
        padding:0; 
        background: #ffffff; 
      } 
      div#printheader { display: none; }
      #idheader { 
        width:100%; 
        height:auto; 
        padding: 0; 
        margin: 0;
        position: fixed;
        top: 0;
        z-index: 2;
      } 
      /* The "min-height" for "#idheader table" ensures that the (blue) header of the topic
         has at least the same height as the header of the navigation panel left of it */
      #idheader table { background: #2C5D88; min-height: 59px }             
      #idheader h1 { color: #FFF }     
      #idnav {
        text-align: right;
        width: 126px;
        vertical-align: middle;        
      } 
      #idnav a { text-decoration: none }
      #idnav span {
        display: inline-block;
        width: 24px;
        height: 24px;
        margin-left: 4px;
        background:url('hm_webhelp_buttons_grey.png') top left no-repeat;
      } 
      #idnav a span {
        background-image:url('hm_webhelp_buttons_white.png');
      } 
      #idnav a span:hover {
        background-image:url('hm_webhelp_buttons_orange.png');
      } 
      #idnav span.hmbtnprev { background-position: 0 -32px }
      #idnav span.hmbtnnext { background-position: -24px -32px }
      #idnav span.hmbtntop  { background-position: -48px -32px }
      #idnav span.hmbtntoggle  { width: 20px; background-position: -70px -32px }
      #idnav span.hmbtnprint  { background-position: -88px -32px }

      #callout-table, #overview-table {display:block; position:relative; top:0; left:0;}
      #callout-icon {display:block; position:absolute; top:-11px; left:-11px;}
      #callout-icon-flag {display:block; position:absolute; top:-11px; left:-8px;}
      #callout-table a {text-decoration: none; color: blue;}
      #callout-table a:visited {text-decoration: none; color: blue;}
      #overview-table a {text-decoration: none; color: black;}
      #overview-table a:visited {text-decoration: none; color: black;}
      #callout-table a:hover, #overview-table a:hover {text-decoration: underline;}       
      p.help-url { margin: 20px 0 5px 0; text-align: center; font-size: 80%; text-decoration: none }      
      #switchtoggles { text-align: right; padding: 0 2px 0 0; font-size: 90%; } 
      .sync-toc { color: #FFF; font-size: 8pt; font-weight: bold; display: none; }
      .sync-toc a { color: #FFF; text-decoration: none; font-weight: bold;}
      .sync-toc a:visited { color: #FFF; }
      .sync-toc a:hover { text-decoration: underline; }
      a.hmanchor { display: inline-block; margin-top: -4em; padding-top: 4em }	  
   </style>
   <style TYPE="text/css" media="print">
      div#idheader, img.dropdown-toggle-icon, p.help-url { display:none } 
   </style>
   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>

   <script type="text/javascript">
     HMSyncTOC("index.html", "spam-shard-support.html");
   </script>
   <script type="text/javascript" src="highlight.js"></script>
   <script type="text/javascript">
     $(document).ready(function(){highlight();});
   </script>
</head>
<body>


<div id="printheader"><h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">SPAM Shard Support</span></h1>
</div>
<div id="idheader">
<div id="idheaderbg">
<table style="width:100%;border:none;margin:0px;" cellspacing="0" cellpadding="0"> 
  <tr>
    <td class="topichead" style="text-align:left; vertical-align:bottom">
      <p class="sync-toc">&lt;&lt; <a rel="nofollow" href="index.html?spam-shard-support.html" target="_top">Click to Display Table of Contents</a> &gt;&gt;</p>
      <p class="crumbs"><b>Navigation:</b>&nbsp;
      
      <a href="introduction.html">Introduction</a> &gt; <a href="appendix---trait-examples.html">Appendix</a> &gt; <a href="taskables.html">Taskables</a>&nbsp;&gt;</p>
   
      <h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">SPAM Shard Support</span></h1>

    </td>
    <td class="topichead" id="idnav">
      
      <a href="cpustateiprinterface-taskable2.html" title="Previous Topic"><span class="hmbtnprev"></span></a>
      <a href="taskables.html" title="Parent Chapter"><span class="hmbtntop"></span></a>
      <a href="conventions.html" title="Next Topic"><span class="hmbtnnext"></span></a>
      
    </td>
  </tr>  
</table>
</div>
</div>  

<div id="idcontent"><div id="innerdiv">
<!-- Ask Internet Explorer 6.users to update their obsolete and dangerous browser --> 
<!--[if lt IE 7]><div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;'><a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." /></a></div><![endif]-->

<!--ZOOMRESTART-->
<p class="p_Normal">You’re very welcome 😊 And nice, this is exactly the right point to carve in the layering and stop letting templates leak all over the place.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">Let me do three things for you:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">1. **Confirm the mental model** you just described (it’s right).</p>
<p class="p_Normal">2. **Propose a clean 3-layer design (silicon L0 / helper L1 / API L2)**.</p>
<p class="p_Normal">3. **Give you concrete code that *hides* the Trait/Templates behind EV6-only types**, so the rest of the emulator doesn’t have to touch templates at all.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">I’ll *preserve* your existing PTE / SPAM structure and banks/SMP behavior; I’m just going to wrap it so EV6 is a concrete, non-templated “chip”.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">---</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">## 1. Quick confirmation of your mental model</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&gt; “the VA and PFN are encoded into a PTE… the PTE is data-agnostic and only cares about addresses / translations”</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">Yes.</p>
<p class="p_Normal">And in your current code:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">* `AlphaPTE` (in `AlphaPTE_Core.h`) is the **architectural PTE**.</p>
<p class="p_Normal">* `SPAMTag` + `SPAMEntry` (in `Alpha_spam_types.h`) are the **TLB cache objects**.</p>
<p class="p_Normal">* `SPAMBucket` and `SPAMShardManager` are the **implementation of the TLB cache** (banks, SMP, epochs, etc.).</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">All the *heavy* templating is around `Traits`, `SPAMBucket&lt;Traits,...&gt;`, `SPAMShardManager&lt;Traits,...&gt;`, and you only ever want **EV6** right now.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">So instead of ripping all templates out, the sane path is:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&gt; **Instantiate them once for EV6 and hide that behind non-templated typedefs and wrapper functions.**</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">That gives you:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">* EV6-only “silicon” types.</p>
<p class="p_Normal">* No template parameters sprinkled all over the rest of the code.</p>
<p class="p_Normal">* No loss of functionality.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">---</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">## 2. Layering: L0 (Silicon), L1 (Helpers), L2 (API)</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">Here’s a clean way to structure it:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> **Layer 0 – “Silicon” (EV6-only)**</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">This is where you:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">* Define **EV6 PTE / TLB / SPAM traits**.</p>
<p class="p_Normal">* Instantiate the **SPAMBucket** and **SPAMShardManager** templates for EV6.</p>
<p class="p_Normal">* Centralize **page size configuration** (8K / 16K / 32K / 64K) as “silicon parameters”.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">**No one above this layer touches templates.**</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">Files:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">* `Ev6PteSilicon.h` (new)</p>
<p class="p_Normal">* Still uses:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp;* `AlphaPTE_Core.h`</p>
<p class="p_Normal"> &nbsp;* `alpha_pte_core.h`</p>
<p class="p_Normal"> &nbsp;* `alpha_spam_bucket.h`</p>
<p class="p_Normal"> &nbsp;* `Alpha_spam_types.h`</p>
<p class="p_Normal"> &nbsp;* `alpha_pte_traits_ev6_dtb.h`</p>
<p class="p_Normal"> &nbsp;* `alpha_pte_traits_ev6_itb.h`</p>
<p class="p_Normal"> &nbsp;* `alpha_spam_manager.h` (but only as implementation)</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">---</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> **Layer 1 – “Helper / MMU Interface”**</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">This layer is what PAL and TBI hooks will call:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">* `Ev6TLBInterface` / `Ev6MMUInterface` class or namespace.</p>
<p class="p_Normal">* Methods like:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp;* `bool tlbLookupD(cpuId, va, asn, outPfn, outPermMask)`</p>
<p class="p_Normal"> &nbsp;* `void tlbInsertD(cpuId, va, asn, const AlphaPTE&amp;, bool global)`</p>
<p class="p_Normal"> &nbsp;* `void tbiVA(cpuId, va, Realm realm)`</p>
<p class="p_Normal"> &nbsp;* `void tbiAll(cpuId)`</p>
<p class="p_Normal"> &nbsp;* `void tbiASN(cpuId, asn)`</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">This layer works purely with:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">* `AlphaPTE`</p>
<p class="p_Normal">* `Ev6SPAMManager` (non-templated alias)</p>
<p class="p_Normal">* `PageSizeCode` and `PageSizeHelpers`</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">No Traits, no templates in signatures.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">---</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> **Layer 2 – “PAL / API Layer”**</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">This is the interface you wire to:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">* PALcode emulation (`CALL_PAL TBIS/TBIA/TBIAP`)</p>
<p class="p_Normal">* MFPR / MTPR of ITB/DTB registers:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp;* `ITB_TAG`, `ITB_PTE`, `DTB_TAG`, `DTB_PTE`</p>
<p class="p_Normal"> &nbsp;* `ITB_PTE_WRITE`, `ITB_TAG_READ`, etc.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">This layer calls Layer 1 helpers like:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">* `Ev6TLBInterface::tbiVA(...)`</p>
<p class="p_Normal">* `Ev6TLBInterface::insertITB(...)`</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">And uses your EV6-specific register structs from:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">* `ev6_DtbPteTempRegister.h`</p>
<p class="p_Normal">* `ev6_ItbPteRead_Register.h`</p>
<p class="p_Normal">* `ev6_ITBPteWrite_Register.h`</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">---</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">## 3. Concrete code: EV6 “silicon” layer (L0) with hidden templates</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> 3.1 New header: `Ev6PteSilicon.h`</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">This file sits in your Alpha include tree and gives you **non-templated EV6 types**.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">```cpp</p>
<p class="p_Normal">#pragma once</p>
<p class="p_Normal">// Ev6PteSilicon.h</p>
<p class="p_Normal">//</p>
<p class="p_Normal">// EV6-only &quot;silicon&quot; layer for PTE / TLB / SPAM.</p>
<p class="p_Normal">// Hides Traits and template parameters from the rest of the emulator.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">#include &lt;QtCore/QtGlobal&gt;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">#include &quot;AlphaPTE_Core.h&quot; &nbsp; &nbsp; &nbsp; &nbsp;// AlphaPTE (architectural PTE)</p>
<p class="p_Normal">#include &quot;alpha_pte_core.h&quot; &nbsp; &nbsp; &nbsp; // PageSizeCode, PageSizeHelpers, Realm, PermMask, etc.</p>
<p class="p_Normal">#include &quot;Alpha_spam_types.h&quot; &nbsp; &nbsp; // SPAMTag&lt;T&gt;, SPAMEntry&lt;T&gt;</p>
<p class="p_Normal">#include &quot;alpha_spam_bucket.h&quot; &nbsp; &nbsp;// SPAMBucket&lt;Traits,...&gt;</p>
<p class="p_Normal">#include &quot;alpha_spam_manager.h&quot; &nbsp; // SPAMShardManager&lt;Traits,...&gt;</p>
<p class="p_Normal">#include &quot;alpha_pte_traits_ev6_dtb.h&quot;</p>
<p class="p_Normal">#include &quot;alpha_pte_traits_ev6_itb.h&quot;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">// Forward-declare your system-wide config if you have one.</p>
<p class="p_Normal">// For now, we define a small VM config struct here.</p>
<p class="p_Normal">struct Ev6VMConfig</p>
<p class="p_Normal">{</p>
<p class="p_Normal"> &nbsp; &nbsp;PageSizeCode basePageSize; &nbsp; &nbsp;// e.g. PageSizeCode::PageSize_8K</p>
<p class="p_Normal"> &nbsp; &nbsp;bool enableSuperpage64K; &nbsp; &nbsp; &nbsp;// if you later want 64K support</p>
<p class="p_Normal"> &nbsp; &nbsp;bool enableSuperpage32K; &nbsp; &nbsp; &nbsp;// reserved for future</p>
<p class="p_Normal"> &nbsp; &nbsp;bool enableSuperpage16K; &nbsp; &nbsp; &nbsp;// reserved for future</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;// Default EV6 config: 8KB base page, no extra superpage classes by default.</p>
<p class="p_Normal"> &nbsp; &nbsp;static Ev6VMConfig defaultConfig() noexcept</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;Ev6VMConfig cfg{};</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;cfg.basePageSize &nbsp; &nbsp; &nbsp;= PageSizeCode::PageSize_8K;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;cfg.enableSuperpage64K = false;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;cfg.enableSuperpage32K = false;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;cfg.enableSuperpage16K = false;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;return cfg;</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">};</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">// Singleton-ish access point for the silicon config.</p>
<p class="p_Normal">// You can wire this to SystemConfigLoader later.</p>
<p class="p_Normal">class Ev6SiliconConfig</p>
<p class="p_Normal">{</p>
<p class="p_Normal">public:</p>
<p class="p_Normal"> &nbsp; &nbsp;static void initialize(const Ev6VMConfig &amp;cfg) noexcept</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;s_config = cfg;</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;static Ev6VMConfig config() noexcept</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;return s_config;</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;static quint64 basePageShift() noexcept</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;return PageSizeHelpers::pageShift(s_config.basePageSize);</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;static quint64 basePageSizeBytes() noexcept</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;return PageSizeHelpers::pageSizeBytes(s_config.basePageSize);</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">private:</p>
<p class="p_Normal"> &nbsp; &nbsp;static inline Ev6VMConfig s_config = Ev6VMConfig::defaultConfig();</p>
<p class="p_Normal">};</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">// ---------------------------------------------------------------------------</p>
<p class="p_Normal">// EV6 PTETraits – single, concrete traits type for EV6.</p>
<p class="p_Normal">// This replaces the generic Traits template parameter.</p>
<p class="p_Normal">// ---------------------------------------------------------------------------</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">struct Ev6PTETraits</p>
<p class="p_Normal">{</p>
<p class="p_Normal"> &nbsp; &nbsp;using PTE &nbsp; &nbsp; &nbsp;= AlphaPTE;</p>
<p class="p_Normal"> &nbsp; &nbsp;using Tag &nbsp; &nbsp; &nbsp;= SPAMTag&lt;Ev6PTETraits&gt;;</p>
<p class="p_Normal"> &nbsp; &nbsp;using Entry &nbsp; &nbsp;= SPAMEntry&lt;Ev6PTETraits&gt;;</p>
<p class="p_Normal"> &nbsp; &nbsp;using Realm &nbsp; &nbsp;= ::Realm;</p>
<p class="p_Normal"> &nbsp; &nbsp;using PermMask = ::PermMask;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;// Page size class plumbing.</p>
<p class="p_Normal"> &nbsp; &nbsp;// For now: sizeClass 0 = 8K (or whatever Ev6SiliconConfig says)</p>
<p class="p_Normal"> &nbsp; &nbsp;// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sizeClass 1 = 64K (optional superpage)</p>
<p class="p_Normal"> &nbsp; &nbsp;static constexpr quint8 SizeClass_8K &nbsp;= 0;</p>
<p class="p_Normal"> &nbsp; &nbsp;static constexpr quint8 SizeClass_64K = 1;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;static PageSizeCode pageSizeForClass(quint8 sizeClass) noexcept</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;switch (sizeClass)</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;case SizeClass_8K:</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return Ev6SiliconConfig::config().basePageSize;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;case SizeClass_64K:</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return PageSizeCode::PageSize_64K;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;default:</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// Fallback to base page</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return Ev6SiliconConfig::config().basePageSize;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;static quint64 pageShiftForClass(quint8 sizeClass) noexcept</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;return PageSizeHelpers::pageShift(pageSizeForClass(sizeClass));</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;// Tag construction helper adapted from Alpha_spam_types.h semantics.</p>
<p class="p_Normal"> &nbsp; &nbsp;static Tag makeTag(quint64 va, ::Realm realm, quint8 sizeClass) noexcept</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;Tag t{};</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;const PageSizeCode code = pageSizeForClass(sizeClass);</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;const quint64 shift &nbsp; &nbsp; = PageSizeHelpers::pageShift(code);</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;t.vpn &nbsp; &nbsp; &nbsp; = va &gt;&gt; shift;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;t.sizeClass = sizeClass;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;t.realm &nbsp; &nbsp; = (realm == Realm::D) ? 0 : 1;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;t.matchAllASNs = false;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;return t;</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">};</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">// ---------------------------------------------------------------------------</p>
<p class="p_Normal">// Concrete EV6 SPAM types – these are NON-TEMPLATED from the outside.</p>
<p class="p_Normal">// ---------------------------------------------------------------------------</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">constexpr unsigned EV6_SPAM_ASSOC_WAYS &nbsp;= 4;</p>
<p class="p_Normal">constexpr unsigned EV6_SPAM_MAX_ASN &nbsp; &nbsp; = 256;</p>
<p class="p_Normal">constexpr unsigned EV6_SPAM_BUCKETS &nbsp; &nbsp; = 1024;</p>
<p class="p_Normal">constexpr bool &nbsp; &nbsp; EV6_SPAM_SHARD_BY_SIZE = true;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">// Bucket and entry types for EV6</p>
<p class="p_Normal">using Ev6SPAMBucket = SPAMBucket&lt;Ev6PTETraits, EV6_SPAM_ASSOC_WAYS, EV6_SPAM_MAX_ASN&gt;;</p>
<p class="p_Normal">using Ev6SPAMEntry &nbsp;= Ev6SPAMBucket::Entry;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">// Shard manager for EV6 (this is your &quot;silicon TLB&quot; implementation)</p>
<p class="p_Normal">using Ev6SPAMShardManager =</p>
<p class="p_Normal"> &nbsp; &nbsp;SPAMShardManager&lt;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;Ev6PTETraits,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;EV6_SPAM_ASSOC_WAYS,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;EV6_SPAM_MAX_ASN,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;EV6_SPAM_BUCKETS,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;EV6_SPAM_SHARD_BY_SIZE</p>
<p class="p_Normal"> &nbsp; &nbsp;&gt;;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">// ---------------------------------------------------------------------------</p>
<p class="p_Normal">// Silicon-level TLB container for the whole system.</p>
<p class="p_Normal">// This is what Layer-1 will hold onto and call.</p>
<p class="p_Normal">// ---------------------------------------------------------------------------</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">class Ev6SiliconTLB</p>
<p class="p_Normal">{</p>
<p class="p_Normal">public:</p>
<p class="p_Normal"> &nbsp; &nbsp;explicit Ev6SiliconTLB(int cpuCount)</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;: m_spam(cpuCount)</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;// You can add silicon-level init logic here if needed.</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;Ev6SPAMShardManager &amp;spam() noexcept { return m_spam; }</p>
<p class="p_Normal"> &nbsp; &nbsp;const Ev6SPAMShardManager &amp;spam() const noexcept { return m_spam; }</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">private:</p>
<p class="p_Normal"> &nbsp; &nbsp;Ev6SPAMShardManager m_spam;</p>
<p class="p_Normal">};</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">```</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">**Key points:**</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">* All the *real* templates (`SPAMBucket`, `SPAMShardManager`, `SPAMTag`, `SPAMEntry`) still exist, but:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp;* They are instantiated exactly once for **Ev6PTETraits**.</p>
<p class="p_Normal"> &nbsp;* Everything above this header just sees `Ev6SPAMShardManager`, `Ev6SPAMEntry`, `Ev6SiliconTLB` as normal classes / types.</p>
<p class="p_Normal">* `Ev6SiliconConfig` is your **Layer-0 “chip config”** – base page size, superpage options, etc. You can feed this from `SystemConfigLoader` later.</p>
<p class="p_Normal">* The PTE structure (`AlphaPTE`) is **unchanged** and remains ASA-correct.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">---</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> 3.2 Layer-1 helper interface: `Ev6TLBInterface.h`</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">This is what TBI hooks and PAL emulation will call. It sits on top of `Ev6SiliconTLB`.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">```cpp</p>
<p class="p_Normal">#pragma once</p>
<p class="p_Normal">// Ev6TLBInterface.h</p>
<p class="p_Normal">//</p>
<p class="p_Normal">// Layer-1 helper functions for EV6 TLB / SPAM access.</p>
<p class="p_Normal">// No templates in the interface; works purely in terms of AlphaPTE,</p>
<p class="p_Normal">// PFNs, ASN, and simple enums.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">#include &quot;Ev6PteSilicon.h&quot; &nbsp; // Ev6SiliconTLB, Ev6SPAMShardManager, etc.</p>
<p class="p_Normal">#include &quot;alpha_pte_core.h&quot; &nbsp;// Realm, PermMask</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">class Ev6TLBInterface</p>
<p class="p_Normal">{</p>
<p class="p_Normal">public:</p>
<p class="p_Normal"> &nbsp; &nbsp;explicit Ev6TLBInterface(int cpuCount)</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;: m_siliconTLB(cpuCount)</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;// Register CPUs if needed</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;m_siliconTLB.spam().registerCPUCount(cpuCount);</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;// -------------------------------------------------------------------</p>
<p class="p_Normal"> &nbsp; &nbsp;// DTB interface (Data TLB)</p>
<p class="p_Normal"> &nbsp; &nbsp;// -------------------------------------------------------------------</p>
<p class="p_Normal"> &nbsp; &nbsp;bool lookupDTB(quint16 cpuId,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; quint64 va,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; quint8 &nbsp;asn,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; quint32 &amp;outPfn,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PermMask &amp;outPermMask) const noexcept</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;return m_siliconTLB.spam().tlbLookup(</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;cpuId,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Realm::D,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/*sizeClass*/ 0, &nbsp;// base page size class for now</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;va,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;asn,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;outPfn,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;outPermMask</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;);</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;bool insertDTB(quint16 cpuId,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; quint64 va,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; quint8 &nbsp;asn,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; const AlphaPTE &amp;pte,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bool global = false) noexcept</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;return m_siliconTLB.spam().tlbInsert(</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;cpuId,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Realm::D,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/*sizeClass*/ 0,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;va,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;asn,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;global,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pte</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;);</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;// -------------------------------------------------------------------</p>
<p class="p_Normal"> &nbsp; &nbsp;// ITB interface (Instruction TLB)</p>
<p class="p_Normal"> &nbsp; &nbsp;// -------------------------------------------------------------------</p>
<p class="p_Normal"> &nbsp; &nbsp;bool lookupITB(quint16 cpuId,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; quint64 va,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; quint8 &nbsp;asn,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; quint32 &amp;outPfn,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PermMask &amp;outPermMask) const noexcept</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;return m_siliconTLB.spam().tlbLookup(</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;cpuId,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Realm::I,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/*sizeClass*/ 0,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;va,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;asn,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;outPfn,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;outPermMask</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;);</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;bool insertITB(quint16 cpuId,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; quint64 va,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; quint8 &nbsp;asn,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; const AlphaPTE &amp;pte,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bool global = false) noexcept</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;return m_siliconTLB.spam().tlbInsert(</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;cpuId,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Realm::I,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/*sizeClass*/ 0,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;va,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;asn,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;global,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pte</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;);</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;// -------------------------------------------------------------------</p>
<p class="p_Normal"> &nbsp; &nbsp;// Invalidation hooks – these are what TBIS/TBIA/TBIAP will call.</p>
<p class="p_Normal"> &nbsp; &nbsp;// -------------------------------------------------------------------</p>
<p class="p_Normal"> &nbsp; &nbsp;void tbiVA(quint16 cpuId, quint64 va, Realm realm, quint8 asn) noexcept</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;m_siliconTLB.spam().invalidateVA(cpuId, realm, /*sizeClass*/ 0, va, asn);</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;void tbiAll(quint16 cpuId) noexcept</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;m_siliconTLB.spam().invalidateAll(cpuId);</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;void tbiASN(quint16 cpuId, quint8 asn) noexcept</p>
<p class="p_Normal"> &nbsp; &nbsp;{</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;m_siliconTLB.spam().invalidateASN(cpuId, asn);</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;// -------------------------------------------------------------------</p>
<p class="p_Normal"> &nbsp; &nbsp;// Access to underlying &quot;silicon&quot; if you need it for debug</p>
<p class="p_Normal"> &nbsp; &nbsp;// -------------------------------------------------------------------</p>
<p class="p_Normal"> &nbsp; &nbsp;Ev6SiliconTLB &nbsp; &nbsp; &nbsp; &amp;siliconTLB() &nbsp; &nbsp; &nbsp; noexcept { return m_siliconTLB; }</p>
<p class="p_Normal"> &nbsp; &nbsp;const Ev6SiliconTLB &amp;siliconTLB() const noexcept { return m_siliconTLB; }</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">private:</p>
<p class="p_Normal"> &nbsp; &nbsp;Ev6SiliconTLB m_siliconTLB;</p>
<p class="p_Normal">};</p>
<p class="p_Normal">```</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&gt; **Note:** The methods `tlbLookup`, `tlbInsert`, `invalidateVA`, `invalidateAll`, `invalidateASN`, and `registerCPUCount` are already present or easy to add in your `SPAMShardManager` (if a couple are missing, we can trivially add them next).</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">This gives you a **clean, non-templated interface** that your PAL / TBI code can call:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">* TBI hooks execute **Layer-1** (`Ev6TLBInterface::tbiVA/tbiAll/tbiASN`).</p>
<p class="p_Normal">* MFPR/MTPR handlers for ITB/DTB PTE/TAG registers can:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp;* Use EV6 register helpers (`ev6_ItbPteRead_Register`, `ev6_DtbPteTempRegister`, etc.)</p>
<p class="p_Normal"> &nbsp;* Populate an `AlphaPTE`</p>
<p class="p_Normal"> &nbsp;* Call `insertITB/insertDTB` on this interface.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">---</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">## 4. How this matches your request</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">You asked for:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&gt; * preserve the structure of the PTE</p>
<p class="p_Normal">&gt; * support cache pipelines (banks) and SMP</p>
<p class="p_Normal">&gt; * remove or hide trait/templates</p>
<p class="p_Normal">&gt; * only EV6 for now</p>
<p class="p_Normal">&gt; * inject VA size / page sizes from config</p>
<p class="p_Normal">&gt; * have a “silicon” Layer-0 with Layer-1 helpers</p>
<p class="p_Normal">&gt; * TBI hooks at Layer-1, MFPR/MTPR maybe at Layer-2</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">What we just did:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">* **PTE structure is untouched** (`AlphaPTE_Core.h` is still canonical).</p>
<p class="p_Normal">* **Banks/SMP behavior is preserved**:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp;* `SPAMBucket` and `SPAMShardManager` remain your original code.</p>
<p class="p_Normal"> &nbsp;* We just instantiate them once for `Ev6PTETraits`.</p>
<p class="p_Normal">* **Templates and Traits are hidden**:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp;* Outside `Ev6PteSilicon.h`, you never mention `Traits`, template parameters, or `SPAMBucket&lt;...&gt;`.</p>
<p class="p_Normal"> &nbsp;* You just use `Ev6SPAMShardManager` and `Ev6TLBInterface`.</p>
<p class="p_Normal">* **EV6-only**: the traits struct is `Ev6PTETraits`; no EV4/EV5 special-casing.</p>
<p class="p_Normal">* **Page size config** is centralized in `Ev6SiliconConfig`, which can be fed from your JSON config.</p>
<p class="p_Normal">* **Layer-0 / Layer-1** separation is explicit:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp;* L0: `Ev6PteSilicon.h`</p>
<p class="p_Normal"> &nbsp;* L1: `Ev6TLBInterface.h`</p>
<p class="p_Normal">* **TBI hooks** naturally map onto L1.</p>
<p class="p_Normal">* **MFPR/MTPR** for ITB/DTB can either:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp;* Use L1 directly, or</p>
<p class="p_Normal"> &nbsp;* Sit in a small L2 wrapper that also handles IPR access, logging, etc.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">---</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">If you’d like, next step I can:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">* Wire **concrete `tbi` PAL handlers** that call this interface.</p>
<p class="p_Normal">* Show how `MTPR ITB_PTE` / `MTPR DTB_PTE` decode EV6 register images into `AlphaPTE` using your existing `alpha_pte_traits_ev6_*` helpers and then call `insertITB/insertDTB`.</p>
<p class="p_Normal">* Add explicit page-size class handling for 16K/32K if you decide those should be “silicon-supported” modes and how to tie them into `Ev6VMConfig`.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">But the core “EV6-only silicon” plus non-templated API is now laid out.</p>
<p class="p_Normal">&nbsp;</p>

<!--ZOOMSTOP-->
</div></div>
<script type="text/javascript">

  

  $(document).ready(function(){
    $(window).bind('resize', function() {
      var y = $('#idheader').height(); 
      $('#idcontent').css('margin-top', y);
      var par = window.parent;
      if ($( par ).width() <= $( window ).width()+20) {
        $('#idheader').css('position', 'relative');
        $('#idcontent').css('margin-top', 0);
        $('#idbacktotop').css('display', 'block');
        $('.hmanchor').css('margin-top', -20);
	$('.hmanchor').css('padding-top', 20);
      }
      else {
        $('#idheader').css('position', 'fixed');
        $('#idcontent').css('margin-top', $('#idheader').height());
        $('#idbacktotop').css('display', 'none');
        $('.hmanchor').css('margin-top', -y-20);
	$('.hmanchor').css('padding-top', y+20);
      }
    });
    
    $(window).resize(); //trigger event for initially small displays
  });

if ((!parent.hmNavigationFrame) && (parent.location) && (parent.location.href)) { $('.sync-toc').show();$('p.crumbs').hide();}

</script>
</body>
</html>
