<!DOCTYPE html>
<html>
<head>
   <title>Introduction &gt; Architecture Overview &gt; Chapter 14 – Execution Domains (“Boxes”) &gt; 14.5 CBox – Cache / Control Box</title>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />   
   <meta http-equiv="X-UA-Compatible" content="IE=edge" />
   <meta name="generator" content="Help &amp; Manual" />
   <meta name="keywords" content="" />
   <meta name="description" content="The CBox manages the cache subsystem, write buffering, memory barriers, branch prediction, and control-flow transfer instructions. On the 21264, the Cbox controlled the L2..." />
   <link type="text/css" href="default.css" rel="stylesheet" />
   <link type="text/css" href="custom.css" rel="stylesheet" />

   <style TYPE="text/css" media="screen"> 
      html, body { margin:0; 
        padding:0; 
        background: #ffffff; 
      } 
      div#printheader { display: none; }
      #idheader { 
        width:100%; 
        min-height: 60px; 
        padding: 0; 
        margin: 0;
        position: fixed;
        top: 0;
        background: #F0F0F0;
        z-index: 2;
      } 
      /* The "min-height" for "#idheader table" ensures that the (blue) header of the topic
         has at least the same height as the header of the navigation panel left of it */
      #idheader table { min-height: 59px;}             
      #idheader h1 span { color: #000000 }     
      #idnav {
        text-align: right;
        width: 126px;
        vertical-align: middle;        
      } 
      #idnav a { text-decoration: none }
      #idnav span {
        display: inline-block;
        width: 24px;
        height: 24px;
        margin-left: 4px;
        background:url('hm_webhelp_buttons_white.png') top left no-repeat;
      } 
      #idnav a span {
        background-image:url('hm_webhelp_buttons_grey.png');
      } 
      #idnav a span:hover {
        background-image:url('hm_webhelp_buttons_yellow.png');
      } 
      #idnav span.hmbtnprev { background-position: 0 -32px }
      #idnav span.hmbtnnext { background-position: -24px -32px }
      #idnav span.hmbtntop  { background-position: -48px -32px }
      #idnav span.hmbtntoggle  { width: 20px; background-position: -70px -32px }
      #idnav span.hmbtnprint  { background-position: -88px -32px }

      #callout-table, #overview-table {display:block; position:relative; top:0; left:0;}
      #callout-icon {display:block; position:absolute; top:-11px; left:-11px;}
      #callout-icon-flag {display:block; position:absolute; top:-11px; left:-8px;}
      #callout-table a {text-decoration: none; color: blue;}
      #callout-table a:visited {text-decoration: none; color: blue;}
      #overview-table a {text-decoration: none; color: black;}
      #overview-table a:visited {text-decoration: none; color: black;}
      #callout-table a:hover, #overview-table a:hover {text-decoration: underline;}       
      p.help-url { margin: 20px 0 5px 0; text-align: center; }
	  p.help-url a:link { font-size: 50%; text-decoration: none; color: black; }
	  p.help-url a:visited { color: black; }
	  p.help-url a:hover { font-size: 95%; text-decoration: underline; }
      #switchtoggles { text-align: right; padding: 0 2px 0 0; font-size: 90%; } 
      .sync-toc { color: #000000; font-size: 8pt; font-weight: bold; display: none; }
      .sync-toc a { color: #000000; text-decoration: none; font-weight: bold;}
      .sync-toc a:visited { color: #000000; }
      .sync-toc a:hover { text-decoration: underline; }
	  a#printbuttonlink { cursor: pointer; }
      a.hmanchor { display: inline-block; margin-top: -4em; padding-top: 4em; }  
   </style>
   <style TYPE="text/css" media="print">
      div#idheader, img.dropdown-toggle-icon, p.help-url { display:none } 
   </style>
   
   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>

   <script type="text/javascript">
     HMSyncTOC("index.html", "14_5-cbox---cache-_-control-bo.html");
   </script>
   <script type="text/javascript" src="highlight.js"></script>
   <script type="text/javascript">
     $(document).ready(function(){highlight();});
   </script>
</head>
<body>


<div id="printheader"><h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">14.5 CBox – Cache / Control Box</span></h1>
</div>
<div id="idheader">
<div id="idheaderbg">
<table style="width:100%;border:none;margin:0px;" cellspacing="0" cellpadding="0"> 
  <tr>
    <td class="topichead" style="text-align:left; vertical-align:middle">
      <p class="sync-toc">&lt;&lt; <a rel="nofollow" href="index.html?14_5-cbox---cache-_-control-bo.html" target="_top">Click to Display Table of Contents</a> &gt;&gt;</p>
      <p class="crumbs"><b>Navigation:</b>&nbsp;
      
      <a href="introduction.html">Introduction</a> &gt; <a href="architecture-overview.html">Architecture Overview</a> &gt; <a href="chapter-14---execution-domains.html">Chapter 14 – Execution Domains (“Boxes”)</a>&nbsp;&gt;</p>
   
      <h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">14.5 CBox – Cache / Control Box</span></h1>

    </td>
    <td class="topichead" id="idnav">
      
      <a href="14_4-mbox---memory-box.html" title="Previous Topic"><span class="hmbtnprev"></span></a>
      <a href="chapter-14---execution-domains.html" title="Parent Chapter"><span class="hmbtntop"></span></a>
      <a href="14_6-palbox---privileged-archi.html" title="Next Topic"><span class="hmbtnnext"></span></a>
      
    </td>
  </tr>  
</table>
</div>
</div>  

<div id="idcontent"><div id="innerdiv">
<!-- Ask Internet Explorer 6.users to update their obsolete and dangerous browser --> 
<!--[if lt IE 7]><div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;'><a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." /></a></div><![endif]-->

<!--ZOOMRESTART-->
<p class="p_Normal">The CBox manages the cache subsystem, write buffering, memory barriers, branch prediction, and control-flow transfer instructions. On the 21264, the Cbox controlled the L2 cache, the system bus interface, probe handling, and write buffer draining. In EmulatR, the CBox serves as the pipeline's control-flow and memory-ordering authority, coordinating write buffer commits to <span class="f_CodeExample">GuestMemory</span>, enforcing MB/WMB/TRAPB/EXCB serialization semantics, and housing the branch predictor.</p>
<p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">14.5.1 Responsibilities</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>Write buffer management: queueing, draining, and committing deferred stores to GuestMemory</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>Memory barriers: MB (full barrier), WMB (write barrier), TRAPB (trap barrier), EXCB (exception barrier)</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>Branch prediction: 2-bit saturating counter BHT (<span class="f_CodeExample">BranchPredictor</span>), prediction, update, flush</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>Control-flow instructions: BR, BSR, BEQ, BNE, BLT, BLE, BGT, BGE, BLBC, BLBS, FBEQ, FBNE, FBLT, FBLE, FBGT, FBGE</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>Jump instructions: JMP, JSR, RET, JSR_COROUTINE (via Rb-based indirect target)</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>Cache maintenance: ECB (evict cache block), FETCH, FETCH_M</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>Cycle counter: RPCC (read process cycle counter)</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>HALT execution and halt-callback notification</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>MMIO completion tracking</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>IPR management: Process Context Block Base (PCBB) pointer updates, staged IPR write commits</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">14.5.2 CBox State Machine</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">The CBox operates in one of three states, defined by the <span class="f_CodeExample">CBoxState</span> enumeration:</p>
<p class="p_Normal">&nbsp;</p>
<div style="text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;"><table style="border:none; border-spacing:0; border-collapse:collapse;">
<thead>
<tr>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">State</span></p>
</th>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Description</span></p>
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">RUNNING</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Normal execution; write buffer accepts new entries and drains opportunistically</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">SERIALIZING</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Memory barrier in progress; pipeline stalls until write buffer drains and barrier completes</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">HALTED</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Terminal state entered via HALT instruction or fatal error; no further execution</p>
</td>
</tr>
</tbody>
</table>
</div>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">14.5.3 Branch Prediction</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">The CBox contains an instance of <span class="f_CodeExample">BranchPredictor</span>, which implements a 2-way set-associative branch history table using 2-bit saturating counters (strongly not-taken / weakly not-taken / weakly taken / strongly taken). The predictor supports three strategies selectable via the ICCSR register: <span class="f_CodeExample">NeverTaken</span> (always predict fall-through), <span class="f_CodeExample">DisplacementBased</span> (predict taken for negative displacement, not-taken for positive), and <span class="f_CodeExample">HistoryTable</span> (full 2-bit counter prediction). On each branch resolution, the CBox calls <span class="f_CodeExample">updatePrediction()</span> to train the counter.</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">14.5.4 Serialization Types</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">The <span class="f_CodeExample">cBox_core.h</span> file defines the <span class="f_CodeExample">SerializationType</span> enumeration used to classify barrier semantics:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_CodeExample"><span class="f_CodeExample">enum&nbsp;class&nbsp;SerializationType&nbsp;{</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;Barrier_MB,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;MB&nbsp;&nbsp;–&nbsp;Full&nbsp;memory&nbsp;barrier</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;Barrier_TRAP,&nbsp;&nbsp;&nbsp;//&nbsp;TRAPB&nbsp;–&nbsp;Trap&nbsp;barrier</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;Barrier_WRITE,&nbsp;&nbsp;//&nbsp;WMB&nbsp;–&nbsp;Write&nbsp;memory&nbsp;barrier</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;Barrier_EXC,&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;EXCB&nbsp;–&nbsp;Exception&nbsp;barrier</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;Barrier_NONE&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;No&nbsp;serialization</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">};</span></p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">14.5.5 Source Files</span></h2>
<p class="p_Normal">&nbsp;</p>
<div style="text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;"><table style="border:none; border-spacing:0; border-collapse:collapse;">
<thead>
<tr>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">File</span></p>
</th>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Lines (approx)</span></p>
</th>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Content</span></p>
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">CBoxLib/CBoxBase.h</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">~1,345</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">CBox class: write buffer, barriers, branches, jumps, halt, cache ops</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">CBoxLib/BranchPredictor.h</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">~258</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">BranchPredictor class: BHT, 2-bit saturating counters, prediction strategies</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">CBoxLib/cBox_core.h</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">~28</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">SerializationType enumeration</p>
</td>
</tr>
</tbody>
</table>
</div>
<p class="p_Normal">&nbsp;</p>
<p class="p_SeeAlso" style="page-break-after: avoid;"><span class="f_SeeAlso">See Also: memoryLib/WriteBufferManager.h – Write buffer queueing and drain logic; memoryLib/global_MemoryBarrierCoordinator.h – Cross-CPU barrier coordination; coreLib/WriteBufferEntry.h – Individual write buffer entry structure; mmioLib/global_mmioManager.h – MMIO dispatch and completion.</span></p>

<!--ZOOMSTOP-->
</div></div>
<script type="text/javascript">



function normHeaders() {
 var topicHeadHeight =  $("#idheaderbg > table").first().height() + 1,
	 $topicHeaderBox = $("#idheader"),
	 $topicContentBox = $("#idcontent"),
	 $navHeader = $("#navbar", parent.document),			 
	$navBox = $("div#hmnavframe", parent.document),
	 navHeaderHeight = $navHeader.height();
 if (topicHeadHeight != navHeaderHeight) {
	 $navHeader.css("height",topicHeadHeight + "px");
	 $navBox.css("top", topicHeadHeight + "px");
	 $topicHeaderBox.css("height", topicHeadHeight + "px");
		if ($topicHeaderBox.css("position") == "fixed"){
			$topicContentBox.css("margin-top", topicHeadHeight + "px");
			}
		}
    }
			 
  $(document).ready(function(){
    $(window).on('resize', function() {
      var y = $('#idheader').height(); 
      $('#idcontent').css('margin-top', y);
      var par = window.parent;
      if ($( par ).width() <= $( window ).width()+20) {
        $('#idheader').css('position', 'relative');
        $('#idcontent').css('margin-top', 0);
        $('#idbacktotop').css('display', 'block');
        $('.hmanchor').css('margin-top', -20);
	$('.hmanchor').css('padding-top', 20);
      }
      else {
        $('#idheader').css('position', 'fixed');
        $('#idcontent').css('margin-top', $('#idheader').height());
        $('#idbacktotop').css('display', 'none');
        $('.hmanchor').css('margin-top', -y-20);
		$('.hmanchor').css('padding-top', y+20);
		$("div#hmsplitter", parent.document).css('width', '3px');
      }
	normHeaders();
    });
    
	 $(window).resize(); //trigger event for initially small displays
  });
 

if ((!parent.hmNavigationFrame) && (parent.location) && (parent.location.href)) { $('.sync-toc').show();$('p.crumbs').hide();}

</script>
</body>
</html>
