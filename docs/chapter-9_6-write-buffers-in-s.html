<!DOCTYPE html>
<html>
<head>
   <title>Introduction &gt; Architecture Overview &gt; Chapter 9 - SMP Architecture &gt; 9.6 Inter-Processor Interrupts (IPIs)</title>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />   
   <meta http-equiv="X-UA-Compatible" content="IE=edge" />
   <meta name="generator" content="Help &amp; Manual" />
   <meta name="keywords" content="" />
   <meta name="description" content="9.6.1 Purpose &nbsp;IPIs are the primary SMP coordination mechanism. They are used for TLB shootdowns, cache invalidation coordination, memory barrier completion signaling, CPU..." />
   <link type="text/css" href="default.css" rel="stylesheet" />
   <link type="text/css" href="custom.css" rel="stylesheet" />

   <style TYPE="text/css" media="screen"> 
      html, body { margin:0; 
        padding:0; 
        background: #ffffff; 
      } 
      div#printheader { display: none; }
      #idheader { 
        width:100%; 
        min-height: 60px; 
        padding: 0; 
        margin: 0;
        position: fixed;
        top: 0;
        background: #F0F0F0;
        z-index: 2;
      } 
      /* The "min-height" for "#idheader table" ensures that the (blue) header of the topic
         has at least the same height as the header of the navigation panel left of it */
      #idheader table { min-height: 59px;}             
      #idheader h1 span { color: #000000 }     
      #idnav {
        text-align: right;
        width: 126px;
        vertical-align: middle;        
      } 
      #idnav a { text-decoration: none }
      #idnav span {
        display: inline-block;
        width: 24px;
        height: 24px;
        margin-left: 4px;
        background:url('hm_webhelp_buttons_white.png') top left no-repeat;
      } 
      #idnav a span {
        background-image:url('hm_webhelp_buttons_grey.png');
      } 
      #idnav a span:hover {
        background-image:url('hm_webhelp_buttons_yellow.png');
      } 
      #idnav span.hmbtnprev { background-position: 0 -32px }
      #idnav span.hmbtnnext { background-position: -24px -32px }
      #idnav span.hmbtntop  { background-position: -48px -32px }
      #idnav span.hmbtntoggle  { width: 20px; background-position: -70px -32px }
      #idnav span.hmbtnprint  { background-position: -88px -32px }

      #callout-table, #overview-table {display:block; position:relative; top:0; left:0;}
      #callout-icon {display:block; position:absolute; top:-11px; left:-11px;}
      #callout-icon-flag {display:block; position:absolute; top:-11px; left:-8px;}
      #callout-table a {text-decoration: none; color: blue;}
      #callout-table a:visited {text-decoration: none; color: blue;}
      #overview-table a {text-decoration: none; color: black;}
      #overview-table a:visited {text-decoration: none; color: black;}
      #callout-table a:hover, #overview-table a:hover {text-decoration: underline;}       
      p.help-url { margin: 20px 0 5px 0; text-align: center; }
	  p.help-url a:link { font-size: 50%; text-decoration: none; color: black; }
	  p.help-url a:visited { color: black; }
	  p.help-url a:hover { font-size: 95%; text-decoration: underline; }
      #switchtoggles { text-align: right; padding: 0 2px 0 0; font-size: 90%; } 
      .sync-toc { color: #000000; font-size: 8pt; font-weight: bold; display: none; }
      .sync-toc a { color: #000000; text-decoration: none; font-weight: bold;}
      .sync-toc a:visited { color: #000000; }
      .sync-toc a:hover { text-decoration: underline; }
	  a#printbuttonlink { cursor: pointer; }
      a.hmanchor { display: inline-block; margin-top: -4em; padding-top: 4em; }  
   </style>
   <style TYPE="text/css" media="print">
      div#idheader, img.dropdown-toggle-icon, p.help-url { display:none } 
   </style>
   
   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>

   <script type="text/javascript">
     HMSyncTOC("index.html", "chapter-9_6-write-buffers-in-s.html");
   </script>
   <script type="text/javascript" src="highlight.js"></script>
   <script type="text/javascript">
     $(document).ready(function(){highlight();});
   </script>
</head>
<body>


<div id="printheader"><h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">9.6 Inter-Processor Interrupts (IPIs)</span></h1>
</div>
<div id="idheader">
<div id="idheaderbg">
<table style="width:100%;border:none;margin:0px;" cellspacing="0" cellpadding="0"> 
  <tr>
    <td class="topichead" style="text-align:left; vertical-align:middle">
      <p class="sync-toc">&lt;&lt; <a rel="nofollow" href="index.html?chapter-9_6-write-buffers-in-s.html" target="_top">Click to Display Table of Contents</a> &gt;&gt;</p>
      <p class="crumbs"><b>Navigation:</b>&nbsp;
      
      <a href="introduction.html">Introduction</a> &gt; <a href="architecture-overview.html">Architecture Overview</a> &gt; <a href="chapter9-smparchitecture.html">Chapter 9 - SMP Architecture</a>&nbsp;&gt;</p>
   
      <h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">9.6 Inter-Processor Interrupts (IPIs)</span></h1>

    </td>
    <td class="topichead" id="idnav">
      
      <a href="chapter-9_5-memory-visibility-.html" title="Previous Topic"><span class="hmbtnprev"></span></a>
      <a href="chapter9-smparchitecture.html" title="Parent Chapter"><span class="hmbtntop"></span></a>
      <a href="chapter-9_7-reservation-invali.html" title="Next Topic"><span class="hmbtnnext"></span></a>
      
    </td>
  </tr>  
</table>
</div>
</div>  

<div id="idcontent"><div id="innerdiv">
<!-- Ask Internet Explorer 6.users to update their obsolete and dangerous browser --> 
<!--[if lt IE 7]><div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;'><a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." /></a></div><![endif]-->

<!--ZOOMRESTART-->
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">9.6.1 Purpose</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">IPIs are the primary SMP coordination mechanism. They are used for TLB shootdowns, cache invalidation coordination, memory barrier completion signaling, CPU halt/wake, context switch requests, and cross-CPU synchronization.</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">9.6.2 IPICommand Enumeration</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">IPI commands are defined by IPICommand (IPI_core.h, 245 lines). The full command set is organized by function:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_CodeExample"><span class="f_CodeExample">enum&nbsp;class&nbsp;IPICommand&nbsp;:&nbsp;quint8&nbsp;{</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;INVALID&nbsp;=&nbsp;0x00,</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;TLB&nbsp;Invalidation&nbsp;(0x01–0x07)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;TLB_INVALIDATE_ALL&nbsp;=&nbsp;0x01,&nbsp;//&nbsp;TBIA:&nbsp;all&nbsp;TLBs,&nbsp;all&nbsp;ASNs</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;TLB_INVALIDATE_ASN&nbsp;=&nbsp;0x02,&nbsp;//&nbsp;TBIAP:&nbsp;by&nbsp;ASN&nbsp;(ITB+DTB)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;TLB_INVALIDATE_VA_BOTH&nbsp;=&nbsp;0x03,&nbsp;//&nbsp;TBIS:&nbsp;single&nbsp;VA&nbsp;(ITB+DTB)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;TLB_INVALIDATE_VA_ITB&nbsp;=&nbsp;0x04,&nbsp;//&nbsp;TBISI:&nbsp;single&nbsp;VA&nbsp;(ITB&nbsp;only)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;TLB_INVALIDATE_VA_DTB&nbsp;=&nbsp;0x05,&nbsp;//&nbsp;TBISD:&nbsp;single&nbsp;VA&nbsp;(DTB&nbsp;only)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;TLB_INVALIDATE_GLOBAL&nbsp;=&nbsp;0x06,&nbsp;//&nbsp;Reserved:&nbsp;global&nbsp;entries</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;TLB_INVALIDATE_RANGE&nbsp;=&nbsp;0x07,&nbsp;//&nbsp;Reserved:&nbsp;VA&nbsp;range</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;Cache&nbsp;Coherency&nbsp;(0x10–0x13)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;CACHE_INVALIDATE_LINE&nbsp;=&nbsp;0x10,&nbsp;//&nbsp;Invalidate&nbsp;cache&nbsp;line&nbsp;at&nbsp;PA</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;CACHE_FLUSH_LINE&nbsp;=&nbsp;0x11,&nbsp;//&nbsp;Write-back&nbsp;+&nbsp;invalidate</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;CACHE_EVICT_LINE&nbsp;=&nbsp;0x12,&nbsp;//&nbsp;ECB&nbsp;instruction</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;CACHE_INVALIDATE_ALL&nbsp;=&nbsp;0x13,&nbsp;//&nbsp;Invalidate&nbsp;all&nbsp;caches</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;Memory&nbsp;Barriers&nbsp;(0x20–0x22)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;MEMORY_BARRIER_FULL&nbsp;=&nbsp;0x20,&nbsp;//&nbsp;MB:&nbsp;full&nbsp;memory&nbsp;barrier</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;MEMORY_BARRIER_WRITE&nbsp;=&nbsp;0x21,&nbsp;//&nbsp;WMB:&nbsp;write&nbsp;memory&nbsp;barrier</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;MEMORY_BARRIER_READ&nbsp;=&nbsp;0x22,&nbsp;//&nbsp;Reserved:&nbsp;read&nbsp;barrier</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;Synchronization&nbsp;(0x30–0x31)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;SYNC_REQUEST&nbsp;=&nbsp;0x30,&nbsp;//&nbsp;Request&nbsp;sync&nbsp;point</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;SYNC_ACKNOWLEDGE&nbsp;=&nbsp;0x31,&nbsp;//&nbsp;Acknowledge&nbsp;sync</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;System&nbsp;Control&nbsp;(0x40–0x42)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;HALT_CPU&nbsp;=&nbsp;0x40,&nbsp;//&nbsp;Halt&nbsp;target&nbsp;CPU</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;WAKE_CPU&nbsp;=&nbsp;0x41,&nbsp;//&nbsp;Wake&nbsp;from&nbsp;halt</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;CONTEXT_SWITCH&nbsp;=&nbsp;0x42,&nbsp;//&nbsp;Remote&nbsp;context&nbsp;switch</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;Custom&nbsp;(0xF0–0xFF)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;CUSTOM_BASE&nbsp;=&nbsp;0xF0,&nbsp;//&nbsp;Custom&nbsp;command&nbsp;base</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;CUSTOM&nbsp;=&nbsp;0xFF&nbsp;//&nbsp;Generic&nbsp;custom&nbsp;IPI</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">};</span></p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">IPI data is encoded as a quint64: command byte in bits [63:56], parameter in bits [55:0]. Helper functions encodeIPIData(), encodeIPIWithVA(), encodeIPIWithASN(), decodeIPICommand(), decodeIPIVA(), and decodeIPIASN() handle encoding and decoding.</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">9.6.3 IPIManager</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">IPIManager (IPIManager.h, 192 lines) provides lock-free IPI message routing. Each CPU has an atomic IPI data slot (std::atomic&lt;quint64&gt;). Latest-IPI-wins semantics (Alpha behavior — posting overwrites any pending IPI).</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">Key API: postIPI(cpuId, ipiData) stores atomically with memory_order_release; fetchIPI(cpuId) atomically exchanges to zero with memory_order_acq_rel (read and clear); peekIPI(cpuId) reads without clearing; hasIPIPending(cpuId) checks for non-zero data.</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">9.6.4 Delivery Model</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">IPIs are generated by one CPU (via MTPR_IPIR or WRIPIR PAL instructions), routed via IPIManager (lock-free atomic slots), delivered to the target CPU as interrupts (sampled by checkInterrupts()), and handled in PAL mode on the target CPU. IPIs follow the same delivery rules as other interrupts — masked by IPL, delivered at instruction boundaries.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_SeeAlso" style="page-break-after: avoid;"><span class="f_SeeAlso">See Also: coreLib/IPI_core.h; emulatrLib/IPIManager.h.</span></p>

<!--ZOOMSTOP-->
</div></div>
<script type="text/javascript">



function normHeaders() {
 var topicHeadHeight =  $("#idheaderbg > table").first().height() + 1,
	 $topicHeaderBox = $("#idheader"),
	 $topicContentBox = $("#idcontent"),
	 $navHeader = $("#navbar", parent.document),			 
	$navBox = $("div#hmnavframe", parent.document),
	 navHeaderHeight = $navHeader.height();
 if (topicHeadHeight != navHeaderHeight) {
	 $navHeader.css("height",topicHeadHeight + "px");
	 $navBox.css("top", topicHeadHeight + "px");
	 $topicHeaderBox.css("height", topicHeadHeight + "px");
		if ($topicHeaderBox.css("position") == "fixed"){
			$topicContentBox.css("margin-top", topicHeadHeight + "px");
			}
		}
    }
			 
  $(document).ready(function(){
    $(window).on('resize', function() {
      var y = $('#idheader').height(); 
      $('#idcontent').css('margin-top', y);
      var par = window.parent;
      if ($( par ).width() <= $( window ).width()+20) {
        $('#idheader').css('position', 'relative');
        $('#idcontent').css('margin-top', 0);
        $('#idbacktotop').css('display', 'block');
        $('.hmanchor').css('margin-top', -20);
	$('.hmanchor').css('padding-top', 20);
      }
      else {
        $('#idheader').css('position', 'fixed');
        $('#idcontent').css('margin-top', $('#idheader').height());
        $('#idbacktotop').css('display', 'none');
        $('.hmanchor').css('margin-top', -y-20);
		$('.hmanchor').css('padding-top', y+20);
		$("div#hmsplitter", parent.document).css('width', '3px');
      }
	normHeaders();
    });
    
	 $(window).resize(); //trigger event for initially small displays
  });
 

if ((!parent.hmNavigationFrame) && (parent.location) && (parent.location.href)) { $('.sync-toc').show();$('p.crumbs').hide();}

</script>
</body>
</html>
