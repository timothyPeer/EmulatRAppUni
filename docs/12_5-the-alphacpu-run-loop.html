<!DOCTYPE html>
<html>
<head>
   <title>Introduction &gt; Architecture Overview &gt; Chapter 12 – AlphaCPU Core &gt; 12.5 The AlphaCPU Run Loop</title>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />   
   <meta http-equiv="X-UA-Compatible" content="IE=edge" />
   <meta name="generator" content="Help &amp; Manual" />
   <meta name="keywords" content="" />
   <meta name="description" content="12.5.1 executeLoop() &nbsp;The run loop (executeLoop() in AlphaCPU.cpp) is the clocked execution engine. Each iteration represents one hardware cycle. The loop structure: &nbsp;void Alph" />
   <link type="text/css" href="default.css" rel="stylesheet" />
   <link type="text/css" href="custom.css" rel="stylesheet" />

   <style TYPE="text/css" media="screen"> 
      html, body { margin:0; 
        padding:0; 
        background: #ffffff; 
      } 
      div#printheader { display: none; }
      #idheader { 
        width:100%; 
        min-height: 60px; 
        padding: 0; 
        margin: 0;
        position: fixed;
        top: 0;
        background: #F0F0F0;
        z-index: 2;
      } 
      /* The "min-height" for "#idheader table" ensures that the (blue) header of the topic
         has at least the same height as the header of the navigation panel left of it */
      #idheader table { min-height: 59px;}             
      #idheader h1 span { color: #000000 }     
      #idnav {
        text-align: right;
        width: 126px;
        vertical-align: middle;        
      } 
      #idnav a { text-decoration: none }
      #idnav span {
        display: inline-block;
        width: 24px;
        height: 24px;
        margin-left: 4px;
        background:url('hm_webhelp_buttons_white.png') top left no-repeat;
      } 
      #idnav a span {
        background-image:url('hm_webhelp_buttons_grey.png');
      } 
      #idnav a span:hover {
        background-image:url('hm_webhelp_buttons_yellow.png');
      } 
      #idnav span.hmbtnprev { background-position: 0 -32px }
      #idnav span.hmbtnnext { background-position: -24px -32px }
      #idnav span.hmbtntop  { background-position: -48px -32px }
      #idnav span.hmbtntoggle  { width: 20px; background-position: -70px -32px }
      #idnav span.hmbtnprint  { background-position: -88px -32px }

      #callout-table, #overview-table {display:block; position:relative; top:0; left:0;}
      #callout-icon {display:block; position:absolute; top:-11px; left:-11px;}
      #callout-icon-flag {display:block; position:absolute; top:-11px; left:-8px;}
      #callout-table a {text-decoration: none; color: blue;}
      #callout-table a:visited {text-decoration: none; color: blue;}
      #overview-table a {text-decoration: none; color: black;}
      #overview-table a:visited {text-decoration: none; color: black;}
      #callout-table a:hover, #overview-table a:hover {text-decoration: underline;}       
      p.help-url { margin: 20px 0 5px 0; text-align: center; }
	  p.help-url a:link { font-size: 50%; text-decoration: none; color: black; }
	  p.help-url a:visited { color: black; }
	  p.help-url a:hover { font-size: 95%; text-decoration: underline; }
      #switchtoggles { text-align: right; padding: 0 2px 0 0; font-size: 90%; } 
      .sync-toc { color: #000000; font-size: 8pt; font-weight: bold; display: none; }
      .sync-toc a { color: #000000; text-decoration: none; font-weight: bold;}
      .sync-toc a:visited { color: #000000; }
      .sync-toc a:hover { text-decoration: underline; }
	  a#printbuttonlink { cursor: pointer; }
      a.hmanchor { display: inline-block; margin-top: -4em; padding-top: 4em; }  
   </style>
   <style TYPE="text/css" media="print">
      div#idheader, img.dropdown-toggle-icon, p.help-url { display:none } 
   </style>
   
   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>

   <script type="text/javascript">
     HMSyncTOC("index.html", "12_5-the-alphacpu-run-loop.html");
   </script>
   <script type="text/javascript" src="highlight.js"></script>
   <script type="text/javascript">
     $(document).ready(function(){highlight();});
   </script>
</head>
<body>


<div id="printheader"><h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">12.5 The AlphaCPU Run Loop</span></h1>
</div>
<div id="idheader">
<div id="idheaderbg">
<table style="width:100%;border:none;margin:0px;" cellspacing="0" cellpadding="0"> 
  <tr>
    <td class="topichead" style="text-align:left; vertical-align:middle">
      <p class="sync-toc">&lt;&lt; <a rel="nofollow" href="index.html?12_5-the-alphacpu-run-loop.html" target="_top">Click to Display Table of Contents</a> &gt;&gt;</p>
      <p class="crumbs"><b>Navigation:</b>&nbsp;
      
      <a href="introduction.html">Introduction</a> &gt; <a href="architecture-overview.html">Architecture Overview</a> &gt; <a href="alphacpu-core.html">Chapter 12 – AlphaCPU Core</a>&nbsp;&gt;</p>
   
      <h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">12.5 The AlphaCPU Run Loop</span></h1>

    </td>
    <td class="topichead" id="idnav">
      
      <a href="12_4-cpu-lifecycle.html" title="Previous Topic"><span class="hmbtnprev"></span></a>
      <a href="alphacpu-core.html" title="Parent Chapter"><span class="hmbtntop"></span></a>
      <a href="12_6-pipeline-integration.html" title="Next Topic"><span class="hmbtnnext"></span></a>
      
    </td>
  </tr>  
</table>
</div>
</div>  

<div id="idcontent"><div id="innerdiv">
<!-- Ask Internet Explorer 6.users to update their obsolete and dangerous browser --> 
<!--[if lt IE 7]><div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;'><a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." /></a></div><![endif]-->

<!--ZOOMRESTART-->
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">12.5.1 executeLoop()</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">The run loop (executeLoop() in AlphaCPU.cpp) is the clocked execution engine. Each iteration represents one hardware cycle. The loop structure:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_CodeExample"><span class="f_CodeExample">void&nbsp;AlphaCPU::executeLoop()&nbsp;{</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;m_running.store(true);</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;m_alphaPipeline-&gt;injectOtherBoxes(m_eBox,&nbsp;m_fBox,&nbsp;m_mBox,&nbsp;m_pBox,&nbsp;m_cBox);</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;while&nbsp;(!m_stopRequested.load())&nbsp;{</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;if&nbsp;(m_paused.load())&nbsp;{&nbsp;QThread::msleep(1);&nbsp;continue;&nbsp;}</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;if&nbsp;(m_halted.load())&nbsp;{&nbsp;QThread::msleep(10);</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;if&nbsp;(checkForWakeup())&nbsp;m_halted.store(false);</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;continue;&nbsp;}</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;runOneInstruction();&nbsp;//&nbsp;HOT&nbsp;PATH</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;++m_localInstrCount;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;}</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;shutdownGracefully();</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;m_running.store(false);</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">}</span></p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">Thread control uses three atomic flags: m_stopRequested (external shutdown), m_paused (pause/resume), m_halted (HALT instruction, wakes on interrupt). The halted state sleeps for 10ms between wakeup checks; the paused state sleeps for 1ms.</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">12.5.2 runOneInstruction()</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">The hot-path method that executes one complete instruction cycle:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_CodeExample"><span class="f_CodeExample">void&nbsp;runOneInstruction()&nbsp;{</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;1.&nbsp;Check&nbsp;for&nbsp;external&nbsp;events&nbsp;(interrupts)</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;if&nbsp;(m_pending-&gt;hasDeliverable(currentIPL))&nbsp;{</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;handleInterrupt();</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;return;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;}</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;2.&nbsp;Fetch&nbsp;and&nbsp;decode</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;FetchResult&nbsp;fetchResult&nbsp;=&nbsp;m_iBox-&gt;fetchNext();</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;3.&nbsp;Supply&nbsp;to&nbsp;pipeline</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;BoxResult&nbsp;boxResult&nbsp;=&nbsp;m_alphaPipeline-&gt;tick(fetchResult);</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;//&nbsp;4.&nbsp;Handle&nbsp;BoxResult&nbsp;flags</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;if&nbsp;(boxResult.hasFault()&nbsp;&amp;&amp;&nbsp;boxResult.faultWasDispatched())&nbsp;{</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;m_alphaPipeline-&gt;flush(&quot;flush::Box-faultWasDispatched&quot;);</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;m_pBox-&gt;enterPal(getFaultReason(...),&nbsp;vector,&nbsp;faultPC);</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;if&nbsp;(boxResult.needsWriteDrain())&nbsp;m_cBox-&gt;drainWriteBuffers();</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;if&nbsp;(boxResult.needsMemoryBarrier())&nbsp;m_cBox-&gt;issueMemoryBarrier(PAL);</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;if&nbsp;(boxResult.needsHalted())&nbsp;haltCPU();</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;}</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">}</span></p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">The four-step sequence: (1) check interrupts, (2) IBox fetch, (3) pipeline tick (advances all stages, returns BoxResult from EX), (4) handle result flags (faults → enterPal, drains, halts). Faults are only handled if faultWasDispatched() is true — meaning the faulting instruction reached WB stage retirement, preserving precise exception semantics.</p>
<p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">12.5.3 Run Loop Invariants</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">The run loop enforces: one cycle per iteration, deterministic ordering (interrupt check → fetch → tick → handle), no mid-instruction interruption (interrupt check is before fetch, not during execution), no speculative privilege leakage, and precise exception semantics (faults dispatched only from WB). The run loop is the only place where execution advances.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_SeeAlso" style="page-break-after: avoid;"><span class="f_SeeAlso">See Also: cpuCoreLib/AlphaCPU.cpp (executeLoop); cpuCoreLib/AlphaCPU.h (runOneInstruction).</span></p>

<!--ZOOMSTOP-->
</div></div>
<script type="text/javascript">



function normHeaders() {
 var topicHeadHeight =  $("#idheaderbg > table").first().height() + 1,
	 $topicHeaderBox = $("#idheader"),
	 $topicContentBox = $("#idcontent"),
	 $navHeader = $("#navbar", parent.document),			 
	$navBox = $("div#hmnavframe", parent.document),
	 navHeaderHeight = $navHeader.height();
 if (topicHeadHeight != navHeaderHeight) {
	 $navHeader.css("height",topicHeadHeight + "px");
	 $navBox.css("top", topicHeadHeight + "px");
	 $topicHeaderBox.css("height", topicHeadHeight + "px");
		if ($topicHeaderBox.css("position") == "fixed"){
			$topicContentBox.css("margin-top", topicHeadHeight + "px");
			}
		}
    }
			 
  $(document).ready(function(){
    $(window).on('resize', function() {
      var y = $('#idheader').height(); 
      $('#idcontent').css('margin-top', y);
      var par = window.parent;
      if ($( par ).width() <= $( window ).width()+20) {
        $('#idheader').css('position', 'relative');
        $('#idcontent').css('margin-top', 0);
        $('#idbacktotop').css('display', 'block');
        $('.hmanchor').css('margin-top', -20);
	$('.hmanchor').css('padding-top', 20);
      }
      else {
        $('#idheader').css('position', 'fixed');
        $('#idcontent').css('margin-top', $('#idheader').height());
        $('#idbacktotop').css('display', 'none');
        $('.hmanchor').css('margin-top', -y-20);
		$('.hmanchor').css('padding-top', y+20);
		$("div#hmsplitter", parent.document).css('width', '3px');
      }
	normHeaders();
    });
    
	 $(window).resize(); //trigger event for initially small displays
  });
 

if ((!parent.hmNavigationFrame) && (parent.location) && (parent.location.href)) { $('.sync-toc').show();$('p.crumbs').hide();}

</script>
</body>
</html>
