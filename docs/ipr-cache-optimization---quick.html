<!DOCTYPE html>
<html>
<head>
   <title>IPR Cache Optimization - Quick Reference</title>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />   
   <meta http-equiv="X-UA-Compatible" content="IE=edge" />
   <meta name="generator" content="Help &amp; Manual" />
   <meta name="keywords" content="" />
   <meta name="description" content="Architecture Overview &nbsp;┌─────────────────────────────────────────────────────────────┐ │ &nbsp;PerCpuIPRState (per CPU, cache-line isolated) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;│ ├────────────────────────" />
   <link type="text/css" href="default.css" rel="stylesheet" />
   <link type="text/css" href="custom.css" rel="stylesheet" />

   <style TYPE="text/css" media="screen"> 
      html, body { margin:0; 
        padding:0; 
        background: #ffffff; 
      } 
      div#printheader { display: none; }
      #idheader { 
        width:100%; 
        min-height: 60px; 
        padding: 0; 
        margin: 0;
        position: fixed;
        top: 0;
        background: #F0F0F0;
        z-index: 2;
      } 
      /* The "min-height" for "#idheader table" ensures that the (blue) header of the topic
         has at least the same height as the header of the navigation panel left of it */
      #idheader table { min-height: 59px;}             
      #idheader h1 span { color: #000000 }     
      #idnav {
        text-align: right;
        width: 126px;
        vertical-align: middle;        
      } 
      #idnav a { text-decoration: none }
      #idnav span {
        display: inline-block;
        width: 24px;
        height: 24px;
        margin-left: 4px;
        background:url('hm_webhelp_buttons_white.png') top left no-repeat;
      } 
      #idnav a span {
        background-image:url('hm_webhelp_buttons_grey.png');
      } 
      #idnav a span:hover {
        background-image:url('hm_webhelp_buttons_yellow.png');
      } 
      #idnav span.hmbtnprev { background-position: 0 -32px }
      #idnav span.hmbtnnext { background-position: -24px -32px }
      #idnav span.hmbtntop  { background-position: -48px -32px }
      #idnav span.hmbtntoggle  { width: 20px; background-position: -70px -32px }
      #idnav span.hmbtnprint  { background-position: -88px -32px }

      #callout-table, #overview-table {display:block; position:relative; top:0; left:0;}
      #callout-icon {display:block; position:absolute; top:-11px; left:-11px;}
      #callout-icon-flag {display:block; position:absolute; top:-11px; left:-8px;}
      #callout-table a {text-decoration: none; color: blue;}
      #callout-table a:visited {text-decoration: none; color: blue;}
      #overview-table a {text-decoration: none; color: black;}
      #overview-table a:visited {text-decoration: none; color: black;}
      #callout-table a:hover, #overview-table a:hover {text-decoration: underline;}       
      p.help-url { margin: 20px 0 5px 0; text-align: center; }
	  p.help-url a:link { font-size: 50%; text-decoration: none; color: black; }
	  p.help-url a:visited { color: black; }
	  p.help-url a:hover { font-size: 95%; text-decoration: underline; }
      #switchtoggles { text-align: right; padding: 0 2px 0 0; font-size: 90%; } 
      .sync-toc { color: #000000; font-size: 8pt; font-weight: bold; display: none; }
      .sync-toc a { color: #000000; text-decoration: none; font-weight: bold;}
      .sync-toc a:visited { color: #000000; }
      .sync-toc a:hover { text-decoration: underline; }
	  a#printbuttonlink { cursor: pointer; }
      a.hmanchor { display: inline-block; margin-top: -4em; padding-top: 4em; }  
   </style>
   <style TYPE="text/css" media="print">
      div#idheader, img.dropdown-toggle-icon, p.help-url { display:none } 
   </style>
   
   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>

   <script type="text/javascript">
     HMSyncTOC("index.html", "ipr-cache-optimization---quick.html");
   </script>
   <script type="text/javascript" src="highlight.js"></script>
   <script type="text/javascript">
     $(document).ready(function(){highlight();});
   </script>
</head>
<body>


<div id="printheader"><h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">IPR Cache Optimization - Quick Reference</span></h1>
</div>
<div id="idheader">
<div id="idheaderbg">
<table style="width:100%;border:none;margin:0px;" cellspacing="0" cellpadding="0"> 
  <tr>
    <td class="topichead" style="text-align:left; vertical-align:middle">
      <p class="sync-toc">&lt;&lt; <a rel="nofollow" href="index.html?ipr-cache-optimization---quick.html" target="_top">Click to Display Table of Contents</a> &gt;&gt;</p>
      <p class="crumbs"><b>Navigation:</b>&nbsp;
      &raquo;No topics above this level&laquo;
      </p>
   
      <h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">IPR Cache Optimization - Quick Reference</span></h1>

    </td>
    <td class="topichead" id="idnav">
      
      <span class="hmbtnprev"></span>
      <a href="appendix---trait-examples.html" title="Parent Chapter"><span class="hmbtntop"></span></a>
      <span class="hmbtnnext"></span>
      
    </td>
  </tr>  
</table>
</div>
</div>  

<div id="idcontent"><div id="innerdiv">
<!-- Ask Internet Explorer 6.users to update their obsolete and dangerous browser --> 
<!--[if lt IE 7]><div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;'><a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." /></a></div><![endif]-->

<!--ZOOMRESTART-->
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">Architecture Overview</span></h2>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">┌─────────────────────────────────────────────────────────────┐</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;PerCpuIPRState&nbsp;(per&nbsp;CPU,&nbsp;cache-line&nbsp;isolated)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">├─────────────────────────────────────────────────────────────┤</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;┌───────────────────────────────────────────┐&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;│&nbsp;IPRStorage_Hot64&nbsp;(64&nbsp;bytes,&nbsp;L1&nbsp;cache)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;←&nbsp;Every&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;│&nbsp;-&nbsp;ps,&nbsp;ipl,&nbsp;fpcr,&nbsp;pal_mode,&nbsp;asn,&nbsp;cc,&nbsp;cm&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;instr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;└───────────────────────────────────────────┘&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;┌───────────────────────────────────────────┐&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;│&nbsp;IPRStorage_HotExt&nbsp;(~512&nbsp;bytes,&nbsp;L2&nbsp;cache)&nbsp;&nbsp;│&nbsp;&nbsp;←&nbsp;Exception&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;│&nbsp;-&nbsp;va,&nbsp;exc_addr,&nbsp;ptbr,&nbsp;stacks,&nbsp;PAL&nbsp;temps&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;/PAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;└───────────────────────────────────────────┘&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;┌───────────────────────────────────────────┐&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;│&nbsp;IPRStorage_CBox&nbsp;(64&nbsp;bytes,&nbsp;isolated)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;←&nbsp;IRQ&nbsp;poll&nbsp;&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;│&nbsp;-&nbsp;irq_pending,&nbsp;ipir,&nbsp;ast&nbsp;(atomics)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;mailbox&nbsp;&nbsp;&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;└───────────────────────────────────────────┘&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;┌───────────────────────────────────────────┐&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;│&nbsp;IPRStorage_Cold&nbsp;(variable,&nbsp;L3/RAM)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;←&nbsp;Rare&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;│&nbsp;-&nbsp;mces,&nbsp;diagnostics,&nbsp;perf&nbsp;counters&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">│&nbsp;&nbsp;└───────────────────────────────────────────┘&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│</span></p>
<p class="p_CodeExample"><span class="f_CodeExample">└─────────────────────────────────────────────────────────────┘</span></p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">Quick API Reference</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">### OLD API (Backward Compatible)</p>
<p class="p_Normal">```cpp</p>
<p class="p_Normal">auto&amp; ipr = globalIPRHot(cpuId);</p>
<p class="p_Normal">ipr.fpcr() = value;</p>
<p class="p_Normal">ipr.va() = address;</p>
<p class="p_Normal">```</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">### NEW API (Cache Optimized)</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">**Hot path (every instruction):**</p>
<p class="p_Normal">```cpp</p>
<p class="p_Normal">auto&amp; hot = globalIPRHot64(cpuId);</p>
<p class="p_Normal">hot.fpcr = value;</p>
<p class="p_Normal">hot.setIPL(newIPL);</p>
<p class="p_Normal">if (hot.isInPalMode()) { ... }</p>
<p class="p_Normal">```</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">**Exception/PAL path:**</p>
<p class="p_Normal">```cpp</p>
<p class="p_Normal">auto&amp; ext = globalIPRHotExt(cpuId);</p>
<p class="p_Normal">ext.va = faultAddress;</p>
<p class="p_Normal">ext.exc_addr = exceptionPC;</p>
<p class="p_Normal">ext.setUSP(stackPtr);</p>
<p class="p_Normal">```</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">**Interrupt poll:**</p>
<p class="p_Normal">```cpp</p>
<p class="p_Normal">auto&amp; cbox = globalIPRCBox(cpuId);</p>
<p class="p_Normal">if (cbox.hasIRQPending()) {</p>
<p class="p_Normal"> &nbsp; &nbsp;handleIRQ(cbox.getPendingIPL());</p>
<p class="p_Normal">}</p>
<p class="p_Normal">```</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">**Cold/diagnostic:**</p>
<p class="p_Normal">```cpp</p>
<p class="p_Normal">auto&amp; cold = globalIPRCold(cpuId);</p>
<p class="p_Normal">cold.mces = status;</p>
<p class="p_Normal">cold.pmctr++;</p>
<p class="p_Normal">```</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">&nbsp;</span></h2>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">Field Location Map</span></h2>
<p class="p_CodeExample"><span class="f_CodeExample">&nbsp;</span></p>
<div style="text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;"><table style="border:none; border-spacing:0; border-collapse:collapse;">
<thead>
<tr>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Field</span></p>
</th>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Old Location</span></p>
</th>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">New Location</span></p>
</th>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Access Pattern</span></p>
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">ps</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot64</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Every instruction</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">ipl</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot64</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Every instruction</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">fpcr</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot64</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Every FP op</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">asn</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot64</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Every TLB lookup</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">cc</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot64</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Every instruction</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">cm</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot64</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Every mem access</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">va</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">HotExt</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Exception only</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">exc_addr</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">HotExt</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Exception only</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">ptbr</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">HotExt</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">TLB miss</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">stacks (usp/ksp/etc)</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">HotExt</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Mode switch</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">pal_temp[]</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">HotExt</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">PAL flows</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">irq_pending</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">CBox</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">IRQ poll</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">ipir</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Hot</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">CBox</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">IPI poll</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">mces</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Cold</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Cold</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Rare</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">pmctr</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Cold</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Cold</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Diagnostics</p>
</td>
</tr>
</tbody>
</table>
</div>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">Code Templates</span></h2>
<p class="p_Normal">&nbsp;</p>
<h3 class="p_Heading3" style="page-break-after: avoid;"><span class="f_Heading3">Template 1: Instruction Loop</span></h3>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">void executeInstructions(CPUIdType cpuId) {</p>
<p class="p_Normal"> &nbsp; &nbsp;// Bind Hot64 once - stays in L1 cache</p>
<p class="p_Normal"> &nbsp; &nbsp;auto&amp; hot = globalIPRHot64(cpuId);</p>
<p class="p_Normal"> &nbsp; &nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;for (int i = 0; i &lt; count; ++i) {</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;// All fields in same cache line</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;if (hot.getIPL() &gt; threshold) {</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;checkInterrupts(cpuId);</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;if (hot.fpcr &amp; FP_TRAP_ENABLE) {</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;checkFPExceptions();</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;hot.cc++; &nbsp;// Cycle counter</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;executeNextInstruction(cpuId);</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>
<h3 class="p_Heading3" style="page-break-after: avoid;"><span class="f_Heading3">Template 2: Exception Handler</span></h3>
<p class="p_Normal"><span class="f_Heading3">&nbsp;</span></p>
<p class="p_Normal">void handleMemoryFault(CPUIdType cpuId, quint64 faultVA) {</p>
<p class="p_Normal"> &nbsp; &nbsp;// HotExt fits in L2 cache</p>
<p class="p_Normal"> &nbsp; &nbsp;auto&amp; ext = globalIPRHotExt(cpuId);</p>
<p class="p_Normal"> &nbsp; &nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;ext.va = faultVA;</p>
<p class="p_Normal"> &nbsp; &nbsp;ext.exc_addr = getCurrentPC(cpuId);</p>
<p class="p_Normal"> &nbsp; &nbsp;ext.mm_stat = buildMMStatus();</p>
<p class="p_Normal"> &nbsp; &nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;enterPALVector(cpuId, PalVectorId::DFAULT);</p>
<p class="p_Normal">}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>
<h3 class="p_Heading3" style="page-break-after: avoid;"><span class="f_Heading3">Template 3: Interrupt Poll</span></h3>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">bool checkForInterrupts(CPUIdType cpuId) {</p>
<p class="p_Normal"> &nbsp; &nbsp;auto&amp; hot = globalIPRHot64(cpuId);</p>
<p class="p_Normal"> &nbsp; &nbsp;auto&amp; cbox = globalIPRCBox(cpuId);</p>
<p class="p_Normal"> &nbsp; &nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;// CBox is separate cache line - no bouncing</p>
<p class="p_Normal"> &nbsp; &nbsp;if (cbox.hasIRQPending()) {</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;quint8 irqIPL = cbox.getPendingIPL();</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;quint8 currentIPL = hot.getIPL();</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;if (irqIPL &gt; currentIPL) {</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;deliverInterrupt(cpuId, irqIPL);</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return true;</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal"> &nbsp; &nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;return false;</p>
<p class="p_Normal">}</p>
<p class="p_Normal">&nbsp;</p>
<h3 class="p_Heading3" style="page-break-after: avoid;"><span class="f_Heading3">&nbsp;</span></h3>
<h3 class="p_Heading3" style="page-break-after: avoid;"><span class="f_Heading3">Template 4: IRQ Controller (Cross-Thread)</span></h3>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">// IRQController thread posts interrupt</p>
<p class="p_Normal">void IRQController::postInterrupt(CPUIdType cpuId, quint8 ipl, quint8 vector) {</p>
<p class="p_Normal"> &nbsp; &nbsp;// Write to isolated CBox mailbox (no CPU cache line contamination)</p>
<p class="p_Normal"> &nbsp; &nbsp;auto&amp; cbox = globalIPRCBox(cpuId);</p>
<p class="p_Normal"> &nbsp; &nbsp;cbox.postIRQ(ipl, vector);</p>
<p class="p_Normal">}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">// CPU thread drains mailbox</p>
<p class="p_Normal">void CPUThread::pollInterrupts() {</p>
<p class="p_Normal"> &nbsp; &nbsp;auto&amp; hot = globalIPRHot64(m_cpuId);</p>
<p class="p_Normal"> &nbsp; &nbsp;auto&amp; cbox = globalIPRCBox(m_cpuId);</p>
<p class="p_Normal"> &nbsp; &nbsp;</p>
<p class="p_Normal"> &nbsp; &nbsp;if (cbox.hasIRQPending() &amp;&amp; cbox.getPendingIPL() &gt; hot.getIPL()) {</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;quint8 vector = cbox.getPendingVector();</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;handleInterrupt(vector);</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp;cbox.clearIRQ(cbox.getPendingIPL());</p>
<p class="p_Normal"> &nbsp; &nbsp;}</p>
<p class="p_Normal">}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">---</p>
<p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">Compile-Time Checks</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span style="font-weight: bold;">Add to your code:</span></p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">// Verify cache line constraints</p>
<p class="p_Normal">static_assert(sizeof(IPRStorage_Hot64) == 64,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&quot;Hot64 must be exactly 64 bytes&quot;);</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">static_assert(alignof(IPRStorage_Hot64) == 64,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&quot;Hot64 must be 64-byte aligned&quot;);</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">static_assert(sizeof(PerCpuIPRState) % 64 == 0,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&quot;PerCpuIPRState must not allow false sharing&quot;);</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">static_assert(alignof(PerCpuIPRState) == 64,</p>
<p class="p_Normal"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&quot;PerCpuIPRState must be cache-aligned&quot;);</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">Performance Expectations</span></h2>
<p class="p_Normal">&nbsp;</p>
<div style="text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;"><table style="border:none; border-spacing:0; border-collapse:collapse;">
<thead>
<tr>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Metric</span></p>
</th>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Before</span></p>
</th>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">After</span></p>
</th>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Improvement</span></p>
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">L1 misses (hot loop)</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">3-5 per iter</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">1 per iter</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">60-80% ↓</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Cache line bounces</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Frequent</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Zero</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">100% ↓</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Exception latency</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">10-15 L1 misses</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">2-3 L2 hits</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">50% ↓</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Overall speedup</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Baseline</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">+10-30%</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Expected</p>
</td>
</tr>
</tbody>
</table>
</div>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">Common Mistakes to Avoid</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">❌ **DON'T: Call accessor functions repeatedly in loops**</p>
<p class="p_Normal">```cpp</p>
<p class="p_Normal">for (int i = 0; i &lt; N; ++i) {</p>
<p class="p_Normal"> &nbsp; &nbsp;if (globalIPRHot64(cpuId).getIPL() &gt; X) { } &nbsp;// ❌ Function call overhead</p>
<p class="p_Normal">}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">✅ **DO: Bind reference once**</p>
<p class="p_Normal">auto&amp; hot = globalIPRHot64(cpuId); &nbsp;// ✅ Bind once</p>
<p class="p_Normal">for (int i = 0; i &lt; N; ++i) {</p>
<p class="p_Normal"> &nbsp; &nbsp;if (hot.getIPL() &gt; X) { } &nbsp;// ✅ Direct access</p>
<p class="p_Normal">}</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">❌ **DON'T: Put arrays in Hot64**</p>
<p class="p_Normal">struct IPRStorage_Hot64 {</p>
<p class="p_Normal"> &nbsp; &nbsp;quint64 pal_temp[32]; &nbsp;// ❌ Way too big!</p>
<p class="p_Normal">};</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">✅ **DO: Put arrays in HotExt or Warm**</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">struct IPRStorage_HotExt {</p>
<p class="p_Normal"> &nbsp; &nbsp;quint64 pal_temp[32]; &nbsp;// ✅ In L2, not L1</p>
<p class="p_Normal">};</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">❌ **DON'T: Mix CPU-thread and IRQ-thread writes**</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">// IRQController writes hot.irq_pending</p>
<p class="p_Normal">// CPU thread reads hot.ipl</p>
<p class="p_Normal">// ❌ Both in same cache line = bouncing!</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">✅ **DO: Use separate CBox mailbox**</p>
<p class="p_Normal">```cpp</p>
<p class="p_Normal">// IRQController writes cbox.irq_pending</p>
<p class="p_Normal">// CPU thread reads hot.ipl</p>
<p class="p_Normal">// ✅ Separate cache lines = no bouncing!</p>
<p class="p_Normal">```</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">---</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">## Debugging Tips</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">**Print IPR layout:**</p>
<p class="p_Normal">```cpp</p>
<p class="p_Normal">qDebug() &lt;&lt; &quot;Hot64:&quot; &lt;&lt; sizeof(IPRStorage_Hot64);</p>
<p class="p_Normal">qDebug() &lt;&lt; &quot;HotExt:&quot; &lt;&lt; sizeof(IPRStorage_HotExt);</p>
<p class="p_Normal">qDebug() &lt;&lt; &quot;PerCpu:&quot; &lt;&lt; sizeof(PerCpuIPRState);</p>
<p class="p_Normal">qDebug() &lt;&lt; &quot;CPU0 addr:&quot; &lt;&lt; (void*)&amp;globalIPRState(0);</p>
<p class="p_Normal">qDebug() &lt;&lt; &quot;CPU1 addr:&quot; &lt;&lt; (void*)&amp;globalIPRState(1);</p>
<p class="p_Normal">qDebug() &lt;&lt; &quot;Offset:&quot; &lt;&lt; ((char*)&amp;globalIPRState(1) - (char*)&amp;globalIPRState(0));</p>
<p class="p_Normal">```</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">**Expected output:**</p>
<p class="p_Normal">```</p>
<p class="p_Normal">Hot64: 64</p>
<p class="p_Normal">HotExt: 512</p>
<p class="p_Normal">PerCpu: 1024 (or higher, must be multiple of 64)</p>
<p class="p_Normal">CPU0 addr: 0x12345000</p>
<p class="p_Normal">CPU1 addr: 0x12345400 (offset = 1024 = 16 cache lines)</p>
<p class="p_Normal">Offset: 1024</p>
<p class="p_Normal">```</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">**Verify alignment:**</p>
<p class="p_Normal">```cpp</p>
<p class="p_Normal">Q_ASSERT((quint64)&amp;globalIPRState(cpuId) % 64 == 0);</p>
<p class="p_Normal">Q_ASSERT(sizeof(PerCpuIPRState) % 64 == 0);</p>
<p class="p_Normal">```</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">---</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">## Files Summary</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">| File | Purpose | When to Use |</p>
<p class="p_Normal">|------|---------|-------------|</p>
<p class="p_Normal">| `IPRStorage_Hot64.h` | L1 cache bank | Every instruction |</p>
<p class="p_Normal">| `IPRStorage_HotExt.h` | L2 cache bank | Exception/PAL |</p>
<p class="p_Normal">| `IPRStorage_CBox.h` | Cross-thread mailbox | IRQ poll |</p>
<p class="p_Normal">| `IPRStorage_Cold.h` | Rare access | Diagnostics |</p>
<p class="p_Normal">| `PerCpuIPRState.h` | Composite | Container |</p>
<p class="p_Normal">| `IPRStorage_Core_New.h` | Backward compat | Migration |</p>
<p class="p_Normal">| `globalIPR_hot_cold_new.h` | Accessors | All code |</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">---</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">## One-Page Summary</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">**Goal:** Optimize IPR access for host CPU cache hierarchy</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">**Solution:** Split monolithic Hot into cache-tiered banks:</p>
<p class="p_Normal">- Hot64 (64B, L1): Every instruction</p>
<p class="p_Normal">- HotExt (512B, L2): Exception/PAL</p>
<p class="p_Normal">- CBox (64B, isolated): Cross-thread IRQs</p>
<p class="p_Normal">- Cold (variable, L3): Rare</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">**Benefits:**</p>
<p class="p_Normal">- 60-80% fewer L1 misses</p>
<p class="p_Normal">- Zero cache line bouncing</p>
<p class="p_Normal">- 10-30% overall speedup</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">**Migration:**</p>
<p class="p_Normal">- Backward compatible</p>
<p class="p_Normal">- Gradual migration</p>
<p class="p_Normal">- No breaking changes</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">**Key insight:** Don't chase &quot;everything in one cache line&quot; - instead, match access temperature to cache tier!</p>

<!--ZOOMSTOP-->
</div></div>
<script type="text/javascript">



function normHeaders() {
 var topicHeadHeight =  $("#idheaderbg > table").first().height() + 1,
	 $topicHeaderBox = $("#idheader"),
	 $topicContentBox = $("#idcontent"),
	 $navHeader = $("#navbar", parent.document),			 
	$navBox = $("div#hmnavframe", parent.document),
	 navHeaderHeight = $navHeader.height();
 if (topicHeadHeight != navHeaderHeight) {
	 $navHeader.css("height",topicHeadHeight + "px");
	 $navBox.css("top", topicHeadHeight + "px");
	 $topicHeaderBox.css("height", topicHeadHeight + "px");
		if ($topicHeaderBox.css("position") == "fixed"){
			$topicContentBox.css("margin-top", topicHeadHeight + "px");
			}
		}
    }
			 
  $(document).ready(function(){
    $(window).on('resize', function() {
      var y = $('#idheader').height(); 
      $('#idcontent').css('margin-top', y);
      var par = window.parent;
      if ($( par ).width() <= $( window ).width()+20) {
        $('#idheader').css('position', 'relative');
        $('#idcontent').css('margin-top', 0);
        $('#idbacktotop').css('display', 'block');
        $('.hmanchor').css('margin-top', -20);
	$('.hmanchor').css('padding-top', 20);
      }
      else {
        $('#idheader').css('position', 'fixed');
        $('#idcontent').css('margin-top', $('#idheader').height());
        $('#idbacktotop').css('display', 'none');
        $('.hmanchor').css('margin-top', -y-20);
		$('.hmanchor').css('padding-top', y+20);
		$("div#hmsplitter", parent.document).css('width', '3px');
      }
	normHeaders();
    });
    
	 $(window).resize(); //trigger event for initially small displays
  });
 

if ((!parent.hmNavigationFrame) && (parent.location) && (parent.location.href)) { $('.sync-toc').show();$('p.crumbs').hide();}

</script>
</body>
</html>
