<!DOCTYPE html>
<html>
<head>
   <title>Introduction &gt; Architecture Overview &gt; Chapter 19 – Interrupt Architecture &amp; IPI &gt; 19.2 IRQPendingState Implementation</title>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />   
   <meta http-equiv="X-UA-Compatible" content="IE=edge" />
   <meta name="generator" content="Help &amp; Manual" />
   <meta name="keywords" content="" />
   <meta name="description" content="19.2.1 Per-CPU Tracking Structure &nbsp;IRQPendingState (coreLib/IRQPendingState.h, ~378 lines) is the per-CPU interrupt tracking structure. It is the central data structure through..." />
   <link type="text/css" href="default.css" rel="stylesheet" />
   <link type="text/css" href="custom.css" rel="stylesheet" />

   <style TYPE="text/css" media="screen"> 
      html, body { margin:0; 
        padding:0; 
        background: #ffffff; 
      } 
      div#printheader { display: none; }
      #idheader { 
        width:100%; 
        height:auto; 
        padding: 0; 
        margin: 0;
        position: fixed;
        top: 0;
        z-index: 2;
      } 
      /* The "min-height" for "#idheader table" ensures that the (blue) header of the topic
         has at least the same height as the header of the navigation panel left of it */
      #idheader table { background: #2C5D88; min-height: 59px }             
      #idheader h1 { color: #FFF }     
      #idnav {
        text-align: right;
        width: 126px;
        vertical-align: middle;        
      } 
      #idnav a { text-decoration: none }
      #idnav span {
        display: inline-block;
        width: 24px;
        height: 24px;
        margin-left: 4px;
        background:url('hm_webhelp_buttons_grey.png') top left no-repeat;
      } 
      #idnav a span {
        background-image:url('hm_webhelp_buttons_white.png');
      } 
      #idnav a span:hover {
        background-image:url('hm_webhelp_buttons_orange.png');
      } 
      #idnav span.hmbtnprev { background-position: 0 -32px }
      #idnav span.hmbtnnext { background-position: -24px -32px }
      #idnav span.hmbtntop  { background-position: -48px -32px }
      #idnav span.hmbtntoggle  { width: 20px; background-position: -70px -32px }
      #idnav span.hmbtnprint  { background-position: -88px -32px }

      #callout-table, #overview-table {display:block; position:relative; top:0; left:0;}
      #callout-icon {display:block; position:absolute; top:-11px; left:-11px;}
      #callout-icon-flag {display:block; position:absolute; top:-11px; left:-8px;}
      #callout-table a {text-decoration: none; color: blue;}
      #callout-table a:visited {text-decoration: none; color: blue;}
      #overview-table a {text-decoration: none; color: black;}
      #overview-table a:visited {text-decoration: none; color: black;}
      #callout-table a:hover, #overview-table a:hover {text-decoration: underline;}       
      p.help-url { margin: 20px 0 5px 0; text-align: center; font-size: 80%; text-decoration: none }      
      #switchtoggles { text-align: right; padding: 0 2px 0 0; font-size: 90%; } 
      .sync-toc { color: #FFF; font-size: 8pt; font-weight: bold; display: none; }
      .sync-toc a { color: #FFF; text-decoration: none; font-weight: bold;}
      .sync-toc a:visited { color: #FFF; }
      .sync-toc a:hover { text-decoration: underline; }
      a.hmanchor { display: inline-block; margin-top: -4em; padding-top: 4em }	  
   </style>
   <style TYPE="text/css" media="print">
      div#idheader, img.dropdown-toggle-icon, p.help-url { display:none } 
   </style>
   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>

   <script type="text/javascript">
     HMSyncTOC("index.html", "19_2-irqpendingstate-implement.html");
   </script>
   <script type="text/javascript" src="highlight.js"></script>
   <script type="text/javascript">
     $(document).ready(function(){highlight();});
   </script>
</head>
<body>


<div id="printheader"><h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">19.2 IRQPendingState Implementation</span></h1>
</div>
<div id="idheader">
<div id="idheaderbg">
<table style="width:100%;border:none;margin:0px;" cellspacing="0" cellpadding="0"> 
  <tr>
    <td class="topichead" style="text-align:left; vertical-align:bottom">
      <p class="sync-toc">&lt;&lt; <a rel="nofollow" href="index.html?19_2-irqpendingstate-implement.html" target="_top">Click to Display Table of Contents</a> &gt;&gt;</p>
      <p class="crumbs"><b>Navigation:</b>&nbsp;
      
      <a href="introduction.html">Introduction</a> &gt; <a href="architecture-overview.html">Architecture Overview</a> &gt; <a href="chapter-19---debugging_-tracin.html">Chapter 19 – Interrupt Architecture &amp; IPI</a>&nbsp;&gt;</p>
   
      <h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">19.2 IRQPendingState Implementation</span></h1>

    </td>
    <td class="topichead" id="idnav">
      
      <a href="19_1-interrupt-sources.html" title="Previous Topic"><span class="hmbtnprev"></span></a>
      <a href="chapter-19---debugging_-tracin.html" title="Parent Chapter"><span class="hmbtntop"></span></a>
      <a href="19_3-interrupt-routing.html" title="Next Topic"><span class="hmbtnnext"></span></a>
      
    </td>
  </tr>  
</table>
</div>
</div>  

<div id="idcontent"><div id="innerdiv">
<!-- Ask Internet Explorer 6.users to update their obsolete and dangerous browser --> 
<!--[if lt IE 7]><div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;'><a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." /></a></div><![endif]-->

<!--ZOOMRESTART-->
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">19.2.1 Per-CPU Tracking Structure</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span class="f_CodeExample">IRQPendingState</span> (<span class="f_CodeExample">coreLib/IRQPendingState.h</span>, ~378 lines) is the per-CPU interrupt tracking structure. It is the central data structure through which all interrupt sources (devices, software, IPIs) communicate pending interrupts to the CPU. Its design is driven by the cross-thread safety requirement: device I/O threads may assert interrupts at any time while the CPU thread checks for deliverable interrupts every cycle.</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">19.2.2 Data Structures</span></h2>
<p class="p_Normal">&nbsp;</p>
<div style="text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;"><table style="border:none; border-spacing:0; border-collapse:collapse;">
<thead>
<tr>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Field</span></p>
</th>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Purpose</span></p>
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal"><span class="f_CodeExample">pendingLevelsMask</span> (<span class="f_CodeExample">atomic&lt;quint32&gt;</span>)</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Summary bitset: bit L set means at least one pending source at IPL L. Provides a single fast check for &quot;what needs attention.&quot;</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal"><span class="f_CodeExample">pendingSourcesByLevel</span> (array of <span class="f_CodeExample">atomic&lt;quint64&gt;</span>)</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Per-level source bitmask — up to 64 interrupt sources per level. Identifies which specific device or source triggered the interrupt.</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal"><span class="f_CodeExample">highestPendingLevel</span> (<span class="f_CodeExample">atomic&lt;quint8&gt;</span>)</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">Cached highest pending IPL for ultra-fast per-instruction checking. 0xFF means &quot;nothing pending.&quot; Updated atomically by raise/clear/claim operations.</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal"><span class="f_CodeExample">inServiceMask</span></p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">CPU-thread-only mask tracking claimed (in-service) level-triggered interrupts. Not atomic — only accessed by the owning CPU thread.</p>
</td>
</tr>
</tbody>
</table>
</div>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">Additionally, per-source static configuration records the trigger mode (edge or level), SCB vector index, and IPL assignment for each interrupt source.</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">19.2.3 Hot-Path Operations</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">The interrupt check is the second-hottest path in the emulator (after <span class="f_CodeExample">FaultDispatcher::eventPending()</span>). The key operations:</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span class="f_CodeExample">hasDeliverable(currentIPL)</span> — tests whether any pending interrupt level exceeds the current IPL. Implementation: single atomic load of <span class="f_CodeExample">highestPendingLevel</span> and comparison against <span class="f_CodeExample">currentIPL</span>. Cost: ~5 cycles (one atomic load, one compare). Returns immediately if nothing pending (0xFF).</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span class="f_CodeExample">claimNext()</span> — atomically claims the highest-priority pending interrupt and returns a <span class="f_CodeExample">ClaimedInterrupt</span> containing the source, IPL, and vector. For level-triggered interrupts, the source is added to <span class="f_CodeExample">inServiceMask</span>. For edge-triggered interrupts, the pending bit is cleared atomically.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span class="f_CodeExample">raiseInterrupt(sourceId, ipl)</span> — called by device threads to assert an interrupt. Sets the source bit in <span class="f_CodeExample">pendingSourcesByLevel[ipl]</span>, sets the level bit in <span class="f_CodeExample">pendingLevelsMask</span>, and updates <span class="f_CodeExample">highestPendingLevel</span> if the new level is higher. All operations use <span class="f_CodeExample">memory_order_release</span> to ensure device-side data is visible to the CPU thread.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span class="f_CodeExample">clearInterrupt(sourceId, ipl)</span> — called when a device deasserts its interrupt line. Clears the source bit; if no sources remain at that level, clears the level bit and recalculates <span class="f_CodeExample">highestPendingLevel</span>.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_SeeAlso" style="page-break-after: avoid;"><span class="f_SeeAlso">See Also: coreLib/IRQPendingState.h (~378 lines); <a href="chapter-7_9-interrupt-handling.html" class="topiclink">7.10 Interrupt Handling</a>.</span></p>

<!--ZOOMSTOP-->
</div></div>
<script type="text/javascript">

  

  $(document).ready(function(){
    $(window).bind('resize', function() {
      var y = $('#idheader').height(); 
      $('#idcontent').css('margin-top', y);
      var par = window.parent;
      if ($( par ).width() <= $( window ).width()+20) {
        $('#idheader').css('position', 'relative');
        $('#idcontent').css('margin-top', 0);
        $('#idbacktotop').css('display', 'block');
        $('.hmanchor').css('margin-top', -20);
	$('.hmanchor').css('padding-top', 20);
      }
      else {
        $('#idheader').css('position', 'fixed');
        $('#idcontent').css('margin-top', $('#idheader').height());
        $('#idbacktotop').css('display', 'none');
        $('.hmanchor').css('margin-top', -y-20);
	$('.hmanchor').css('padding-top', y+20);
      }
    });
    
    $(window).resize(); //trigger event for initially small displays
  });

if ((!parent.hmNavigationFrame) && (parent.location) && (parent.location.href)) { $('.sync-toc').show();$('p.crumbs').hide();}

</script>
</body>
</html>
