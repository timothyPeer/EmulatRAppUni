<!DOCTYPE html>
<html>
<head>
   <title>ASA-EMulatR Reference Guide &gt; Introduction &gt; Architecture Overview &gt; Chapter 13 – AlphaPipeline Implementation &gt; 13.10 Exception Precision</title>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />   
   <meta http-equiv="X-UA-Compatible" content="IE=edge" />
   <meta name="generator" content="Help &amp; Manual" />
   <meta name="keywords" content="AlphaCPU,Architectural,BoxResult,Commit,Delivery,Detection,Discard,enterPal,EX,EXC_ADDR,Exception,Fault,faultDispatched,faultPC,faultPending,faultVA,flushYoungerSlots,Invariant,LLSC,m_pending,MEM,PAL,PendingCommit,Pipeline,PipelineAction,Precise,Precision,Reservation,SafeMemory,slotSequence,stage_EX,stage_WB,Store,Synchronous,trapCode,WB" />
   <meta name="description" content="13.10.1 Detect Early, Deliver Late &nbsp;Exceptions are detected early (in EX) but delivered late (in WB). When a fault is detected in stage_EX(), slot.faultPending is set to true..." />
   <link type="text/css" href="default.css" rel="stylesheet" />
   <link type="text/css" href="custom.css" rel="stylesheet" />

   <style TYPE="text/css" media="screen"> 
      html, body { margin:0; 
        padding:0; 
        background: #ffffff; 
      } 
      div#printheader { display: none; }
      #idheader { 
        width:100%; 
        min-height: 60px; 
        padding: 0; 
        margin: 0;
        position: fixed;
        top: 0;
        background: #2C5D88;
        z-index: 2;
      } 
      /* The "min-height" for "#idheader table" ensures that the (blue) header of the topic
         has at least the same height as the header of the navigation panel left of it */
      #idheader table { min-height: 59px;}             
      #idheader h1 span { color: #FFF }     
      #idnav {
        text-align: right;
        width: 158px;
        vertical-align: middle;        
      } 
      #idnav a { text-decoration: none }
      #idnav span {
        display: inline-block;
        width: 24px;
        height: 24px;
        margin-left: 4px;
        background:url('hm_webhelp_buttons_grey.png') top left no-repeat;
      } 
      #idnav a span {
        background-image:url('hm_webhelp_buttons_white.png');
      } 
      #idnav a span:hover {
        background-image:url('hm_webhelp_buttons_orange.png');
      } 
      #idnav span.hmbtnprev { background-position: 0 -32px }
      #idnav span.hmbtnnext { background-position: -24px -32px }
      #idnav span.hmbtntop  { background-position: -48px -32px }
      #idnav span.hmbtntoggle  { width: 20px; background-position: -70px -32px }
      #idnav span.hmbtnprint  { background-position: -88px -32px }

      #callout-table, #overview-table {display:block; position:relative; top:0; left:0;}
      #callout-icon {display:block; position:absolute; top:-11px; left:-11px;}
      #callout-icon-flag {display:block; position:absolute; top:-11px; left:-8px;}
      #callout-table a {text-decoration: none; color: blue;}
      #callout-table a:visited {text-decoration: none; color: blue;}
      #overview-table a {text-decoration: none; color: black;}
      #overview-table a:visited {text-decoration: none; color: black;}
      #callout-table a:hover, #overview-table a:hover {text-decoration: underline;}       
      p.help-url { margin: 20px 0 5px 0; text-align: center; }
	  p.help-url a:link { font-size: 50%; text-decoration: none; color: black; }
	  p.help-url a:visited { color: black; }
	  p.help-url a:hover { font-size: 95%; text-decoration: underline; }
      #switchtoggles { text-align: right; padding: 0 2px 0 0; font-size: 90%; } 
      .sync-toc { color: #FFF; font-size: 8pt; font-weight: bold; display: none; }
      .sync-toc a { color: #FFF; text-decoration: none; font-weight: bold;}
      .sync-toc a:visited { color: #FFF; }
      .sync-toc a:hover { text-decoration: underline; }
	  a#printbuttonlink { cursor: pointer; }
      a.hmanchor { display: inline-block; margin-top: -4em; padding-top: 4em; }  
   </style>
   <style TYPE="text/css" media="print">
      div#idheader, img.dropdown-toggle-icon, p.help-url { display:none } 
   </style>
   
   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>

   <script type="text/javascript">
     HMSyncTOC("index.html", "13_10-exception-precision.html");
   </script>
   <script type="text/javascript" src="highlight.js"></script>
   <script type="text/javascript">
     $(document).ready(function(){highlight();});
   </script>
</head>
<body>


<div id="printheader"><h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">13.10 Exception Precision</span></h1>
</div>
<div id="idheader">
<div id="idheaderbg">
<table style="width:100%;border:none;margin:0px;" cellspacing="0" cellpadding="0"> 
  <tr>
    <td class="topichead" style="text-align:left; vertical-align:middle">
      <p class="sync-toc">&lt;&lt; <a rel="nofollow" href="index.html?13_10-exception-precision.html" target="_top">Click to Display Table of Contents</a> &gt;&gt;</p>
      <p class="crumbs"><b>Navigation:</b>&nbsp;
      
      <a href="license-_-attributions.html">ASA-EMulatR Reference Guide</a> &gt; <a href="introduction.html">Introduction</a> &gt; <a href="architecture-overview.html">Architecture Overview</a> &gt; <a href="alphapipeline-implementation.html">Chapter 13 – AlphaPipeline Implementation</a>&nbsp;&gt;</p>
   
      <h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">13.10 Exception Precision</span></h1>

    </td>
    <td class="topichead" id="idnav">
      
      <a href="13_9-serialization-and-barrier.html" title="Previous Topic"><span class="hmbtnprev"></span></a>
      <a href="alphapipeline-implementation.html" title="Parent Chapter"><span class="hmbtntop"></span></a>
      <a href="13_11-branch-handling.html" title="Next Topic"><span class="hmbtnnext"></span></a>
      <a id="printbuttonlink" onclick=";$('div#idcontent').css('margin-top', '1em');printTopic();$('#idcontent').css('margin-top', $('#idheader').height());" title="Print"><span class="hmbtnprint"></span></a>
    </td>
  </tr>  
</table>
</div>
</div>  

<div id="idcontent"><div id="innerdiv">
<!-- Ask Internet Explorer 6.users to update their obsolete and dangerous browser --> 
<!--[if lt IE 7]><div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;'><a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." /></a></div><![endif]-->

<!--ZOOMRESTART-->
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">13.10.1 Detect Early, Deliver Late</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">Exceptions are detected early (in EX) but delivered late (in WB). When a fault is detected in stage_EX(), slot.faultPending is set to true with the trapCode and faultVA. The instruction continues flowing through MEM (where its pending commit is preserved but may be discarded). When the faulting instruction reaches stage_WB(), the fault check fires first — before any store commit or retirement.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span style="font-weight: bold;">Why not deliver immediately in EX?</span> Because older instructions in MEM and WB must complete first. Delivering in WB guarantees that the faulting instruction is the oldest incomplete instruction — all prior instructions have already retired.</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">13.10.2 Fault Delivery in stage_WB()</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">On fault in stage_WB: the m_pending (from a younger instruction in MEM) is discarded (PendingCommit{}), PipelineAction::FAULT is set with trapCode/faultVA/faultPC, and the slot is invalidated. The fault propagates to AlphaCPU via BoxResult::faultDispatched(), which triggers enterPal() with EXC_ADDR set to the faulting instruction's PC.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">flushYoungerSlots() clears all instructions younger than the faulting instruction — preserving older instructions that have already committed. This guarantees precise exceptions: all prior instructions completed, no later instruction modified architectural state.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span style="font-weight: bold;">Fault precedence:</span> If multiple slots have faultPending set simultaneously, slotSequence (the monotonic age counter) determines which fault is architecturally first. Only the oldest faulting instruction's exception is delivered; younger faulting instructions are discarded by flushYoungerSlots().</p>
<p class="p_Normal">&nbsp;</p>
<hr style="height:1px; color:#000000; border-width:0; background-color:#000000;" /><p class="p_Normal">&nbsp;</p>
<h2 class="p_Heading2" style="page-break-after: avoid;"><span class="f_Heading2">13.10.3 Precision Invariants</span></h2>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">The following invariants hold for every exception delivery and are verified by the testing framework (Chapter 22):</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span style="font-weight: bold;">No younger instruction commits.</span> flushYoungerSlots() is called before the fault propagates. Any younger instruction that reached MEM has its PendingCommit discarded — its register write never takes effect.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span style="font-weight: bold;">All prior instructions completed.</span> Because WB processes in age order (oldest first, guaranteed by in-order retirement), every instruction older than the faulting instruction has already retired before the fault check executes.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span style="font-weight: bold;">Faulting stores never reach SafeMemory.</span> Stores commit in stage_WB() after the fault check. Since the fault check fires first and returns immediately, the store commit path is never reached for a faulting instruction.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span style="font-weight: bold;">Faulting loads never write the result register.</span> Load results sit in slot.payLoad and m_pending until commitPending() in stage_MEM(). If the load faulted, the pending commit is discarded in stage_WB() before the next MEM cycle could commit a younger instruction's result.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span style="font-weight: bold;">LL/SC reservations cleared on delivery.</span> Exception delivery clears all LL/SC reservations for the faulting CPU, ensuring no stale reservation survives across a fault boundary.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_SeeAlso" style="page-break-after: avoid;"><span class="f_SeeAlso">See Also: <a href="11_2-execution-and-pipeline-in.html" class="topiclink">11.2 Execution and Pipeline Invariants</a> ; <a href="chapter-18---fault-dispatcher-.html" class="topiclink">Chapter 18 – Fault Dispatcher &amp; Precise Exceptions</a> ; <a href="chapter-22---testing_-validati.html" class="topiclink">Chapter 22 – Testing, Validation, and Architectural Compliance</a> (exception precision verification).</span></p>

<!--ZOOMSTOP-->
</div></div>
<script type="text/javascript">

  function printTopic() {
    if (document.queryCommandSupported('print')) { document.execCommand('print', false, null); }
    else { window.print(); }
  }



function normHeaders() {
 var topicHeadHeight =  $("#idheaderbg > table").first().height() + 1,
	 $topicHeaderBox = $("#idheader"),
	 $topicContentBox = $("#idcontent"),
	 $navHeader = $("#navbar", parent.document),			 
	$navBox = $("div#hmnavframe", parent.document),
	 navHeaderHeight = $navHeader.height();
 if (topicHeadHeight != navHeaderHeight) {
	 $navHeader.css("height",topicHeadHeight + "px");
	 $navBox.css("top", topicHeadHeight + "px");
	 $topicHeaderBox.css("height", topicHeadHeight + "px");
		if ($topicHeaderBox.css("position") == "fixed"){
			$topicContentBox.css("margin-top", topicHeadHeight + "px");
			}
		}
    }
			 
  $(document).ready(function(){
    $(window).on('resize', function() {
      var y = $('#idheader').height(); 
      $('#idcontent').css('margin-top', y);
      var par = window.parent;
      if ($( par ).width() <= $( window ).width()+20) {
        $('#idheader').css('position', 'relative');
        $('#idcontent').css('margin-top', 0);
        $('#idbacktotop').css('display', 'block');
        $('.hmanchor').css('margin-top', -20);
	$('.hmanchor').css('padding-top', 20);
      }
      else {
        $('#idheader').css('position', 'fixed');
        $('#idcontent').css('margin-top', $('#idheader').height());
        $('#idbacktotop').css('display', 'none');
        $('.hmanchor').css('margin-top', -y-20);
		$('.hmanchor').css('padding-top', y+20);
		$("div#hmsplitter", parent.document).css('width', '3px');
      }
	normHeaders();
    });
    
    //Hide Print button on touch devices
    if (hmBrowser.nonDeskTouch) {
      $("a#printbuttonlink").hide();
      $("#idnav").css({"width": "125px", "padding-left": "0", "padding-right": "2px"});
    }
	 $(window).resize(); //trigger event for initially small displays
  });
 

if ((!parent.hmNavigationFrame) && (parent.location) && (parent.location.href)) { $('.sync-toc').show();$('p.crumbs').hide();}
var baseurl = document.URL.substring(0,document.URL.lastIndexOf("/")+1); 
$('#idcontent').append('<p class="help-url"><b>URL of this topic:<br /></b><a href="'+baseurl+'index.html' +
'?13_10-exception-precision.html" target="_top">'+baseurl+'index.html?13_10-exception-precision.html</a></p>');

</script>
</body>
</html>
